{{# Pivot (in many places) based on whether the user is an editor (curator) or
# someone else looking at the study
#
# userCanEdit = True if the user is authorized to edit this study
# viewOrEdit  = the function of this page ('EDIT' or 'VIEW'), regardless of
#               user's permissions

response.title = (viewOrEdit == 'EDIT') and "Edit Study" or "View Study"
}}

{{left_sidebar_enabled,right_sidebar_enabled=False,False}}
{{response.subtitle = "loading study %s..." % request.args[0]}}

{{### Add support scripts for single-page editor 

# JSON support for older browsers (esp. IE7) 
response.files.append(URL('static','js/json2.js'))

# Knockout.js for binding JSON model to editing UI 
response.files.append(URL('static','js/knockout-2.3.0.js'))

# KO plugin for paginated lists
response.files.append(URL('static','js/knockout-paged-e4a5770702.js'))

# Knockout bindings for Twitter Bootstrap components
response.files.append(URL('static','js/knockout-bootstrap.min.js'))

# jQuery-File-Upload plugin and supporting files (TODO)
# minimal support for $.widget()
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/vendor/jquery.ui.widget.js'))
# Iframe Transport is required for browsers without support for XHR file uploads
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/jquery.iframe-transport.js'))
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/jquery.fileupload.js'))
response.files.append(URL('static','jQuery-File-Upload-9.5.2/css/jquery.fileupload.css'))

# minimal Bootstrap Tags Input (jQuery plugin)
response.files.append(URL('static','js/bootstrap-tagsinput.min.js'))
response.files.append(URL('static','css/bootstrap-tagsinput.css'))

# D3 for tree viewer/editor
response.files.append(URL('static','js/d3.v3.min.js'))

# Phylogram "plugin" for D3
response.files.append(URL('static','js/d3.phylogram.js'))
}}

{{extend 'layout.html'}}

<a class="main-title-DOI" style="display: none; position: relative; top: -4px;" href="#" target="_blank">{DOI}</a>

<div class="header-quality-panel" style="margin-bottom: 8px; overflow: hidden;">
    <div style="float: left;">
        Study quality &nbsp;
    </div>

    <div style="float: right;">
        &nbsp; 
        <strong><span data-bind="text: studyQualityPercent"></span>%</strong>
        <a id="quality-details-toggle" onclick="showQualityDetailsPopup(); return false;" href="#">(show details)</a>
    </div>

    <div data-bind="css: studyQualityBarClass" style="height: 0.5em; margin: 0.5em 0 0;">
      <div class="bar" data-bind="style: { width: studyQualityPercentStyle }">&nbsp;</div>
    </div>
</div>

<style type="text/css">
body {
    overflow-y: scroll;
}

/* D3 tree view */

.node circle {
  fill: steelblue;
}
.node circle:hover {
  stroke-opacity: 0.5;
}
.node.leaf circle {
  fill: #777;
}
/* preferred ot:specifiedRoot */
.node.specifiedRoot circle {
  fill: steelblue;
}
.node.specifiedRoot text {
  fill: steelblue;
  font-size: 1.3em;
}
/* even more preferred ot:specifiedRoot */
.node.inGroupClade circle {
  fill: black;
}
.node.inGroupClade text {
  fill: black;
  font-size: 1.3em;
}

.node {
  font: 10px sans-serif;
}

.dropdown-menu > li.node-information {
    padding: 3px 20px;
    clear: both;
    font-weight: normal;
    line-height: 20px;
    color: #333333;
    white-space: nowrap;
    /* border-bottom: 1px solid #ddd; */
}
.dropdown-menu > li.node-information .node-name {
    font-weight: bold;
    color: #000;
    padding-right: 1em;
}
.dropdown-menu > li.node-information .node-type {
    float: right;
    text-align: right;
    color: #888;
}
.dropdown-menu > li.node-information .node-type.inGroupClade {
    color: steelblue;
}
.dropdown-menu > li.node-information .node-type.specifiedRoot {
    color: steelblue;
}
.dropdown-menu > li.node-information .node-label-type {
    color: #888;
    font-style: italic;
    font-size: 0.85em;
    line-height: 1.2em;
}

.link-trigger {
  fill: none;
  stroke: red;
  stroke-width: 6.0px;
  stroke-opacity: 0;
}
.link-trigger:hover {
  stroke-opacity: 0.5;
}

.link {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.0px;
}
.link.outgroup {
  stroke: steelblue;
  stroke-width: 0.75px;
}
.link.ingroup {
  stroke: #000;
  stroke-width: 1.25px;
}
.link.update {
  /* stroke: #ccf; */
}
.link.enter {
  /* stroke: #f00; */
}

/* force proper styles for Bootstrap Tags Input */
.bootstrap-tagsinput input {
    border: none !important;
    background-color: transparent !important;
    padding: 0 !important;
    -webkit-box-shadow: none !important;
    box-shadow: none !important;
}

</style>

<div class="row">
 <div class="span12">
  <div class="tabbable tabs">
    <ul class="nav nav-tabs">
    <!-- Appears only during creation..? then replaced by status
      <li><a href="#">Import</a></li>
    -->
      <li><a href="#Metadata" data-toggle="tab">Metadata <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#Trees" data-toggle="tab">Trees <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#Files" data-toggle="tab">Files <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#OTU-Mapping" data-toggle="tab">OTU Mapping <span class="badge badge-important" style="display: none;">?</span></a></li>
    <!--
      <li><a href="#Annotations" data-toggle="tab">Annotations <span class="badge badge-important" style="display: none;">?</span></a></li>
    -->
      <li><a href="#Tools" data-toggle="tab">Tools <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#History" data-toggle="tab">History <span class="badge badge-important" style="display: none;">?</span></a></li>
    </ul>

    <div class="span4 Xbtn-group" style="float: right; margin-top: -56px;">
        {{ if viewOrEdit == 'EDIT': }}
          <button class="btn btn"
            onclick="if (validateFormData()) promptForSaveComments(); return false;">Save Study</button>
          <a id="return-to-study-list" class="btn btn-link" href="{{= URL(a='curator', c='default', f='index')}}">Cancel</a>
          <button class="btn btn-danger pull-right"
            onclick="removeStudy(); return false;">Delete Study</button>
        {{ else: }} 
          <a class="btn" href="{{= URL(a='curator', c='default', f='index')}}">Return to study list</a>
         {{ if userCanEdit: }}
          <a class="btn btn-info pull-right" href="{{=URL('study', 'edit/'+ studyID)}}"
            onclick="return confirm('Are you sure you want to edit this study?');">Edit Study</a>
         {{ else: }}
          <a class="btn btn-info pull-right" href="{{=URL('study', 'edit/'+ studyID)}}"
            onclick="return confirm('Are you sure you want to edit this study?');">Login to Edit Study</a>
         {{ pass }}
        {{ pass }}
    </div>
  </div>
 </div>
</div>
<div class="row">
    <div class="span12">
       {{if 'message' in globals():}}
        <h4>{{=message}}</h4>
       {{pass}}
    </div>
</div><!-- /.row -->

<div class="row">
    <div class="tab-content">

          <div class="tab-pane" id="Metadata">
           <div class="span8"><!-- main column... -->
            <ul class="suggestion-list"></ul>
            <form class="form-horizontal wider-fields">
              <div class="control-group">
                <label class="control-label" for="ot_studyPublicationReference">Publication reference</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <textarea data-bind="value: nexml['^ot:studyPublicationReference'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }, css: viewModel.ticklers.GENERAL_METADATA" id="ot_studyPublicationReference" class="input-xlarge" style="height: 160px;" placeholder=""></textarea>
                {{ else: }}
                  <p class="static-form-value" data-bind="text: nexml['^ot:studyPublicationReference']"></p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_studyPublication">Publication DOI (or URL)</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <input data-bind="value: nexml['^ot:studyPublication']['@href'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA, blur: formatDOIAsURL }, css: viewModel.ticklers.GENERAL_METADATA" type="text" id="ot_studyPublication" class="input-xlarge" placeholder="">
                  <button class="btn btn-info" onclick="lookUpDOI(); return false;">Look up DOI...</button>
                {{ else: }}
                  <p class="static-form-value">
                  <!-- ko if: nexml['^ot:studyPublication']['@href'] !== '' -->
                      <a target="_blank" data-bind="text: nexml['^ot:studyPublication']['@href'], attr: { href: nexml['^ot:studyPublication']['@href'] }"></a>
                 <!-- /ko -->
                 <!-- ko if: nexml['^ot:studyPublication']['@href'] === '' --> 
                      <em>None</em>
                 <!-- /ko -->
                  </p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_studyYear">Study Year</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <input data-bind="value: nexml['^ot:studyYear'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }" type="text" id="ot_studyYear" class="input-mini" placeholder="">
                {{ else: }}
                  <p class="static-form-value" data-bind="text: nexml['^ot:studyYear']"></p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_focalClade">Focal clade</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <div class="static-form-value" 
                       data-bind="text: nexml['^ot:focalCladeOTTTaxonName'] || 'None', attr:{'title': ('ottid:'+ nexml['^ot:focalClade'])}, css: viewModel.ticklers.GENERAL_METADATA">
                    &nbsp;
                  </div>
            <!-- reuse some (not all) style and behavior for taxon search in synth-tree viewer -->
            <div id="taxon-search-form" class="Xnavbar-search Xpull-right" autocomplete="off" style="Xdisplay: inline-block; position: relative;">
                <input type="text" name="taxon-search" class="Xsearch-query input-large" 
                    placeholder="Choose another taxon..." autocomplete="off">
                <!-- <input type="submit" style="" name="taxon-search-go" value="Go" onclick="return false;"/> -->
                <!-- then show dropdown when results are ready... -->
                <span style="color: #999; padding: 0 2px; font-size: 14px;">in</span>
                <select style="margin-bottom: 0; width: auto;" name="taxon-search-context">
                    {{ # generate our contextNames list based on newly fetched names
                      try:
                       for context_name in taxonSearchContextNames:
                          if context_name == 'All life': }}
                           <option selected="selected">{{= context_name }}</option>
                       {{ else: }}
                            <option>{{= context_name }}</option>
                       {{ pass }}
                    {{ pass }}
                    {{ except:
                        pass}}
                <!-- 
                NOTE that the displayed OPTION values (confirmed as current via AJAX) are accepted 
                by the server, ie, there's no distinction between visible and occult values.
                -->
                </select>
                <div class="">
                    <ul id="search-results" class="dropdown-menu">
                        ...
                    </ul>
                </div>
            </div>
                  <input data-bind="value: nexml['^ot:focalClade'], event: { change: nudge.GENERAL_METADATA }, css: viewModel.ticklers.GENERAL_METADATA" type="hidden" id="ot_focalClade" placeholder="">
                  <!--
                  <input data-bind="value: nexml['^ot:focalClade'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }" type="text" id="ot_focalClade" class="input-small" placeholder="">
                    -->
                {{ else: }}
                  <p class="static-form-value">
                    <span data-bind="text: nexml['^ot:focalCladeOTTTaxonName'], attr:{'title': ('ottid:'+ nexml['^ot:focalClade'])}, css: viewModel.ticklers.GENERAL_METADATA">&nbsp;</span>
                  </p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label">Tags</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                    <select id="study-tags" multiple="multiple" placeholder="Add tags"
                            onchange="updateElementTags(this); nudge.GENERAL_METADATA();"
                            data-bind="options: getTags(viewModel.nexml)">
                    </select>
                {{ else: }}
                    <!-- TODO: make all tags clickable (search in new window?) -->
                    <div class="bootstrap-tagsinput" 
                         style="border: none; margin-bottom: 0; padding: 4px 0; display: none;"
                         data-bind="visible: getTags(viewModel.nexml).length > 0">
                    <!-- ko foreach: getTags( viewModel.nexml ) -->
                        <span class="tag label label-info" data-bind="text:
                            $data"></span>
                    <!-- /ko -->
                    </div>
                    <p class="static-form-value" style="display: none;"
                       data-bind="visible: getTags(viewModel.nexml).length === 0">
                       <em>None</em>
                    </p>
                {{ pass }}

                </div>
              </div>

              <div class="control-group">
                <label class="control-label" for="ot_curatorName">Submitted by</label>
                <div class="controls">
                  <p class="static-form-value" data-bind="text: nexml['^ot:curatorName'].join(', ')"></p>
                 <!-- ko if: studyHasCC0Waiver( nexml ) -->
                  <a target="_blank" href="http://creativecommons.org/publicdomain/zero/1.0/">
                      <img alt="CC0 (opens a new window)" src="{{=URL('static','images/cc-zero.png')}}">
                  </a> 
                 <!-- /ko -->
                </div>
              </div>

              <div class="control-group">
                <div class="controls">

                {{ if viewOrEdit == 'EDIT': }}
                  <label class="checkbox">
                    <input type="checkbox" data-bind="checked: nexml['^ot:notIntendedForSynthesis'], event: { click: nudge.GENERAL_METADATA }"> This study should not contribute to synthesis.
                  </label>
                {{ else: }}
                  <p class="static-form-value" data-bind="css: nexml['^ot:notIntendedForSynthesis'] ? 'interesting-value' : 'boring-value', 
                                                          text: nexml['^ot:notIntendedForSynthesis'] ? 'This study should not contribute to synthesis. (This is not typical.)' : 'This study should contribute to synthesis.'"></p>
                {{ pass }}

                  <p class="static-form-value interesting-value" data-bind="text: studyContributedToLatestSynthesis() ? (currentStudyVersionContributedToLatestSynthesis() ? 'This version was used to build the latest synthetic tree' : 'This study has changed since building the last synthetic tree.') : 'This study was not used in the latest synthesis.'"></p>

                </div>

              </div>

              <div class="control-group">
                <label class="control-label">Curator notes</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <!-- markdown editor w/ preview option -->
                    <ul class="nav nav-pills pull-right" style="margin-bottom: 4px;">
                        <li><a target="_blank" href="https://help.github.com/articles/markdown-basics">Markdown help</a></li>
                    </ul>
                    <div class="btn-group" style="margin-bottom: 8px;">
                      <button id="edit-comment-button" class="btn active" onclick="showStudyCommentEditor(); return false;">&nbsp; Edit (as Markdown) &nbsp;</button>
                      <button id="preview-comment-button" class="btn" onclick="showStudyCommentPreview(); return false;">&nbsp; Preview (as HTML) &nbsp;</button>
                    </div>
<!--
                    <textarea id="save-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
-->
                    <div id="comment-editor"><textarea data-bind="value: viewModel.nexml['^ot:comment']"
                            placeholder="Enter notes for viewers and other curators here (as markdown)." 
                            rows="8" 
                            class="input-block-level">?</textarea></div>
                    <div id="comment-preview" class="rendered-comment" style="display: none;">
                    </div>
                {{ else: }}
                  <!-- render existing comment as markdown -->
                    <div class="rendered-comment" style="display: none;"
                         data-bind="visible: $.trim(viewModel.nexml['^ot:comment']) !== '', html: viewModel['commentHTML']" >
                       {comments appear here}
                    </div>
                    <p class="static-form-value" style="display: none;"
                       data-bind="visible: $.trim(viewModel.nexml['^ot:comment']) === ''">
                       <em>None</em>
                    </p>
                {{ pass }}

                </div>
              </div>

            </form>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                This tool is a friendly visual editor for curating <a target="_blank" i
                    href="https://github.com/OpenTreeOfLife/phylesystem-api/wiki/NexSON">NexSON files</a>. 
                Like the NeXML and NEXUS formats from which it evolved, each NexSON file
                contains information about a single published study, with a particular
                focus on its trees and OTUs.
              </p>
              <p>
                Each tab in this curation tool manages a different aspect of the
                study data. Watch for prompts&mdash;they look like 
                <span class="badge badge-important" style="">2</span>&mdash;in
                each tab that list areas ripe for improvement.
              </p>
              <p>
                Here in the <strong>Metadata</strong> tab, we're primarily
                concerned with clearly identifying this study and making it
                easy to find using standard publication references, DOIs, and
                free-form tags.
              </p>
            </div>
            <div class="well" style="clear: right;">
                <h4 style="margin-top: 0;">Working with study data in other tools</h4>

                <p>
                You can <strong>download this study</strong> in different forms:
                </p>
                <div class="btn-group" style="position: relative; top: -5px; margin-bottom: 10px;">
                    <a class="btn btn-small" href="{{= API_load_study_GET_url.replace('{STUDY_ID}', studyID) + '?output_nexml2json=1.2' }}" target="_blank">NexSON</a>
                    <a class="btn btn-small" href="{{= API_load_study_GET_url.replace('{STUDY_ID}', studyID) + '?output_nexml2json=nexml' }}" target="_blank">NeXML</a>
                    <a class="btn btn-small" href="{{= API_load_study_GET_url.replace('{STUDY_ID}', studyID) + '?output_nexml2json=?' }}" target="_blank">NEXUS</a>
                    <a class="btn btn-small" href="{{= API_load_study_GET_url.replace('{STUDY_ID}', studyID) + '?output_nexml2json=?' }}" target="_blank">Trees as Newick</a>
                </div>

                <p>
                You can also <strong>use the 
                <a href="https://github.com/OpenTreeOfLife/opentree/wiki/Open-Tree-of-Life-APIs" target="_blank">Open Tree API</a>
                </strong> (the same one the powers this editor) to retrieve and make changes to study data.
                </p>

            </div>

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Trees">
           <div class="span8"><!-- main column -->
            <ul class="suggestion-list"></ul>
            <div style="margin-bottom: 100px;">
              <div class="navbar">
               <div class="navbar-inner">
                <form class="navbar-search pull-left">
                    <input type="text" id="tree-list-filter" class="search-query" placeholder="Filter by name or ingroup clade"
                           data-bind="value: viewModel.listFilters.TREES.match, valueUpdate: ['afterkeydown', 'input']">
                </form>
               </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredTrees().pagedItems().length === 0">
                    No matching trees found! Add new trees or clear the
                    filter above to see trees in this study.
                </div>

                <table class="table table-condensed table-hover"
                    data-bind="visible: viewModel.filteredTrees().pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                      {{ if viewOrEdit == 'EDIT': }}
                        <th>Tree name (click to edit tree)</th>
                      {{ else: }}
                        <th>Tree name (click to view tree)</th>
                      {{ pass }}
                        <th>Type</th>
                        <th>Ingroup clade</th>
                        <th>Tree root</th>
                        <th>OTUs mapped</th>
                        <th>Preferred</th>
                      {{ if viewOrEdit == 'EDIT': }}
                        <th>&nbsp;</th>
                      {{ pass }}
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredTrees().pagedItems(), as: 'tree' }">
                    <tr data-bind="if: true">
                        <td>
                            <a href="#" data-bind="click: showConflictingNodesInTreeViewer,
                                text: tree['@label'],
                                css: viewModel.ticklers.TREES">?</a>
                            <a data-bind="if: unresolvedConflictsFoundInTree( tree ), 
                                          css: viewModel.ticklers.TREES,
                                          click: showConflictingNodesInTreeViewer" 
                               class="suggestion-prompt" style="display: block;"
                               href="#">
                                Conflicts found!
                            </a> 
                        </td>
                        <td data-bind="text: tree['^ot:curatedType'] || 'Unspecified',
                                css: viewModel.ticklers.TREES">TYPE?</td>
                        <td data-bind="text: getInGroupCladeDescriptionForTree(tree),
                                css: viewModel.ticklers.TREES"></td>
                        <td data-bind="html: getRootedDescriptionForTree(tree),
                                css: viewModel.ticklers.TREES">?/?? (?%)</td>
                        <td data-bind="html: getMappedTallyForTree(tree),
                                css: viewModel.ticklers.TREES">?/?? (?%)</td>
                      {{ if viewOrEdit == 'EDIT': }}
                        <td>
                            <input type="checkbox" style="margin: 0px 20px;" 
            data-bind="attr: {'checked': jQuery.inArray(tree['@id'], getPreferredTreeIDs()) !== -1}, 
                       click: togglePreferredTree" /></td>
                      {{ else: }}
                        <td data-bind="text: (jQuery.inArray(tree['@id'], getPreferredTreeIDs()) !== -1) ? 'YES' : 'NO'">?</td>
                      {{ pass }}
                      {{ if viewOrEdit == 'EDIT': }}
                        <td>
                            <button data-bind="click: removeTree"
                                class="pull-right btn btn-mini btn-danger row-controls-ghosted">
                                <i class="icon-remove icon-white"></i>
                            </button>
                        </td>
                      {{ pass }}
                    </tr>
                  </tbody>
                <!-- EXAMPLES of tree-table entries
                    <tr>
                        <td><a href="#">Parsimony tree (urchins)</a></td>
                        <td>Parsimony</td>
                        <td>92/108</td>
                        <td><input type="checkbox" checked="checked" /></td>
                    </tr>
                    <tr>
                        <td><a href="#">Alternate weighting</a></td>
                        <td>Parsimony</td>
                        <td>23/45</td>
                        <td><input type="checkbox" /></td>
                    </tr>
                    <tr>
                        <td><a href="#">Draft tree</a></td>
                        <td>Equally weighted</td>
                        <td>14/20</td>
                        <td><input type="checkbox" /></td>
                    </tr>
                -->
                </table>

                <div class="pagination pagination-centered pagination-small" 
                     Xdata-bind="if: viewModel.filteredTrees()().length &gt; viewModel.filteredTrees().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredTrees().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredTrees().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredTrees() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredTrees() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredTrees().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredTrees().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredTrees() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredTrees().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredTrees().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredTrees().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                The <strong>Trees</strong> tab provides an overview of
                phylogenetic trees in the current study. Well-groomed trees can
                be used by shared tools like the Open Tree project's
                <a href="https://github.com/OpenTreeOfLife/treemachine/wiki" target="_blank">treemachine</a>
                (see the <strong>Tools</strong> tab for details).
              </p>
              <p>
                Use the tools below to add new trees from a file or pasted text.
                <strong>Note:</strong> Adding trees and OTUs can quickly
                generate lots of cleanup chores! 
                Marking a tree as <strong>preferred</strong> in this list will
                prompt for full OTU mapping and other quality checks.
                We recommend adding
                only the most interesting and useful trees. 
                Precursor trees can be ignored here or added in the
                <strong>Files</strong> tab. 
              </p>
              <p>
                Click on the name of a tree to edit it using an interactive
                cladogram. You can re-root the tree, define its ingroup clade,
                and manage all of its properties in NexSON.
              </p>
            </div>

        {{ if viewOrEdit == 'EDIT': }}
            <div class="well" style="clear: right;">
                <h4 style="margin-top: 0;">Add a tree to this study</h4>
                <form id="tree-import-form" 
                      style="margin: 0;" 
                      Xaction="{{= URL(a='curator', c='default', f='to_nexson')}}" 
                      action="/curator/default/to_nexson" 
                      method="POST" 
                      onsubmit="submitNewTree(this); return false;"
                      Xonsubmit="console.log('DEFAULT tree-import-form submit (suppressed)'); return false;">
                 <fieldset>
                 <input type="hidden" name="output" value="ot:nexson">
                 <input type="hidden" name="author_name" 
                   value="{{= auth.user and auth.user.name or 'ANONYMOUS' }}">
                 <input type="hidden" name="author_email" 
                   value="{{= auth.user and auth.user.email or 'ANONYMOUS' }}">
                 <input type="hidden" name="auth_token" 
                   value="{{= auth.user and auth.user.github_auth_token or 'ANONYMOUS'}}">
                 <!--@MTH:"no longer needed on upload" input type="hidden" name="uploadid" value=""-->
                 <!-- hints for new element IDs -->
                 <input type="hidden" name="idPrefix" value="">
                 <input type="hidden" name="firstAvailableEdgeID" value="">
                 <input type="hidden" name="firstAvailableNodeID" value="">
                 <input type="hidden" name="firstAvailableOTUID" value="">
                 <input type="hidden" name="firstAvailableOTUsID" value="">
                 <input type="hidden" name="firstAvailableTreeID" value="">
                 <input type="hidden" name="firstAvailableTreesID" value="">
                 <input type="hidden" name="firstAvailableAnnotationID" value="">
                 <input type="hidden" name="firstAvailableAgentID" value="">
                 <input type="hidden" name="firstAvailableMessageID" value="">

                  <select id="tree-import-format" name="inputFormat" 
                          class="input-block-level"
                          style="margin-bottom: 1em;"
                          oninput="updateNewTreeUploadForm(); return true;"
                          onchange="updateNewTreeUploadForm(); return true;">
                      <option value="" selected="selected">What is the format of this tree?</option>
                      <option value="nexus">NEXUS</option>
                      <option value="newick">Newick</option>
                      <option value="nexml">NeXML</option>
                  </select>
                  <label for="new-tree-text">Paste tree data (text)&hellip;</label>
                  <textarea id="new-tree-text" name="content" rows="5"
                            class="input-block-level"
                            onkeyup="updateNewTreeUploadForm(); return true;"
                            oninput="updateNewTreeUploadForm(); return true;"
                            onchange="updateNewTreeUploadForm(); return true;"
                            ></textarea>
                  
                  <label for="treeupload">&hellip;or upload a tree file</label>


                <div>
                    <span class="btn fileinput-button">
                        <i class="glyphicon glyphicon-plus"></i>
                        <span>Select file to upload...</span>
                        <!-- The file input field used as target for the file upload widget -->
                        <input id="treeupload" 
                               type="file" name="file"
                               onchange="$('#upload-tree-info').html( filenameFromFakePath($(this).val()) ); updateNewTreeUploadForm(); return true;">
                    </span>
                    &nbsp;
                    <span class='label label-info' id="upload-tree-info"></span>
                </div>
                <div id="tree-upload-progress" class="progress progress-info" 
                     style="margin-top: 0.3em; margin-bottom: 1em; background-color: #333;">
                  <div class="bar" style="text-align: center; width: 0%;">
                      <span>&nbsp;</span>
                  </div>
                </div>

<!-- TODO: Enter a URL or DOI for the new tree?
                  <label for="new-tree-URL">&hellip;or paste an URL to the tree</label>
                  <input type="text" id="new-tree-URL" class="input-block-level" value="" placeholder="Paste URL here">
-->

                  <label class="checkbox">
                      <input name="newTreesPreferred" type="checkbox" value="true">
                      Mark this tree as preferred for synthesis
                  </label>

                  <div Xclass="form-actions" style="margin-top: 1em;">
                      <button name="new-tree-submit" type="submit" 
                          class="btn btn-info btn-info-disabled" 
                          disabled="disabled">Add new tree 
                        <i class="icon-circle-arrow-up Xicon-arrow-up Xicon-chevron-up Xicon-plusXicon-upload icon-white"></i></button>
                      <button type="reset" class="btn" 
                              onclick="clearNewTreeUploadWidget(); return true;"
                      >Clear form</button>
                  </div>
                 </fieldset>
                </form>
            </div>
        {{ pass }}

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Files">
           <div class="span8"><!-- main column... -->
            <ul class="suggestion-list"></ul>
            <div style="margin-bottom: 100px;">

              <div class="navbar">
               <div class="navbar-inner">
                <form class="navbar-search pull-left">
                    <input type="text" id="file-list-filter" class="search-query" placeholder="Filter by name or description"
                           data-bind="value: viewModel.listFilters.FILES.match, valueUpdate: ['afterkeydown', 'input']">
                </form>
               </div>
              </div>

                {{ #TODO: IF a dataDeposit URL is found, should we hide the files list? block editing and addition of files/trees? }}
                <div class="empty-list-prompt" data-bind="visible: $.trim(viewModel.nexml['^ot:dataDeposit']['@href']) !== ''" style="margin-bottom: 1em;">
                    Data for this study is permanently archived here:<br/> 
                    <a data-bind="text: $.trim(viewModel.nexml['^ot:dataDeposit']['@href']), attr: { href: $.trim(viewModel.nexml['^ot:dataDeposit']['@href']) }" target="_blank"></a>
                </div>
                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredFiles().pagedItems().length === 0">
                    No matching files found! Add files or use the filters
                    above to see supporting files in this study.
                </div>

                <table class="table table-condensed table-hover"
                    data-bind="visible: viewModel.filteredFiles().pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                        <th width="35%">File name (click to download)</th>
                        <th width="*">Description</th>
                        <th width="15%">Size</th><!-- also includes possible delete button -->
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredFiles().pagedItems(), as: 'file' }">
                    <tr>
                    {{ if viewOrEdit == 'EDIT': }}
                        <td>
                            <a href="#" target="_blank" data-bind="text: file['@filename'] || '?', attr: { href: file['@url'] || '#' }">
                                Alignment data (urchins).xls
                            </a>
                        </td>
                        <td>
                            <div><textarea data-bind="value: file.description.$"
                            placeholder="Describe this file's format and purpose." 
                            rows="2" 
                            class="input-block-level"
                            style="margin-bottom: 0px;">?</textarea></div>
                            <em data-bind="if: getAssociatedTrees(file).length > 0">
                                Source for tree(s):
                                <strong data-bind="text: getAssociatedTreeLabels(file).join(', ')">&nbsp;</strong>
                            </em>
                           <!-- TODO: make this directly editable?
                            <input type="text" data-bind="value: file['@sourceForTree']"
                                   placeholder="Tree ID (if source file for a tree)">OPTIONAL_TREE_ID</em>
                           -->
                        </td>
                        <td><span data-bind="text: getHumanReadableFileSize(file['@size']) || '?'">241 KB</span>
                            <button data-bind="visible: getAssociatedTrees(file).length > 0"
                                class="pull-right btn btn-mini" 
                                style="opacity: 0.3 !important;"
                                onclick="alert('You must delete the associated tree(s) to remove this file.'); return false;">
                                <i class="icon-remove"></i>
                            </button>
                            <button data-bind="visible: getAssociatedTrees(file).length === 0, click: removeSupportingFile"
                                class="pull-right btn btn-mini row-controls-ghosted">
                                <i class="icon-remove"></i>
                            </button>
                        </td>
                    {{ else: }}
                        <td>
                            <a href="#" target="_blank" data-bind="text: file['@filename'] || '?', attr: { href: file['@url'] || '#' }">
                                Alignment data (urchins).xls
                            </a>
                        </td>
                        <td>
                            <div data-bind="text: file.description.$">Microsoft Excel spreadsheet</div>
                            <em data-bind="if: getAssociatedTrees(file).length > 0">
                                Source for tree(s):
                                <strong data-bind="text: getAssociatedTreeLabels(file).join(', ')">&nbsp;</strong>
                            </em>
                        </td>
                        <td><span data-bind="text: getHumanReadableFileSize(file['@size']) || '?'">241 KB</span></td>
                    {{ pass }}
                    </tr>
                  </tbody>
                </table>

                <div class="pagination pagination-centered pagination-small" 
                     Xdata-bind="if: viewModel.filteredFiles()().length &gt; viewModel.filteredFiles().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredFiles().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredFiles().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredFiles() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredFiles() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredFiles().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredFiles().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredFiles() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredFiles().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredFiles().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredFiles().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                The <strong>Files</strong> tab is a list of supporting files
                for this study. This can include character matrices, precursor
                trees, images&mdash;anything that would normally be submitted
                to a permanent data repository.
              </p>
              <p>
                Use the <strong>upload tool</strong> below to add one or more files from your
                local filesystem. Once uploaded, they will appear in the list
                at left, where you can add a short description of each. Tree
                data imported from the <strong>Trees</strong> tab will
                also appear here in its original form.
              </p>
              <p>
                Note that these files won't be added to the NexSON document
                itself; instead, they're stored on our servers pending transfer
                to a permanent data repository. (This feature is not yet complete.)
              </p>
              <p>
                <strong>[TODO]</strong> Describe how we interoperate with data repositories, and
                what the curator can do here if the permanent deposit of this study's
                data has already taken place.
              </p>
            </div>

        {{ if viewOrEdit == 'EDIT': }}
            <div class="well" style="clear: right;">
                <h4 style="margin-top: 0;">Add a file to this study</h4>
                <form style="margin: 0;">
                 <fieldset>

                <div>
                    <span class="btn btn-info fileinput-button">
                        <i class="glyphicon glyphicon-plus"></i>
                        <span>Select file(s) to upload...</span>
                        <!-- The file input field used as target for the file upload widget -->
                        <input id="fileupload" type="file" name="files[]" multiple>
                    </span>

                </div>
                <div id="file-upload-progress" class="progress progress-info" 
                     style="margin-top: 1em; margin-bottom: 0; background-color: #333;">
                  <div class="bar" style="text-align: center; width: 0%;">
                      <span>&nbsp;</span>
                  </div>
                </div>

  <!--
                  <label for="new-file-url">&hellip;or paste its URL:</label>
                  <input type="text" id="new-file-url" name="new-file-url" class="input-block-level" value="" placeholder="Paste file URL here">

                  <div Xclass="form-actions" style="margin-top: 1em;">
                      <button type="submit" class="btn btn-primary btn-primary-disabled" onclick="addSupportingFileFromURL(); return false;">Add new file 
                        <i class="icon-circle-arrow-up Xicon-arrow-up Xicon-chevron-up Xicon-plusXicon-upload icon-white"></i></button>
                      <button type="button" class="btn">Cancel</button>
                  </div>
  -->
                 </fieldset>
                </form>
            </div>
        {{ pass }}
           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="OTU-Mapping">
           <div class="span8"><!-- main column... -->
            <ul class="suggestion-list"></ul>
            <div style="margin-bottom: 100px;">

              <div class="navbar">
               <div class="navbar-inner">
                <form class="navbar-search pull-left">
                    <input type="text" id="otu-list-filter" class="search-query" placeholder="Filter by original or mapped label"
                           data-bind="value: viewModel.listFilters.OTUS.match, valueUpdate: ['afterkeydown', 'input']">
                </form>
                <ul class="nav" style="padding-left: 1em;">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                            data-toggle="dropdown">
                            <span data-bind="text: viewModel.listFilters.OTUS.scope">SCOPE</span>
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" data-bind="foreach: ['In all trees', 'In preferred trees', 'In non-preferred trees']">
                            <li data-bind="css: {'disabled': viewModel.listFilters.OTUS.scope() == $data }">
                                <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.OTUS.scope($data); }">SCOPE</a>
                            </li>
                        </ul>
                    </li>
                    <!--<li class="divider-vertical"></li>-->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                            data-toggle="dropdown">
                            <span data-bind="text: viewModel.listFilters.OTUS.order">SORT</span>
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" data-bind="foreach: ['Unmapped OTUs first', 'Mapped OTUs first', 'Original label (A-Z)', 'Original label (Z-A)']">
                            <li data-bind="css: {'disabled': viewModel.listFilters.OTUS.order() == $data }">
                                <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.OTUS.order($data); }">SORT</a>
                            </li>
                        </ul>
                    </li>
                </ul>
               </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredOTUs().pagedItems().length === 0">
                    No matching OTUs found! Use the filters above to see
                    OTUs in this study.
                </div>

                <table class="table table-condensed table-hover"
                    data-bind="visible: viewModel.filteredOTUs().pagedItems().length !== 0">
                  <thead>
                    <tr>
                        <th width="30%">Original label</th>
                      {{ if viewOrEdit == 'EDIT': }}
                        <th width="5%">&nbsp;</th>
                        <th width="30%">Modified for mapping</th>
                        <th width="5%">&nbsp;</th>
                      {{ pass }}
                        <th width="30%">Taxon label in OTT</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredOTUs().pagedItems(), as: 'otu' }">
                    <tr data-bind="if: true">
                        <td data-bind="text: otu['^ot:originalLabel']">ORIGINAL?</td>
                        <td>
                            <button class="btn btn-mini row-controls-ghosted" title="Show this OTU in all trees"
                                     data-bind="click: showOTUInContext, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-search"></i>
                            </button>
                        </td>
                      {{ if viewOrEdit == 'EDIT': }}
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && (bogusEditedLabelCounter() > 0) && !('^ot:altLabel' in otu) -->
                        <td>
                            <em data-bind="text: otu['^ot:altLabel'] || '', 
                                           css: viewModel.ticklers.OTU_MAPPING_HINTS,
                                           style: { 'color' : ($.trim(otu['^ot:ottTaxonName']) === '' && !proposedMapping(otu)) ?  '' : 'silver' }"
                               >WORKING?</em>
{{ if False: }}
{{ pass }}
                        </td>
                        <td>
                          <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && $.trim(otu['^ot:ottTaxonName']) === '' && !proposedMapping(otu) -->
                            <button class="btn btn-mini row-controls-ghosted" title="Edit this label manually" 
                                    data-bind="click: editOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-edit"></i>
                            </button>
                          <!-- /ko -->
                        </td>
                         <!-- /ko -->
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && (bogusEditedLabelCounter() > 0)  && ('^ot:altLabel' in otu) --> 
                        <td>
                            <input type="text" style="height: 14px; margin:
                            0; width: 97%;" data-bind="value: otu['^ot:altLabel'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: modifyEditedLabel, change: modifyEditedLabel }, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                        </td>
                        <td>
                            <button class="btn btn-mini row-controls-ghosted" type="button" style="margin-top: 1px;" data-bind="click: revertOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-remove"></i>
                            </button>
                        </td>
                         <!-- /ko -->
                      {{ pass }}
                        <td>
                         <!-- ko if: currentlyMappingOTUs.indexOf(otu['@id']) !== -1 -->
                            <strong style="color: red;"><em>...mapping now...</em></strong>
                         <!-- /ko -->
                         <!-- ko if: failedMappingOTUs.indexOf(otu['@id']) !== -1 -->
                            <strong style="color: #999;"><em>Failed mapping (edit or add hints)</em></strong>
                         <!-- /ko -->
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() &&
                                     (currentlyMappingOTUs.indexOf(otu['@id']) === -1) && 
                                     (failedMappingOTUs.indexOf(otu['@id']) === -1) -->
                      {{ if viewOrEdit == 'EDIT': }}
                          <!-- ko if: proposedMapping(otu) -->
                            <div class="btn-group pull-right">
                                <button class="btn btn-mini" data-bind="click: approveProposedOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                    <i class="icon-ok"></i>
                                </button>
                                <button class="btn btn-mini" data-bind="click: rejectProposedOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                    <i class="icon-remove"></i>
                                </button>
                            </div>
                          <!-- /ko -->
                          <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && $.trim(otu['^ot:ottTaxonName']) -->
                            <div class="btn-group pull-right row-controls-ghosted">
                                <button class="btn btn-mini" data-bind="click: unmapOTUFromTaxon, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                    <i class="icon-remove"></i>
                                </button>
                            </div>
                          <!-- /ko -->
                            <strong data-bind="text: proposedMapping(otu) ?  proposedMapping(otu).name : $.trim(otu['^ot:ottTaxonName']),
                                               css: viewModel.ticklers.OTU_MAPPING_HINTS,
                                               style:  {'color': proposedMapping(otu) ? 'red' :'' }"
                                >MAPPED (OR PROPOSED) LABEL</strong>
                      {{ else: }}
                            <strong data-bind="text: $.trim(otu['^ot:ottTaxonName'])">MAPPED LABEL</strong>
                      {{ pass }}
                         <!-- /ko -->
                        </td>
                    </tr>
                  </tbody>
                </table>

                <div class="pagination pagination-centered pagination-small" 
                     Xdata-bind="if: viewModel.filteredOTUs()().length &gt; viewModel.filteredOTUs().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredOTUs().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredOTUs().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredOTUs() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredOTUs() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredOTUs().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredOTUs().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredOTUs() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredOTUs().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredOTUs().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredOTUs().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>
            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
                <p>
                For a tree in your study to contribute to synthesis in the 
                <a href="http://blog.opentreeoflife.org/what-is-the-tree-of-life/" target="_blank">Open Tree of Life project</a>, 
                its leaf nodes should correspond to taxa in the 
                <a href="https://github.com/OpenTreeOfLife/reference-taxonomy/wiki/General-information" target="_blank">OTT (Open Tree Taxonomy)</a>. 
                This list includes all the OTUs (operating taxonomic units) in
                your study. Each OTU is a distinct label used in one or more of
                your study's trees.
                </p>
                <p>
                We use a TNRS (taxonomic name resolution service) to automate this
                "mapping" process where possible. If you've used standard taxonomic
                names for the nodes in your trees, mapping is fast and easy.
                But most trees submitted have been labeled with institutional
                shorthand, unrecognized taxa, or simple misspellings. The tools on
                this page will help you adjust labels for faster mapping.
                </p>
            </div>

<!-- TODO: If we're doing independent server-side mapping, show a blanket message like this to avoid conflicts?
            <div class="alert alert-block">
                <h4>Server-side mapping in progress</h4>
                This section is blocked while the server works. Please check again later. [TODO] 
            </div>
-->

        {{ if viewOrEdit == 'EDIT': }}

            <button class="btn btn-warning input-block-level" style="margin-bottom: 1em;"
                    onclick="clearVisibleMappings(); return false;">
                <i class="icon-warning-sign icon-white"></i>
                Clear all visible mappings
            </button>

            <div id="mapping-status-panel" class="well">
                <div class="pull-right" style="margin-top: -2px;">
                    <button id="pause-mapping-button" class="btn btn-small" 
                            data-bind="visible: autoMappingInProgress()"
                            onclick="stopAutoMapping(); return false;">
                        <i class="icon-pause"></i> Pause mapping</button>
                    <button id="start-mapping-button" class="btn btn-small"
                            data-bind="visible: !autoMappingInProgress()"
                            onclick="startAutoMapping(); return false;">
                        <i class="icon-play"></i> Start mapping</button>
                </div>
                <h4 style="margin-top: 0;">Mapping status</h4>
                <div class="progress" 
                     style="margin-bottom: 0; background-color: #333;"
                     data-bind="css: recentMappingSpeedBarClass">
                  <div class="bar" style="text-align: center;"
                       data-bind="style: { width: recentMappingSpeedPercent }">
                      <span data-bind="text: recentMappingSpeedLabel">10 sec / name</span>
                  </div>
                </div>
                <div class="mapping-details"><!--
                    <p>For best results, wrap messages here in paragraphs.</p>
            --></div>
                <div class="mapping-batch-operations" style="display: none;">
                    <button id="batch-approve" class="btn btn-small pull-left"
                            onclick="approveAllVisibleMappings(); return false;">
                        <i class="icon-ok"></i> <strong>Approve all</strong> and continue
                    </button>
                    <button id="batch-reject" class="btn btn-small pull-right"
                            onclick="rejectAllVisibleMappings(); return false;">
                        <i class="icon-remove"></i> <strong>Reject all</strong> and pause
                    </button>
                </div>
            </div>
            <div class="well">
                <h4 style="margin-top: 0;">Mapping hints</h4>
                <p>
                The easiest way to improve mapping performance is to provide a
                narrow context for the search.
                </p>
                <form class="form-inline" style="margin: 0;">
                 <fieldset>
                    <!-- scraped from header search in main opentree webapp -->
                    <!-- TODO: fetch a live list, as we do there? -->
                    <select class="input-block-level" style="margin-bottom: 1em;" name="taxon-search-context" 
                            data-bind="value: getOTUMappingHints().data.searchContext.$">
                            <option selected="selected">All life</option>
                            <option>Land plants</option>
                            <option>Hornworts</option>
                            <option>Mosses</option>
                            <option>Liverworts</option>
                            <option>Vascular plants</option>
                            <option>Club mosses</option>
                            <option>Ferns</option>
                            <option>Seed plants</option>
                            <option>Flowering plants</option>
                            <option>Magnoliids</option>
                            <option>Monocots</option>
                            <option>Eudicots</option>
                            <option>Asterids</option>
                            <option>Rosids</option>
                            <option>Animals</option>
                            <option>Birds</option>
                            <option>Tetrapods</option>
                            <option>Mammals</option>
                            <option>Amphibians</option>
                            <option>Vertebrates</option>
                            <option>Arthropods</option>
                            <option>Molluscs</option>
                            <option>Platyhelminthes</option>
                            <option>Annelids</option>
                            <option>Cnidarians</option>
                            <option>Arachnides</option>
                            <option>Insects</option>
                            <option>Bacteria</option>
                            <option>Fungi</option>
                    <!-- 
                    NOTE that the displayed OPTION values (confirmed as current via AJAX) are accepted 
                    by the server, ie, there's no distinction between visible and occult values.
                    -->
                    </select>
                 </fieldset>
                </form>
                <p>
                If mapping is slow or failing, you can streamline the process by
                modifying the original node labels. Any active substitutions below
                will be applied to all labels during OTU mapping. (See the
                italic <strong>Modified for mapping</strong> values at left.)
                Try some common patterns from the drop-down menu below, or use
                <a href="http://www.regular-expressions.info/javascript.html#replace" target="_blank">regular expressions</a> to construct your own.
                </p>
                <i data-bind="if: getOTUMappingHints() === null">ERROR: No mapping hints found!</i>
              <!-- ko if: getOTUMappingHints() !== null -->
                <form class="form-inline" style="margin: 0;">
                 <fieldset>
                  <table>
                    <thead>
                        <tr>
                            <th width="20">&nbsp;</th>
                            <th>Replace this...</th>
                            <th>with this</th>
                            <th width="20">&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody id="mapping-adjustments" data-bind="foreach: { data: getOTUMappingHints().data.substitutions.substitution, as: 'substitution'}, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                        <tr>
                            <td align="center" valign="center">
                                <input type="checkbox" data-bind="checked: substitution['@active'], event: { click: nudge.OTU_MAPPING_HINTS }" 
                                       title="If checked, this substitution will be used."/>
                            </td>
                            <td>
                                <input type="text" class="input-block-level" 
                                       data-bind="value: substitution.old.$, valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.OTU_MAPPING_HINTS, change: nudge.OTU_MAPPING_HINTS }, style: { 'background-color': substitution['@valid'] ? '' : '#fdd' }"/>
                            </td>
                            <td>
                                <input type="text"
                                class="input-block-level" data-bind="value: substitution.new.$, valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.OTU_MAPPING_HINTS, change: nudge.OTU_MAPPING_HINTS }"/>
                            </td>
                            <td align="center" valign="center">
                                <a href="#" title="Click to remove this substitution."
                                   data-bind="click: function(data, event) { removeSubstitution(data);  }" />
                                    <i class="icon-remove"></i></a>
                            </td>
                        </tr>
                    </tbody>
                  </table>

                  <div style="margin-top: 1em;">
                      <select class="input-block-level" onchange="addSubstitution(this); return false;">
                        <option value="">Add a common substitution...</option>
                       <!-- NOTE the convention here... value="{OLD} =:= {NEW}" -->
                        <option value="\bsp(\.|\b) =:= ">Remove 'sp.'</option>
                        <option value="foo =:= bar">Replace 'foo' with 'bar'</option>
                        <option value="^(\w*)\s+\b =:= ">Remove first of multiple words</option>
                        <option value="\b\s+(\w*)$ =:= ">Remove last of multiple words</option>
                        <option value=".*\s+(\w*)\s*$ =:= $1">Isolate trailing ID</option>
                      </select>
                  </div>
                  <div style="margin-top: 1em;">
                      <button type="submit" class="btn"
                              onclick="addSubstitution(); return false;">Add another substitution 
                        <i class="icon-add "></i></button>
                  </div>

                 </fieldset>
                </form>
              <!-- /ko -->
                <p style="margin: 1em 0 0;">
                As a last resort, you can directly edit the label submitted for mapping. Just click 
                the <button class="btn btn-mini"><i class="icon-edit"></i></button> buttons
                in the <strong>Modified for mapping</strong> column at left.
                </p>
            </div>
        {{ pass }}

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Annotations">
           <div class="span12"><!-- full width... -->

            <button class="help-toggle" style="display: none; margin-bottom: 0px;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                <strong>Annotations</strong> are used to store comments and
                validation results related to this study. They can be added by
                a human curator or reviewer (coming soon), or by online validators
                and other programs like those listed in the
                <strong>Tools</strong> tab.
              </p>
              <p>
                Annotations that refer to a particular element (like a tree or
                OTU) will often appear in context. You can read these by
                clicking on a marker like <span class="badge badge-info">2 <i class="icon-comment icon-white"></i></span> 
                (coming soon), but the list below gathers all the study's
                annotations in a single place.
              </p>
            </div>

            <ul class="suggestion-list" style="clear: right;"></ul>
            <div style="margin-bottom: 100px;">

              <div class="navbar">
                 <div class="navbar-inner">
                  <form class="navbar-search pull-left">
                      <input type="text" id="annotation-list-filter" class="search-query input-xlarge" placeholder="Filter by type, location, submitter, message"
                             data-bind="value: viewModel.listFilters.ANNOTATIONS.match, valueUpdate: ['afterkeydown', 'input']">
                  </form>
                <!-- TODO: Can we provide some kind of support for thes filters?
                  <ul class="nav" style="padding-left: 1em;">
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            In trees and nodes
                            <b class="caret"></b>
                          </a>
                          <ul class="dropdown-menu">
                              <li><a href="#">Anywhere in the study</a></li>
                              <li><a href="#">In files</a></li>
                              <li><a href="#">In OTU mapping</a></li>
                              <li><a href="#">In study metadata</a></li>
                              <li><a href="#">In trees and nodes</a></li>
                          </ul>
                      </li>
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                              <span data-bind="text: viewModel.listFilters.ANNOTATIONS.submitter">SORT</span>
                              <b class="caret"></b>
                          </a>
                          <ul class="dropdown-menu" data-bind="foreach: ['Submitted by all', 'Submitted by users', 'Submitted by validation tools']">
                              <li data-bind="css: {'disabled': viewModel.listFilters.ANNOTATIONS.submitter() == $data }">
                                  <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.ANNOTATIONS.submitter($data); }">SORT</a>
                              </li>
                          </ul>
                      </li>
                  </ul>
                  -->
                 </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredAnnotations().pagedItems().length === 0">
                    No matching annotations found! Clear the
                    filter above to see annotations in this study.
                </div>

                <table class="table table-condensed"
                    data-bind="visible: viewModel.filteredAnnotations().pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                        <th>Type</th>
                        <!-- <th>Location (click to see note there)</th> -->
                        <th>Added by</th>
                        <th>Message(s)</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredAnnotations().pagedItems(), as: 'annotation' }">
                    <tr>
                        <td data-bind="text: annotation['@description'], style: { color: annotation['@passedChecks'] ? '' : 'red' }"></td><!-- general description (annotation type) -->
                        <!-- <td><a href="#">Study</a></td> -->
                        <td data-bind="text: getAgentForAnnotationEvent( annotation ) ? getAgentForAnnotationEvent( annotation )['@name'] : '??'"></td>
                      <!-- ko if: makeArray( annotation.message ).length > 0 -->
                        <td data-bind="if: makeArray( annotation.message ).length > 0">
                            <ul style="list-style: none; margin: 0 0 8px 0;"
                            data-bind="foreach: makeArray( annotation.message )">
                                <li style="border-bottom: 1px solid #ccc; padding: 2px 0;">
                                <!-- data-bind="text: code" is SHOUTY_UPPERCASE -->
                                <span data-bind="text: $data['@comment']"></span>
                                <!-- data-bind="text: data" can be object or function or ... -->
                                in <span data-bind="text: ('@top' in $data.refersTo) ? $data.refersTo['@top'].$ : '??'"></span>
                                [<span data-bind="text: $data['@severity']"></span>]
                            </ul>
                        </td>
                      <!-- /ko -->
                      <!-- ko if: makeArray( annotation.message ).length === 0 -->
                        <td>
                            NO MESSAGES HERE
                        </td>
                      <!-- /ko -->
                    </tr>
                  </tbody>
                </table>
                  <!-- EXAMPLES of other annotation types: 
                    <tr>
                        <td>Reply</td>
                        <td><a href="#">Message thread</a></td>
                        <td><a href="#">Charles Darwin</a></td>
                        <td style="font-style: italic;">Au contraire, mon ami. The condor properly belongs everywhere...</td>
                    </tr>
                    <tr>
                        <td>Comment</td>
                        <td><a href="#">Charadriidae</a></td>
                        <td><a href="#">Jim Allman</a></td>
                        <td style="font-style: italic;">This is not the place for condors or butterflies in any case...</td>
                    </tr>
                    <tr>
                        <td>Question</td>
                        <td><a href="#">Additional Birds.xls</a></td>
                        <td><a href="#">Jonathan Rees</a></td>
                        <td style="font-style: italic;">Is there a reason for this data file? It doesn't seem to correspond...</td>
                    </tr>
                    <tr>
                        <td>Erratum</td>
                        <td><a href="#">Seabird tree</a></td>
                        <td><a href="#">Charles Darwin</a></td>
                        <td style="font-style: italic;">This tree is poorly rooted, in my opinion.</td>
                    </tr>
                  -->

                <!-- TODO: respond to calculated notes, gathered from throughout study NexSON -->
                <div class="pagination pagination-centered pagination-small" 
                     Xdata-bind="if: viewModel.filteredAnnotations()().length &gt; viewModel.filteredAnnotations().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredAnnotations().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredAnnotations().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredAnnotations() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredAnnotations() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredAnnotations().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredAnnotations().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredAnnotations() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredAnnotations().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredAnnotations().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredAnnotations().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>
           </div><!-- end of full-width column... -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Tools">
           <div class="span8"><!-- main column... -->
            <ul class="suggestion-list"></ul>

            <div style="margin-bottom: 100px;">

                <table class="table Xtable-condensed bare-top-row">
                  <tbody>
                    <tr>
                        <td colspan="3" style="color: #c33; font-weight: bold; font-size: 1.25em; text-align: center;">
                            NOTE: The tools shown below are non-functional placeholders!
                        </td>
                    </tr>
                    <tr style="opacity: 0.5;">
                        <td width="100">
                            <img class="tool-icon" alt="treemachine" src="{{=URL('static','images/tools/treemachine-icon.png')}}" />
                        </td>
                        <td width="125"><a href="http://blog.opentreeoflife.org/what-is-the-tree-of-life/" target="_blank">Open Tree of Life (treemachine)</a></td>
                        <td>
                            This runs automatically for any study in the
                            system. <strong>This study fails</strong>, possibly
                            because it has no preferred tree (marked for
                            synthesis) or needs additional OTU mapping for
                            synthesis.
                        </td>
                    </tr>
                    <tr style="opacity: 0.5;">
                        <td>
                            <img class="tool-icon" alt="MIAPA validator" src="{{=URL('static','images/tools/miapa-icon.png')}}" />
                        </td>
                        <td><a href="https://github.com/miapa/miapa/blob/master/checklist/MIAPA-checklist.md" target="_blank">MIAPA Validator</a></td>
                        <td>
                            This runs automatically against any study in the system. <strong>This study passes!</strong>
                        </td>
                    </tr>
                  </tbody>
                </table>

            </div>
           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
                <p>
                  The <strong>Tools</strong> listed here can modify your NexSON
                  files or use them in powerful ways. 
                </p>
                <p>
                  Each tool will explain whether it applies to this NexSON
                  file; if not, it will suggest additions or improvements that
                  would make it compatible.
                </p>
                <p>
                  [TODO] Suggest how to use tools, add new ones, register a new tool..? 
                </p>
            </div>

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="History">
           <div class="span12"><!-- full width... -->

            <button class="help-toggle" style="display: none; margin-bottom: 0px;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                This tab shows the <strong>edit history</strong> for this study:
                each saved version of the data, who submitted the changes, and
                a comment added each time. Note that this might include edits
                made in other tools, or by automated software.
              </p>
            </div>

            <ul class="suggestion-list" style="clear: right;"></ul>
            <div style="margin-bottom: 100px;">

                <div class="empty-list-prompt" data-bind="visible: viewModel.versions.pagedItems().length === 0">
                    No previous versions found! (This is a new study.)
                </div>

                <table class="table table-condensed"
                    data-bind="visible: viewModel.versions.pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                        <th width="20%">Date</th>
                        <th width="20%">Curated by</th>
                        <th width="60%">Comment</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.versions.pagedItems(), as: 'version' }">
                    <tr>
                        <td><span data-bind="text: version['relative_date'], attr: {'title': version['date']}">?</span></td>
                        <td data-bind="text: version['author_name']">?</td>
                        <td><pre class="rendered-comment" data-bind="text: version['message_subject'] + (version['message_body'] ? '\n\n'+ version['message_body'] : '')">?</pre></td>
                    </tr>
                  </tbody>
                </table>

                <div class="pagination pagination-centered pagination-small" 
                     Xdata-bind="if: viewModel.versions()().length &gt; viewModel.versions().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.versions.prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.versions.prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.versions ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.versions ) -->
                    <li data-bind="css: { 'active': (viewModel.versions.current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.versions.goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.versions ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.versions.goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.versions.next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.versions.next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>
           </div><!-- end of full-width column... -->
          </div><!-- /.tab-pane -->
    </div><!-- /.tab-content -->


</div><!-- /.row -->

<script type='text/javascript'>
    var studyID = '{{= studyID }}';
    var latestSynthesisSHA = '{{= latestSynthesisSHA }}';
    var viewOrEdit = '{{= viewOrEdit }}';
    var authorName = '{{= auth.user and auth.user.name or 'ANONYMOUS' }}';
    var authorSafeID = '{{= auth.user and auth.user.username.encode('ascii', 'ignore') or 'ANONYMOUS' }}';
    var authorEmail = '{{= auth.user and auth.user.email or 'ANONYMOUS' }}';
    var authToken = '{{= auth.user and auth.user.github_auth_token or 'ANONYMOUS'}}';
    var API_load_study_GET_url = '{{=API_load_study_GET_url}}';
    var API_update_study_PUT_url = '{{=API_update_study_PUT_url}}';
    var API_remove_study_DELETE_url = '{{=API_remove_study_DELETE_url}}';
    var API_create_file_POST_url = '{{=API_create_file_POST_url}}';
    var API_load_file_GET_url = '{{=API_load_file_GET_url}}';
    var API_update_file_PUT_url = '{{=API_update_file_PUT_url}}';
    var API_remove_file_DELETE_url = '{{=API_remove_file_DELETE_url}}';

    var treemachine_domain = "{{=treemachine_domain}}";
    var taxomachine_domain = "{{=taxomachine_domain}}";
    var getDraftTreeID_url = "{{=getDraftTreeID_url}}";
    var getSyntheticTree_url = "{{=getSyntheticTree_url}}";
    var getSourceTree_url = "{{=getSourceTree_url}}";
    var getConflictTaxJsonAltRel_url = "{{=getConflictTaxJsonAltRel_url}}";
    var getDraftTreeForOttolID_url = "{{=getDraftTreeForOttolID_url}}";
    var getDraftTreeForNodeID_url = "{{=getDraftTreeForNodeID_url}}";
    var doTNRSForNames_url = "{{=doTNRSForNames_url}}";
    var getNodeIDForOttolID_url = "{{=getNodeIDForOttolID_url}}";
    var getJSONFromNode_url = "{{=getJSONFromNode_url}}";
    var phylesystem_config_url = "{{=phylesystem_config_url}}";
</script>
<script src="{{=URL('static','js/curation-helpers.js')}}"></script>
<script src="{{=URL('static','js/study-editor.js')}}"></script>

<!-- hidden template for DOI lookups -->
<div class="modal hide fade modal-DOI-lookup" id="DOI-lookup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close"></a>
      <h3 id='dialog-heading'>
         Matching DOIs and references
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Based on the reference text for this study,
            <a href="http://crossref.org/" target="_blank">CrossRef.org</a>
            returned these matching records (best matches first).
        </p>
        <ul class="found-matches"></ul>
    </div>
    <div class="modal-footer">
      <a data-dismiss="modal" class="btn" >Close</a>
    </div>
</div>

<!-- hidden template for gathering comments when saving the study -->
<div class="modal hide fade modal-save-comments" id="save-comments-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close"></a>
      <h3 id='dialog-heading'>
         Add a comment for these changes
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Add a brief description of the work you've done.
            This will appear in the History tab.
        </p>
        <input type="text" id="save-comment-first-line" class="input-block-level" maxlength="50" placeholder="Add a one-line summary (50 chars max)"/>
        <textarea id="save-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-info pull-right" style="margin-left: 20px;" 
              onclick="$('#save-comments-popup').modal('hide'); saveFormDataToStudyJSON(); return false;">Save Study</button>
      <a data-dismiss="modal" class="btn" >Cancel</a>
    </div>
</div>

<!-- hidden template for study-quality details -->
<div class="modal hide fade" id="quality-details-viewer" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close"></a>
      <h3 id='dialog-heading'>
         Study quality scores
      </h3>
    </div>
    <div class="modal-body">
        <div data-bind="css: studyQualityBarClass" style="margin-bottom: 5px;">
          <div class="bar" data-bind="style: { width: studyQualityPercentStyle }">
              <span data-bind="text: studyQualityPercent"></span>%
          </div>
        </div>
        <button class="help-toggle" style="display: none;">
            Show help <i class="icon-chevron-down Xicon-white"></i>
        </button>
        <p>
            Based on the tools currently chosen, this study has an overall score of
            <strong><span data-bind="text: studyQualityPercent"></span>%</strong>
        </p>
        <div class="help-box" style="display: block;">
            <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
            </button>
            <p>
                This score is composed of many different tests in several
                categories. Some of these check for internal consistency and completeness,
                while others are only relevant when using your study data with particular
                applications (listed in the Tools tab).  Here's a breakdown of which tests
                failed and may need attention. Click any category or message below to go to the
                source of the error.
            </p>
        </div>
        <div id="study-quality-details" style="margin-top: 5px;">
            <!-- details for score criteria will appear here -->
        </div>
    </div>
    <div class="modal-footer">
      <a data-dismiss="modal" class="btn" >Close</a>
    </div>
</div>

<!-- hidden template for the tree-viewer (editor) -->
<div class="modal hide fade modal-tree-viewer" id="tree-viewer" style="display: none;">
  <!-- KO binding here to 'tree' (as $data below) -->
    <div class="modal-header">
      <a class="close" onclick="$('#tree-viewer').modal('hide'); false;"></a>
      <h3 id='dialog-heading'>
        {{ if viewOrEdit == 'EDIT': }}
            Edit tree
            <input type="text" style="font-size: inherit; vertical-align: baseline; color: #000; font-weight: bold; width: 50%;"
                   data-bind="value: $data['@label'], 
                              valueUpdate: ['afterkeydown', 'input'], 
                              event: { keyup: nudge.TREES, change: nudge.TREES }
                              "
            />
        {{ else: }}
            View tree
            '<span data-bind="text: $data['@label']">{TREE NAME}</span>'
        {{ pass }}

       </h3>
    </div>
    <div class="modal-body">
        <div id="dialog-data">
         <form class="form-inline" style="border-bottom: 1px solid #eee; overflow: hidden; padding-bottom: 4px;">
          {{ if viewOrEdit == 'EDIT': }}
            <!-- editable tree properties here -->
              <div class="pull-left" style="width: 48%;">
                <label>Inference method: </label>
                <!-- Offer preset inference methods, found in http://en.wikipedia.org/wiki/Bayesian_inference_in_phylogeny --> 
                <select id="inference-method-select"
                        onchange="(this); return false;"
                        data-bind="options: [
                                       'Maximum parsimony ',
                                       'Maximum likelihood ',
                                       'Neighbor-joining ',
                                       'UPGMA ',
                                       'Bayesian inference ',
                                       'Least squares ',
                                       'Three-taxon analysis',
                                       'Other (specify)'
                                   ], 
                                   optionsCaption: 'Choose a method...',
                                   event: { change: updateInferenceMethodWidgets }, 
                                   css: viewModel.ticklers.TREES">
                </select>
                <input type="text" id="inference-method-other" 
                       placeholder="Other (specify)"
                       data-bind="event: { change: updateInferenceMethodWidgets }, 
                                  css: viewModel.ticklers.TREES"></input>
              <br/>
                <label for="testtest">Root node: </label>
                <strong data-bind="text: getRootNodeDescriptionForTree($data), 
                                   css: viewModel.ticklers.TREES"></strong>
              <br/>

                <label>Tree root is </label>
                <label for="tree-root-status-false" class="radio" style="padding-left: 10px;">
                    <input id="tree-root-status-false" type="radio" 
                           name="tree-root-status" value="false" 
                           data-bind="checked: $data['^ot:unrootedTree'].toString(), 
                                      click: toggleTreeRootStatus, 
                                      css: viewModel.ticklers.TREES" />
                    biologically correct
                </label>
                <label for="tree-root-status-true" class="radio" style="padding-left: 10px;">
                    <input id="tree-root-status-true" type="radio" 
                           name="tree-root-status" value="true" 
                           data-bind="checked: $data['^ot:unrootedTree'].toString(), 
                                      click: toggleTreeRootStatus, 
                                      css: viewModel.ticklers.TREES" />
                    arbitrary (for display only)
                </label>

              <br/>
                <label for="testtest">Ingroup clade: </label>
                <strong data-bind="text: getInGroupCladeDescriptionForTree($data), 
                                   css: viewModel.ticklers.TREES"></strong>
              </div>
              <div class="pull-left" style="width: 48%;">
                <label>Mapped leaf nodes: </label>
                <span data-bind="html: getMappedTallyForTree($data), 
                                 css: viewModel.ticklers.TREES">?? / ??</span>
              <br/>

                <label>Tags: </label>
                <select id="tree-tags" multiple="multiple" placeholder="Add tags"
                        onchange="updateElementTags(this);"
                        data-bind="attr: {'treeid': $data['@id'] },
                                   options: getTags( getTreeByID($data['@id']) ), 
                                   event: { keyup: nudge.TREES, change: nudge.TREES }, 
                                   css: viewModel.ticklers.TREES">
                </select>

              <br/>

               <!-- todo: general statement of rooting (tree and ingroup)?
                <label for="testtest">tree rooting: </label>
                <strong data-bind="html: getrooteddescriptionfortree($data)">rooted-value</strong>
              <br/>
               -->

                <label>Branch length mode: </label>
                <select data-bind="options: branchLengthModeDescriptions,
                    optionsValue: function(item) { 
                        return item.value;
                    },
                    optionsText: function(item) { 
                        return item.text;
                    },
                    value: $data['^ot:branchLengthMode'],
                    event: { keyup: nudge.TREES, change: nudge.TREES },
                    optionsCaption: 'Choose...', 
                    css: viewModel.ticklers.TREES
                    ">TYPE</select>

               <!-- ko if: $data['^ot:branchLengthMode'] === 'ot:time' -->
                <label style="margin-left: 10px;">Time unit: </label>
                <select data-bind="options: ['Myr'],
                    value: $data['^ot:branchLengthTimeUnit'],
                    event: { keyup: nudge.TREES, change: nudge.TREES }, 
                    css: viewModel.ticklers.TREES
                    ">TYPE</select>
               <!-- /ko -->

               <!-- ko if: $data['^ot:branchLengthMode'] === 'ot:other' -->
                <label style="margin-left: 10px;">&nbsp;</label>
                <input type="text" data-bind="value: $data['^ot:branchLengthDescription'],
                    valueUpdate: ['afterkeydown', 'input'],
                    event: { keyup: nudge.TREES, change: nudge.TREES },
                    css: viewModel.ticklers.TREES
                " placeholder="Describe here"></input>
               <!-- /ko -->
              </div>
              <div style="clear: left; height: 20px;">&nbsp;</div>
              <div class="help-box">
                  Click any node below to set the ingroup clade. Click any node
                  <strong>or</strong> edge to re-root the entire tree. N.B. An
                  <strong>arbitrary root</strong> (see options above) will only be used to draw
                  the tree and correctly set the ingroup clade. It will not be
                  considered biologically correct.
              </div>

          {{ else: }}
            <!-- read-only tree properties here -->
              <div class="pull-left" style="width: 48%;">
                <label>Tree type: </label>
                <strong data-bind="text: $data['^ot:curatedType'] || 'Unspecified'">TYPE</strong>
              <br/>
                <label for="testtest">Root node: </label>
               <!-- TODO: tag(s) for this tree? -->
                <strong data-bind="text: getRootNodeDescriptionForTree($data)"></strong>
              <br/>
                <label for="arbitrary-tree-root" class="checkbox" style="padding-left: 12px; position: relative; top: -4px;">
                    <strong data-bind="html: getRootedStatusForTree($data)">Tree root is arbitrary (not biologically correct)</strong>
                </label>
              <br/>
                <label for="testtest">Ingroup clade: </label>
                <strong data-bind="text: getInGroupCladeDescriptionForTree($data)"></strong>
              </div>
              <div class="pull-left" style="width: 48%;">
                <label>Mapped leaf nodes: </label>
                <span data-bind="html: getMappedTallyForTree($data)">?? / ??</span>
              <br/>

                <label>Tags: </label>
                <!-- TODO: make all tags clickable (search in new window?) -->
                <div id="tree-tags" class="bootstrap-tagsinput" 
                     style="display: inline-block; border: none; margin-bottom: 0; padding: 0 0 4px 0;"
                     data-bind="attr: {'treeid': $data['@id'] },
                                visible: getTags(getTreeByID($data['@id'])).length > 0">
                <!-- ko foreach: getTags( getTreeByID($data['@id']) ) -->
                    <span class="tag label label-info" data-bind="text: $data">TAG</span>
                <!-- /ko -->
                </div>
                <strong data-bind="visible: getTags(getTreeByID($data['@id'])).length === 0">
                   <em>None</em>
                </strong>
              <br/>

               <!-- TODO: General statement of rooting (tree and ingroup)?
                <label for="testtest">Tree rooting: </label>
                <strong data-bind="html: getRootedDescriptionForTree($data)">ROOTED-VALUE</strong>
              <br/>
               -->

                <label>Branch length mode: </label>
                <strong data-bind="text: getBranchLengthModeDescriptionForTree($data)">TYPE</strong>
              </div>

          {{ pass }}
         </form>
         <!-- tree-view SVG goes here -->
        </div>
    </div>
    <div class="modal-footer">
      <div class="popup-legend pull-left form-inline">
          <strong>Legend: </strong>
          <label style="margin-left: 20px;">Outgroup: </label> 
          <img src="{{=URL('static','images/tree-viewer-legend-outgroup.png')}}" alt="outgroup style" />

          <label style="margin-left: 20px;">Ingroup: </label>
          <img src="{{=URL('static','images/tree-viewer-legend-ingroup.png')}}" alt="ingroup style" />

          <label class="checkbox" style="margin-left: 25px;" for="branch-length-toggle"> 
              <input type="checkbox" id="branch-length-toggle"
                     onclick="toggleBranchLengthsInViewer(this); return true;" />
              Cladogram (hide branch lengths)
          </label>
      </div>
      <a class="btn" onclick="$('#tree-viewer').modal('hide'); false;">Close</a>
      <!-- <a class="btn btn-primary" id="btnSaveChanges">Save changes</a> -->
    </div>
</div>
