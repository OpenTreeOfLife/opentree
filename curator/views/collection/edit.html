{{# Pivot (in many places) based on whether the user is an editor (curator) or
# someone else looking at the tree collection
#
# userCanEdit = True if the user is authorized to edit this collection
# viewOrEdit  = the function of this page ('EDIT' or 'VIEW'), regardless of
#               user's permissions

response.title = (viewOrEdit == 'EDIT') and "Edit Tree Collection" or "View Tree Collection"
}}

{{# Pivot (in some places) based on whether the user is a logged-in user or
  # a visitor browsing tree collections.
isLoggedIn = (auth.user) and True or False
}}

{{left_sidebar_enabled,right_sidebar_enabled=False,False}}
{{response.subtitle = "loading collection %s..." % request.args[0]}}
{{# TODO: make this sure shows the full collection ID! }}

{{### Add support scripts for single-page editor

# JSON support for older browsers (esp. IE7)
response.files.append(URL('static','js/json2.js'))

# Knockout.js for binding JSON model to editing UI
response.files.append(URL('static','js/knockout-2.3.0.js'))

# KO plugin for paginated lists
response.files.append(URL('static','js/knockout-paged-e4a5770702.js'))

# Knockout bindings for Twitter Bootstrap components
response.files.append(URL('static','js/knockout-bootstrap.min.js'))

# TODO: remove if not used
# jQuery-File-Upload plugin and supporting files (TODO)
# minimal support for $.widget()
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/vendor/jquery.ui.widget.js'))
# Iframe Transport is required for browsers without support for XHR file uploads
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/jquery.iframe-transport.js'))
response.files.append(URL('static','jQuery-File-Upload-9.5.2/js/jquery.fileupload.js'))
response.files.append(URL('static','jQuery-File-Upload-9.5.2/css/jquery.fileupload.css'))
}}
{{extend 'layout.html'}}

<style id="tree-view-style" type="text/css">
body {
    overflow-y: scroll;
}

</style>

<div class="row">
 <div class="span12">
  <div class="tabbable tabs">
    <ul class="nav nav-tabs">
      <li><a href="#Home" data-toggle="tab">Home <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#Change-History" data-toggle="tab">Change History <span class="badge badge-important" style="display: none;">?</span></a></li>
      <li><a href="#Synthesis-History" data-toggle="tab">Synthesis History <span class="badge badge-important" style="display: none;">?</span></a></li>
    </ul>

    <div class="span4" style="float: right; margin-top: -56px;">
        {{ if viewOrEdit == 'EDIT': }}
        {{# TODO: revisit these buttons }}
          <button id="save-collection-button" class="btn">Save Collection</button>
          <input type="hidden" id="return-to-collection-list"
                 value="{{= URL(a='curator', c='default', f='index')}}">
          <a id="cancel-collection-edits" class="btn btn-link" href="#">Cancel</a>
          <button class="btn btn-danger pull-right"
            onclick="promptForDeleteComments(); return false;">Delete Collection</button>
        {{ else: }}
          <a class="btn" href="{{= URL(a='curator', c='default', f='index')}}">Return to collection list</a>
         {{ if userCanEdit: }}
          <a class="btn btn-info pull-right sticky-login" href="{{=URL('collection', 'edit/'+ collectionID)}}"
           {{ if maintenance_info.get('maintenance_in_progress', False): }}
            onclick="showMaintenancePopup(); return false;"
           {{ else: }}
            onclick="return confirm('Are you sure you want to edit this collection?');"
           {{ pass }}
          >Edit Collection</a>
         {{ else: }}
          <a class="btn btn-info pull-right sticky-login" href="{{=URL('collection', 'edit/'+ collectionID)}}"
           {{ if maintenance_info.get('maintenance_in_progress', False): }}
            onclick="showMaintenancePopup(); return false;"
           {{ else: }}
            onclick="return confirm('Are you sure you want to edit this collection?');"
           {{ pass }}
          >Login to Edit Collection</a>
         {{ pass }}
        {{ pass }}
    </div>
  </div>
 </div>
</div>
<div class="row">
    <div class="span12">
       {{if 'message' in globals():}}
        <h4>{{=message}}</h4>
       {{pass}}
    </div>
</div><!-- /.row -->

<div class="row">
    <div class="tab-content">

          <div class="tab-pane" id="Home">
           <div class="span8"><!-- main column -->

            <!-- read-only display of core metadata -->
            <div id="core-metadata-pane">
              <p data-bind="visible: viewModel.ticklers.GENERAL_METADATA(), text: nexml['^ot:studyPublicationReference']"></p>
              <div class="control-group">
                 {{ if viewOrEdit == 'EDIT': }}
                  <button id="full-metadata-button" class="btn btn-small pull-right"
                          onclick="showCollectionMetadata(); return false;">Edit study metadata</button>
                 {{ else: }}
                  <button id="full-metadata-button" class="btn btn-small pull-right"
                          onclick="showCollectionMetadata(); return false;">See all study metadata</button>
                 {{ pass }}
               |
               <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && getNormalizedDataDepositURL() !== '' -->
                <a href="" target="_blank"
                   data-bind="visible: viewModel.ticklers.GENERAL_METADATA(), attr: {'href': getNormalizedDataDepositURL()}">Link to data package</a>
               <!-- /ko -->
               <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && getNormalizedDataDepositURL() === '' -->
                <span style="color: #999; text-decoration: line-through;">No link to data package</span>
               <!-- /ko -->

              </div>
              <!-- render any existing curator notes as HTML (else hide)-->
              <div data-bind="visible: viewModel.ticklers.GENERAL_METADATA() && $.trim(viewModel.nexml['^ot:comment']) !== ''">
                <strong>Curator notes: </strong>
                <div class="rendered-comment"
                     data-bind="visible: viewModel.ticklers.GENERAL_METADATA(), html: viewModel['commentHTML']" >
                   {comments appear here}
                </div>
              </div>
            </div>


  <div Xclass="modal hide fade" style="border: solid red 1px;" id="tree-collection-viewer">
   <!-- TODO: KO binding here to 'collection' (as $data below) -->
    <div class="modal-header" style="padding-bottom: 0;">
      <a class="close" onclick="$('#tree-collection-viewer').modal('hide'); return false;">Ã—</a>
      <h3 id='dialog-heading'>
            <span style="color: #999;">Tree collection</span>
           <!-- ko if: userIsEditingCollection($data) -->
            <input type="text" style="font-size: inherit; vertical-align: baseline; color: #000;
                                      font-weight: bold; width: 50%; margin-bottom: 0px;"
                   data-bind="value: $data.data['name'],
                              valueUpdate: ['afterkeydown', 'input'],
                              event: { keyup: updateNewCollectionID, change: updateNewCollectionID }
                              "
            />
           <!-- /ko -->
           <!-- ko if: !userIsEditingCollection($data) -->
             <span data-bind="html: $data.data['name'] || 'Untitled'"></span>
           <!-- /ko -->
      </h3>
      <div style="color: #999; position: relative;">
        <p style="position: absolute; width: 170px; text-align: right;">
            Collection ID (direct link):
        </p>
        <p style="margin-left: 180px;">
            <a id="collection-id-display"
               data-bind="text: getCollectionIDFromURL($data.data.url),
                          attr: { href: getCollectionDirectURL($data) }">&nbsp;</a>
        </p>
      </div>
    </div>
    <div class="modal-body" style="max-height: none;">
      <div class="tab-pane active">
          <form class="form-inline"
                style="overflow: hidden; margin-bottom: 0px; margin-top: -12px; padding-top: 12px; margin-right: -6px;">
           <div class="collection-actions" style="padding-right: 8px;">
            <!-- action buttons, from right to left -->

           <!-- ko if: userIsEditingCollection($data) -->
            <!-- DELETE button (for now, this only appears in the My Collections list)
            <button data-bind="click: promptForDeleteCollectionComments,
                               visible: true"
                title="Delete this tree collection"
                class="pull-right btn btn-mini btn-danger row-controls-ghosted"
                style="margin-left: 14px;">
                Delete <i class="icon-trash icon-white"></i>
            </button>
            -->
           <!-- /ko -->

           <!-- ko if: ('external_url' in $data) -->
            <!-- HISTORY button -->
            <a data-bind="attr: { href: getCollectionHistoryURL($data) }"
               title="See full version history on GitHub"
               class="pull-right btn btn-mini row-controls-ghosted"
               style="margin-left: 4px;"
               href="#" target="_blank">
               History
               <img src="/curator/static/images/GitHub-Mark-32px.png"
                    style="width: 14px; height: 14px; padding-left: 2px; margin-top: -2px;"/>
            </a>
           <!-- /ko -->

           <!-- ko if: !userIsEditingCollection($data) -->
            <!-- SHARE button -->
            <button data-bind="click: shareCollection,
                               visible: true"
                title="Show the direct URL for this collection"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Share <i class="icon-share"></i>
            </button>

           <!-- ko if: ('external_url' in $data) -->
            <!-- DOWNLOAD button -->
            <a data-bind="attr: { href: $data['external_url'] }"
               title="Download this collection as JSON"
               class="pull-right btn btn-mini row-controls-ghosted"
               style="margin-left: 4px;"
               href="#" target="_blank">
               Download <i class="icon-download"></i>
            </a>
           <!-- /ko -->

            <!-- SYNTHESIS REPORT button (TODO?)
            <button Xdata-bind="click: TODO-follow-this-collection,
                                visible: true"
                title="(PROPOSED) View synthesis report for this collection"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px; opacity: 0.5;">
                <i class="icon-list-alt"></i>
            </button>
            -->

            <!-- DUPLICATE button -->
            <button data-bind="click: copyCollection,
                                visible: true,
                                attr: {'title': userIsLoggedIn() ? 'Copy this collection (you will own the copy)' : 'Copy this collection (requires login)'}"
                title=""
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Save a copy <i class="icon-repeat"></i>
            </button>
           <!-- /ko -->

            <!-- EDIT button -->
            <button data-bind="click: editCollection,
                               visible: !(userIsEditingCollection($data)),
                               attr: {'title': userIsLoggedIn() ? 'Edit collection, including add/remove trees' : 'Edit collection (requires login)'}"
                title=""
                class="pull-right btn btn-info btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Edit <i class="icon-edit icon-white"></i>
            </button>
            <button data-bind="click: cancelChangesToCollection,
                               visible: userIsEditingCollection($data)"
                title="Cancel your changes to this collection"
                class="pull-right btn btn-warning btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Cancel
            </button>
            <button data-bind="click: promptForSaveCollectionComments,
                               visible: userIsEditingCollection($data)"
                title="Save your changes to this collection"
                class="pull-right btn btn-info btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Save Changes
            </button>
            <button data-bind="click: updateCollectionTrees,
                               visible: userIsEditingCollection($data)"
                title="Use latest tree labels, detect removed trees"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Update trees <i class="icon-refresh"></i>
            </button>

           </div>

            <!-- editable collection properties here -->

                <label>Description</label>
              <!-- ko if: userIsEditingCollection($data) -->
                <input type="text"
                    class="input-xlarge" style="width: 500px; margin-bottom: 2px;"
                    placeholder="Describe this collection's focus or purpose"
                    data-bind="value: $data.data['description'],
                               valueUpdate: ['afterkeydown', 'input']
                               "
                ></input>
              <!-- /ko -->
              <!-- ko if: !userIsEditingCollection($data) -->
                <div style="background-color: #eee; width: 500px;
                            margin: 0px 0px 2px -1px;
                            border-radius: 4px; padding: 5px 8px;"
                     data-bind="html: $data.data['description'] || '&nbsp;'"
                ></div>
              <!-- /ko -->

                <label style="clear: left; margin-top: 6px;">Created by </label>
                <strong><a href="https://github.com/jimallman" target="_blank"
                           data-bind="text: $data.data.creator['name'],
                                      attr: {
                                        href: ('https://github.com/'+ $data.data.creator['login'])
                                      }
                                      "
                        >&nbsp;</a></strong>, with
              <!-- list collaborators (links) in a popup -->
              <div id="collection-collab-toggle" Xclass="btn-group"
                   style="display: inline-block; position: relative;">
                <strong id="collection-collab-toggle" class="dropdown-toggle"
                        style="cursor: pointer;"
                        data-toggle="dropdown">
                    <span data-bind="text: $data.data.contributors.length">0</span>
                    collaborator<span data-bind="if: $data.data.contributors.length != 1">s</span>
                   <span class="caret" style="vertical-align: middle;"></span>
                </strong>
                <ul id="tree-collection-contributors" class="dropdown-menu"
                    data-bind="foreach: { data: $data.data.contributors, as: 'contributor' }">
                    <li>
                        <a target="_blank"
                           data-bind="text: contributor['name'],
                                      attr: {
                                        href: ('https://github.com/'+ contributor['login'])
                                      }
                                      "
                        >&nbsp;</a>
                    </li>
                </ul>
              </div>

                <!-- let's keep it simple for now
                <div class="btn-group" style="margin-left: 80px; margin-top: 6px;">
                  <button id="show-included-trees-button" class="btn btn-small active" onclick="alert('COMING SOON'); return false;">&nbsp; Show only included trees &nbsp;</button>
                  <button id="show-all-trees-button" class="btn btn-small" onclick="alert('COMING SOON'); return false;">&nbsp; Show all tree decisions &nbsp;</button>
                </div>
                -->
              <div id="tree-list-holder"
                   style="overflow: auto;">
      <!-- ko if: ('decisions' in $data.data) && ($data.data.decisions.length > 0) -->
                <table id="tree-collection-decision-holder"
                       class="table table-condensed table-hover"
                       style="margin-bottom: 2px; position: relative;"
                       data-bind="visible: true"><!-- TODO: hide if no trees found -->
                  <thead>
                    <tr>
                        <th width="76">Rank</th><!-- ranking -->
                        <th width="*">
                          <!-- ko if: userIsEditingCollection($data) -->
                            Tree
                          <!-- /ko -->
                          <!-- ko if: !userIsEditingCollection($data) -->
                            Tree (click to view, mouse-over for description)
                          <!-- /ko -->
                        </th>
                    </tr>
                  </thead>
                  <tbody id="tree-collection-decisions"
                         data-bind="foreach: { data: $data.data.decisions }">
                      <tr data-bind="attr: { class: (userIsEditingCollection($parent) && $data['status'] == 'REMOVED') ?
                                                      'single-tree-row error' :
                                                      (userIsEditingCollection($parent) && $data['status'] == 'RENAMED' ?
                                                        'single-tree-row warning' :
                                                        'single-tree-row-'+ $data['status'] )
                                            }">
                          <td>
                          <!-- ko if: userIsEditingCollection($parent) -->
                            <input type="text"
                                   data-bind="value: $data['rank'],
                                              valueUpdate: ['afterkeydown', 'input'],
                                              event: {
                        keyup: function() {showCollectionMoveUI($data, $element, $parent)},
                        change: function() {showCollectionMoveUI($data, $element, $parent)}
                                              }"
                                   style="color: #999; width: 24px;
                                          margin-left: -4px; text-align: right;"
                                   value=""
                             />&nbsp;
                           <!-- SORTING widgets -->

                           <!-- ko if: $index() === 0 -->
                            <a style="opacity: 0.5;"
                               href="#"
                               onclick="return false;"
                               class="icon-chevron-up">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $index() > 0 -->
                            <a data-bind="click: function() {moveInTreeCollection($data, $parent, 'UP'); return false;}"
                               href="#"
                               title="Move this tree up in the list"
                               class="icon-chevron-up">
                            </a>
                           <!-- /ko -->

                           <!-- ko if: $index() === ($parent.data.decisions.length-1) -->
                            <a style="opacity: 0.5;"
                               href="#"
                               onclick="return false;"
                               class="icon-chevron-down">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $index() < ($parent.data.decisions.length-1) -->
                            <a data-bind="click: function() {moveInTreeCollection($data, $parent, 'DOWN'); return false;}"
                               href="#"
                               title="Move this tree down in the list"
                               class="icon-chevron-down">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $data['status'] == 'REMOVED' -->
                             <div class="tree-status-marker text-error">REMOVED</div>
                           <!-- /ko -->
                           <!-- ko if: $data['status'] == 'RENAMED' -->
                             <div class="tree-status-marker text-warning">RENAMED</div>
                           <!-- /ko -->

                          <!-- /ko --><!-- END of editing widgets -->
                          <!-- ko if: !userIsEditingCollection($parent) -->
                          <div data-bind="text: $data['rank']"
                               style="text-align: right; width: 27px; margin-top: 5px;">XX</div>
                          <!-- /ko -->

                          </td>
                          <td>
<!--
                              <button Xdata-bind="click: TODO-follow-this-collection,
                                                  visible: true"
                                  title="Edit name and description (become a collaborator)"
                                  class="pull-right btn btn-mini row-controls-ghosted"
                                  style="margin-left: 4px;">
                                  <i class="icon-edit"></i>
                              </button>
-->
                            <!-- ko if: userIsEditingCollection($parent) -->
                              <button data-bind="click: function() {removeTreeFromCollection($data, $parent); return false;}"
                                      title="Remove this tree from the collection"
                                      class="pull-right btn btn-mini btn-danger row-controls-ghosted"
                                      style="margin-left: 4px;">
                                  <i class="icon-trash icon-white"></i>
                              </button>
                              <a data-bind="html: name,
                                            attr: { href: getTreeViewURL($data) }"
                                 title="View this tree in a new window"
                                 href="#" target="_blank"><!--NAME--></a>
                             <!-- this is no longer editable
                              <input type="text"
                                     class="input-large"
                                     style="width: 320px; margin-right: 10px; margin-bottom: 2px;"
                                     placeholder="Name this tree"
                                     data-bind="value: name,
                                                valueUpdate: ['afterkeydown', 'input']
                                                "
                              >
                              </input>
                              -->
                              <br/>
                              <textarea data-bind="value: comments"
                                        style="width: 380px; color: #333; margin-bottom: 4px; height: 2em;"
                                        placeholder="Describe your reasons for including this tree">
                                <!--COMMENTS--></textarea>
                            <!-- /ko -->
                            <!-- ko if: !userIsEditingCollection($parent) -->
                              <a data-bind="html: name,
                                            attr: { href: getTreeViewURL($data), title: comments || '(no description provided)' }"
                                 href="#" target="_blank"><!--NAME--></a>
                            <!-- /ko -->
                          </td>
                      </tr>
                  </tbody>
                </table>
      <!-- /ko -->
      <!-- ko if: !('decisions' in $data.data) || ($data.data.decisions.length === 0) -->
                <div class="empty-list-prompt" style="margin-bottom: 4px;">
              <!-- ko if: userIsEditingCollection($data) -->
                    This collection is empty! Add trees using the buttons below, or
                    by visiting trees in the curation app.
              <!-- /ko -->
              <!-- ko if: !userIsEditingCollection($data) -->
                    This collection is empty! Add trees by clicking Edit above, or
                    by visiting trees in the curation app.
              <!-- /ko -->
                </div>
      <!-- /ko -->
              </div><!-- /#tree-list-holder -->

          <!-- ko if: userIsEditingCollection($data) -->
            <!-- TODO: Put add-collection widgets! -->
            <div xclass="form-actions" style="margin-top: 0px; margin-bottom: 0.25em;">
              <button id="new-collection-tree-start" type="submit"
                      class="btn btn-info Xbtn-info-disabled"
                      onclick="return false;"
              ><span data-bind="text: ($data.data.decisions.length > 0) ? 'Add another tree' : 'Add a tree to this collection'">ADD TREE</span>
                    &nbsp;<i class="icon-plus Xicon-upload icon-white"></i>
              </button>
              <button id="new-collection-tree-cancel" type="submit"
                      style="display: none;" class="btn">Cancel
              </button>
            </div>
            <div id="new-collection-tree-by-lookup"
                 class="new-collection-tree-options" style="display: none; padding-left: 12px;">
                <div class="dropup" style="position: relative; margin-left: 146px;">
                    <ul id="study-lookup-results" class="dropdown-menu" role="menu">
                        ...
                    </ul>
                </div>
                <label>&hellip; by matching a study</label>
                <!-- "active" wiget for study lookup -->
                <i class="icon-search study-lookup-active" style="position: absolute; margin: 8px 0 0 7px; pointer-events: none;"></i>
                <input type="text" name="study-lookup"
                    class="input-xlarge study-lookup-active" style="margin-bottom: 2px; padding-left: 25px;"
                    placeholder="Enter its title, DOI, reference, tag, ID..."
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                ></input>
                <!-- hidden field to store chosen ID -->
                <input type="hidden" name="study-lookup-id"
                       data-bind="value: '',
                                  event: { change: updateNewCollTreeUI }
                                 "></input>
                <!-- "passive" wiget once study is chosen -->
                <a class="btn btn-small study-lookup-passive" style="display: none; margin: 3px 0 3px;"
                   onclick="resetStudyLookup(); return false;">
                    <i class="icon-search"></i>
                </a>
                <a id="study-lookup-indicator" class="study-lookup-passive"
                   style="font-weight: bold; display: none;"
                   title="" href="" target="_blank">...</a>
                <br />

                <label style="padding-left: 4em;">and one of its trees</label>
                <select name="tree-lookup"
                    class="input-xlarge" style="margin-bottom: 2px;"
                    disabled="disabled"
                    placeholder="Enter its name, ID, ingroup clade..."
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                >
                    <option disabled="disabled" value="">Find the study above first</option>
                </select>
                <button class="btn btn-info"
                        data-bind="click: function() {addTreeToCollection($data, 'FROM_LOOKUPS'); return false;}"
                >
                      <i class="icon-plus icon-white"></i>
                </button>
            </div>
            <div id="new-collection-tree-by-url"
                 class="new-collection-tree-options" style="display: none; padding-left: 12px;">
                <label>&hellip; by URL</label>
                <input type="text"  name="tree-url"
                    class="input-xlarge" style="width: 385px; margin-bottom: 2px;"
                    placeholder=".../curator/study/view/pg_2826/?tab=trees&tree=tree6573"
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                ></input>
                <button class="btn btn-info"
                        data-bind="click: function() {addTreeToCollection($data, 'FROM_URL'); return false;}"
                >
                      <i class="icon-plus icon-white"></i>
                </button>
            </div>
          <!-- /ko -->

            </form>
          </div>
    </div><!-- end of .modal-body -->
    <div class="modal-footer" style="padding: 5px;"><!-- nothing here! --></div>
  </div><!-- end of #tree-collection-viewer.modal- -->

            <div style="margin-bottom: 100px; clear: right; padding-top: 1em;">
              <div class="navbar">
               <div class="navbar-inner">
                <form class="navbar-search pull-left">
                    <h4 class="pull-left" style="margin: 5px 1em 0 0">Trees in this collection</h4>
                    <input type="text" id="tree-list-filter" class="search-query" placeholder="Filter by name or ingroup clade"
                           data-bind="value: viewModel.listFilters.TREES.match, valueUpdate: ['afterkeydown', 'input']">
                </form>
               </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredTrees().pagedItems().length === 0">
                    No matching trees found! Add new trees or clear the
                    filter above to see trees in this collection.
                </div>

                <table class="table table-condensed table-hover"
                    data-bind="visible: viewModel.filteredTrees().pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                      {{ if viewOrEdit == 'EDIT': }}
                        <th>Tree name (click to edit tree)</th>
                        <th colspan="2">Included in synthesis?</th>
                      {{ else: }}
                        <th>Tree name (click to view)</th>
                        <th>Synthesis status</th>
                      {{ pass }}
                        <th>Inference method</th>
                        <th>Ingroup clade</th>
                        <th>Tree root</th>
                        <th>OTUs mapped</th>
                      {{ if viewOrEdit == 'EDIT': }}
                        <th>&nbsp;</th>
                      {{ pass }}
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredTrees().pagedItems(), as: 'tree' }">
                    <tr data-bind="if: true">
                        <td>
                            <a href="#" data-bind="click: showTreeWithHistory,
                                text: tree['@label'],
                                attr: { href : getViewURLFromStudyID(collectionID) + '/?tab=trees&tree=' + tree['@id'] },
                                css: viewModel.ticklers.TREES">&nbsp;</a>
                            <br/>
                            <a data-bind="if: unresolvedDuplicatesFoundInTree( tree ),
                                          css: viewModel.ticklers.TREES,
                                          click: showDuplicateNodesInTreeViewer,
                                          visible: true"
                               class="suggestion-prompt" style="display: none;"
                               href="#">
                                Show duplicate tips
                            </a>
                            <br/>
                            <a data-bind="if: ambiguousLabelsFoundInTree( tree ),
                                          css: viewModel.ticklers.TREES,
                                          click: showAmbiguousLabelsInTreeViewer,
                                          visible: true"
                               class="suggestion-prompt" style="display: none;"
                               href="#">
                                Review ambiguous labels
                            </a>
                        </td>
                      {{ if viewOrEdit == 'EDIT': }}
                        <td>
                            <span data-bind="text: getSynthStatusDescriptionForTree($data),
                                             css: viewModel.ticklers.TREES"></span>
                            <a class="badge" href="#" style="padding: 2px 6px;"
                               title="Click to see details about this tree in synthesis"
                               data-bind="text: (tree['^ot:reasonsToExcludeFromSynthesis'].length > 0)? (tree['^ot:reasonsToExcludeFromSynthesis'].length) : '?',
                                          css: (tree['^ot:reasonsToExcludeFromSynthesis'].length > 0 ? 'badge badge-warning' : 'badge badge-info') +' '+ viewModel.ticklers.TREES(),
                                          click: showTreeSynthDetailsPopup">?</a>
                        </td>
                        <td>
                            <div style="white-space: nowrap;">
                              <a class="btn btn-mini btn-success row-controls-ghosted"
                                 data-bind="attr: {disabled: !(testForPossibleTreeInclusion($data))},
                                            css: viewModel.ticklers.TREES,
                                            click: tryToIncludeTreeInSynth">Include</a>
                              <a class="btn btn-mini btn-danger row-controls-ghosted"
                                 data-bind="attr: {disabled: !(testForPossibleTreeExclusion($data))},
                                            css: viewModel.ticklers.TREES,
                                            click: tryToExcludeTreeFromSynth">Exclude</a>
                            </div>
                        </td>
                      {{ else: }}
                        <td>
                          <div style="white-space: nowrap;">
                              <span data-bind="text: getSynthStatusDescriptionForTree($data),
                                               css: viewModel.ticklers.TREES"></span>
                              <a class="badge" href="#" style="padding: 2px 6px;"
                                 data-bind="text: (tree['^ot:reasonsToExcludeFromSynthesis'].length > 0)? (tree['^ot:reasonsToExcludeFromSynthesis'].length) : '?',
                                            css: (tree['^ot:reasonsToExcludeFromSynthesis'].length > 0 ? 'badge badge-warning' : 'badge badge-info') +' '+ viewModel.ticklers.TREES(),
                                            click: showTreeSynthDetailsPopup">?</a>
                          </div>
                        </td>
                      {{ pass }}
                        <td data-bind="text: tree['^ot:curatedType'] || 'Unspecified',
                                css: viewModel.ticklers.TREES">&nbsp;</td>
                        <td data-bind="text: getInGroupCladeDescriptionForTree(tree),
                                css: viewModel.ticklers.TREES">&nbsp;</td>
                        <td data-bind="html: getRootedDescriptionForTree(tree),
                                       click: showArbitraryRootExplanationInTreeViewer,
                                       css: viewModel.ticklers.TREES"
                               style="cursor: pointer;">&nbsp;</td>
                        <td data-bind="html: getMappedTallyForTree(tree),
                                css: viewModel.ticklers.TREES">&nbsp;</td>
                      {{ if viewOrEdit == 'EDIT': }}
                        <td>
                            <button data-bind="click: removeTree,
                                               visible: true"
                                class="pull-right btn btn-mini btn-danger row-controls-ghosted"
                                title="Click to delete this tree from the collection"
                                style="display: none;">
                                <i class="icon-trash icon-white"></i>
                            </button>
                        </td>
                      {{ pass }}
                    </tr>
                  </tbody>
                <!-- EXAMPLES of tree-table entries
                    <tr>
                        <td><a href="#">Parsimony tree (urchins)</a></td>
                        <td>Parsimony</td>
                        <td>92/108</td>
                        <td><input type="checkbox" checked="checked" /></td>
                    </tr>
                    <tr>
                        <td><a href="#">Alternate weighting</a></td>
                        <td>Parsimony</td>
                        <td>23/45</td>
                        <td><input type="checkbox" /></td>
                    </tr>
                    <tr>
                        <td><a href="#">Draft tree</a></td>
                        <td>Equally weighted</td>
                        <td>14/20</td>
                        <td><input type="checkbox" /></td>
                    </tr>
                -->
                </table>

                <div class="pagination pagination-centered pagination-small"
                     Xdata-bind="if: viewModel.filteredTrees()().length &gt; viewModel.filteredTrees().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredTrees().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredTrees().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredTrees() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredTrees() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredTrees().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredTrees().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredTrees() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredTrees().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredTrees().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredTrees().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                Each tab in this tool manages a different aspect of the
                collection data. Prompts&mdash;they look like
                <span class="badge badge-important" style="">2</span>&mdash;identify
                aspects that are incomplete.
              </p>
              <p>
                The <strong>Home</strong> tab shows metadata and lists the
                phylogenetic trees in the current collection. Metadata is
                information that identifies this collection and makes it easy to
                find, such as standard publication references, DOIs, and
                free-form tags. You can also add curator notes that will appear
                on this tab.
              </p>
        {{ if viewOrEdit == 'EDIT': }}
              <p>
                See <strong>Add a tree to this collection</strong>, below, to add
                new trees from a file or pasted text. To nominate a tree for
                inclusion in synthesis, click its <strong>Include</strong> 
                button after clearing (or acknowledging) any objections.
                Nominated trees will undergo validation, generating warnings
                for full OTU mapping and other quality checks.
              </p>
              <p>
                Click on the name of a tree to open the editor, where you can
                re-root the tree, define an ingroup clade, and add metadata.
              </p>
        {{ else: }}
              <p>
                Trees with a synthesis status of <strong>Included</strong>
                or <strong>Queued</strong> have been nominated for inclusion
                in synthesis, generally because they best represent the
                conclusions of the study. Inclusion in synthesis also requires
                that trees be rooted correctly and have OTUs mapped.
              </p>
              <p>
                Click on a tree name to view the tree and get more information.
              </p>
        {{ pass }}
            </div>

            <div class="well" style="clear: right;">
                <h4 style="margin-top: 0;">Download</h4>

                <p>
                You can download this collection as JSON
                </p>
                <div class="btn-group" style="position: relative; top: -5px; margin-bottom: 10px;">
                    <a class="btn btn-small" href="{{= API_load_collection_GET_url.replace('{COLLECTION_ID}', collectionID) + '.json' }}" target="_blank">JSON</a>
                </div>

                <p>
                You can also use the <strong>
                <a href="https://github.com/OpenTreeOfLife/germinator/wiki/Open-Tree-of-Life-Web-APIs" target="_blank">Open Tree API</a></strong> to retrieve collection data.
                </p>

            </div>

        {{ if viewOrEdit == 'EDIT': }}
            <div class="well" style="clear: right;">
                <h4 style="margin-top: 0;">Add a tree to this collection</h4>

                <p class="interesting-value" style="line-height: 1.25em; display: none;"
                   data-bind="style: {'display': getDataDepositMessage() === '' ? 'none':'block'}">
                    <span data-bind="html: getDataDepositMessage()">&nbsp;</span>.
                    Trees added here should already be present in the data deposit for this study.
                </p>

                <form id="tree-import-form"
                      style="margin: 0;"
                      Xaction="{{= URL(a='curator', c='default', f='to_nexson')}}"
                      action="/curator/default/to_nexson"
                      method="POST"
                      onsubmit="submitNewTree(this); return false;"
                      Xonsubmit="console.log('DEFAULT tree-import-form submit (suppressed)'); return false;">
                 <fieldset>
                 <input type="hidden" name="output" value="ot:nexson">
                 <input type="hidden" name="author_name"
                   value="{{= auth.user and auth.user.name or 'ANONYMOUS' }}">
                 <input type="hidden" name="author_email"
                   value="{{= auth.user and auth.user.email or 'ANONYMOUS' }}">
                 <input type="hidden" name="auth_token"
                   value="{{= auth.user and auth.user.github_auth_token or 'ANONYMOUS'}}">
                 <!--@MTH:"no longer needed on upload" input type="hidden" name="uploadid" value=""-->
                 <!-- hints for new element IDs -->
                 <input type="hidden" name="idPrefix" value="">
                 <input type="hidden" name="firstAvailableEdgeID" value="">
                 <input type="hidden" name="firstAvailableNodeID" value="">
                 <input type="hidden" name="firstAvailableOTUID" value="">
                 <input type="hidden" name="firstAvailableOTUsID" value="">
                 <input type="hidden" name="firstAvailableTreeID" value="">
                 <input type="hidden" name="firstAvailableTreesID" value="">
                 <input type="hidden" name="firstAvailableAnnotationID" value="">
                 <input type="hidden" name="firstAvailableAgentID" value="">
                 <input type="hidden" name="firstAvailableMessageID" value="">

                  <select id="tree-import-format" name="inputFormat"
                          class="input-block-level"
                          style="margin-bottom: 1em;"
                          oninput="updateNewTreeUploadForm(); return true;"
                          onchange="updateNewTreeUploadForm(); return true;">
                      <option value="" selected="selected">What is the format of this tree?</option>
                      <option value="nexus">NEXUS</option>
                      <option value="newick">Newick</option>
                      <option value="nexml">NeXML</option>
                  </select>
                  <label for="new-tree-text">Paste tree data (text)&hellip;</label>
                  <textarea id="new-tree-text" name="content" rows="5"
                            class="input-block-level"
                            onkeyup="updateNewTreeUploadForm(); return true;"
                            oninput="updateNewTreeUploadForm(); return true;"
                            onchange="updateNewTreeUploadForm(); return true;"
                            ></textarea>

                  <label for="treeupload">&hellip;or upload a tree file</label>


                <div>
                    <span class="btn fileinput-button">
                        <i class="glyphicon glyphicon-plus"></i>
                        <span>Select file to upload...</span>
                        <!-- The file input field used as target for the file upload widget -->
                        <input id="treeupload"
                               type="file" name="file"
                               onchange="$('#upload-tree-info').html( filenameFromFakePath($(this).val()) ); updateNewTreeUploadForm(); return true;">
                    </span>
                    &nbsp;
                    <span class='label label-info' id="upload-tree-info"></span>
                </div>
                <div id="tree-upload-progress" class="progress progress-info"
                     style="margin-top: 0.3em; margin-bottom: 1em; background-color: #333;">
                  <div class="bar" style="text-align: center; width: 0%;">
                      <span>&nbsp;</span>
                  </div>
                </div>

<!-- TODO: Enter a URL or DOI for the new tree?
                  <label for="new-tree-URL">&hellip;or paste an URL to the tree</label>
                  <input type="text" id="new-tree-URL" class="input-block-level" value="" placeholder="Paste URL here">
-->

                  <div Xclass="form-actions" style="margin-top: 1em;">
                      <button name="new-tree-submit" type="submit"
                          class="btn btn-info btn-info-disabled"
                          disabled="disabled">Add new tree
                        <i class="icon-circle-arrow-up Xicon-arrow-up Xicon-chevron-up Xicon-plusXicon-upload icon-white"></i></button>
                      <button type="reset" class="btn"
                              onclick="clearNewTreeUploadWidget(); return true;"
                      >Clear form</button>
                  </div>
                 </fieldset>
                </form>
            </div>
        {{ pass }}


           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="OTU-Mapping">
           <div class="span8"><!-- main column... -->
            <ul class="suggestion-list"></ul>
            <div style="margin-bottom: 100px;">

              <div class="navbar">
               <div class="navbar-inner">
                <form class="navbar-search pull-left">
                    <input type="text" id="otu-list-filter" class="search-query" placeholder="Filter by original or mapped label"
                           data-bind="value: viewModel.listFilters.OTUS.match, valueUpdate: ['afterkeydown', 'input']">
                </form>
                <ul class="nav" style="padding-left: 1em;">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                            data-toggle="dropdown">
                            <span data-bind="text: viewModel.listFilters.OTUS.scope">SCOPE</span>
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" data-bind="foreach: ['In any tree', 'In trees nominated for synthesis', 'In trees not yet nominated', 'Unused (not in any tree)']">
                            <li data-bind="css: {'disabled': viewModel.listFilters.OTUS.scope() == $data }">
                                <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.OTUS.scope($data); }">SCOPE</a>
                            </li>
                        </ul>
                    </li>
                    <!--<li class="divider-vertical"></li>-->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle"
                            data-toggle="dropdown">
                            <span data-bind="text: viewModel.listFilters.OTUS.order">SORT</span>
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" data-bind="foreach: ['Unmapped OTUs first', 'Mapped OTUs first', 'Original label (A-Z)', 'Original label (Z-A)']">
                            <li data-bind="css: {'disabled': viewModel.listFilters.OTUS.order() == $data }">
                                <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.OTUS.order($data); }">SORT</a>
                            </li>
                        </ul>
                    </li>
                </ul>
               </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredOTUs().pagedItems().length === 0">
                    No matching OTUs found! Use the filters above to see
                    OTUs in this study.
                </div>
                <div class="unused-otus-prompt" style="margin-top: -6px; margin-bottom: 16px; display: none;"
                     data-bind="visible: (viewOrEdit == 'EDIT') && (viewModel.filteredOTUs().pagedItems().length > 0) && (viewModel.listFilters.OTUS.scope() === 'Unused (not in any tree)')">
                    <button class="btn pull-right btn-warning" title="Purge all OTUs listed below"
                            style="margin: 4px 0 0 18px;"
                            data-bind="click: purgeUnusedOTUs, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                        Purge unused OTUs &nbsp; <i class="icon-white icon-remove"></i>
                    </button>
                    The OTUs below are not currently used in any tree. If
                    you've mapped some of these names, and you expect to
                    (re)import trees that include them, you should keep these;
                    otherwise you can purge them to clean up the study data.
                </div>

                <table class="table table-condensed table-hover" style="table-layout: fixed;"
                       data-bind="visible: viewModel.filteredOTUs().pagedItems().length !== 0">
                  <thead>
                    <tr class="table-shims">
                      {{ if viewOrEdit == 'EDIT': }}
                        <td width="5%"></td>
                        <td width="25%"></td>
                        <td width="28"></td><!-- width in px, based on button width -->
                        <td width="25%"></td>
                        <td width="28"></td><!-- width in px, based on button width -->
                        <td width="30%"></td>
                      {{ else: }}
                        <td width="70%" colspan="2"></td>
                        <td width="30%"></td>
                      {{ pass }}
                    </tr>
                    <tr class="after-shims">
                      {{ if viewOrEdit == 'EDIT': }}
                        <th style="position: relative;"><span style="position: absolute; top: -0.75em; left: -0.5em; z-index: -1; font-size: 0.85em;"
                                >Select</span><input type="checkbox" onclick="toggleAllMappingCheckboxes(this); return true;" /></th>
                        <th colspan="2">Original name</th>
                        <th colspan="2">Modified for mapping</th>
                        <th>Mapped to taxon <a href="#" onclick="showPossibleMappingsKey(); return false;">(key)</a></th>
                      {{ else: }}
                        <th colspan="2">Original name</th>
                        <th>Mapped to taxon</th>
                      {{ pass }}
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredOTUs().pagedItems(), as: 'otu' }">
                    <tr data-bind="if: true,
                                   css: viewModel.ticklers.OTU_MAPPING_HINTS() +' '+ (otu['selectedForAction'] ? 'warning' : '')">
                      {{ if viewOrEdit == 'EDIT': }}
                         <td style="text-align: left;"
                             onmousedown="return false;"
                             data-bind="click: toggleMappingForOTU">
                             <input type="checkbox" class="map-toggle"
                                    data-bind="checked: $data['selectedForAction'],
                                               click: toggleMappingForOTU,
                                               css: viewModel.ticklers.OTU_MAPPING_HINTS" />
                         </td>
                      {{ pass }}
                        <td data-bind="text: otu['^ot:originalLabel']">&nbsp;</td>
                        <td>
                            <button class="btn btn-mini row-controls-ghosted" title="Show this OTU in all trees"
                                     data-bind="click: showOTUInContext, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-search"></i>
                            </button>
                        </td>
                      {{ if viewOrEdit == 'EDIT': }}
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && (bogusEditedLabelCounter() > 0) && !('^ot:altLabel' in otu) -->
                          {{ # show static adjusted label (modified by mapping hints) }}
                         <td>
                            <em data-bind="text: adjustedLabelOrEmpty(otu['^ot:originalLabel']) || '&mdash;',
                                           css: viewModel.ticklers.OTU_MAPPING_HINTS,
                                           style: { 'color' : ($.trim(otu['^ot:ottTaxonName']) === '' && !proposedMapping(otu)) ?  '' : 'silver' }"
                               >WORKING?</em>
                        </td>
                        <td>
                          <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && $.trim(otu['^ot:ottTaxonName']) === '' && !proposedMapping(otu) -->
                          {{ # show manual-editing widget }}
                            <button class="btn btn-mini row-controls-ghosted pull-right" title="Edit this label manually"
                                    data-bind="click: editOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-edit"></i>
                            </button>
                          <!-- /ko -->
                        </td>
                         <!-- /ko -->
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && (bogusEditedLabelCounter() > 0)  && ('^ot:altLabel' in otu) -->
                          {{ # show editable label field and its remove widget }}
                        <td>
                            <input type="text" class="input-block-level" style="min-height: inherit; height: 1.6em; margin-bottom: 0"
                                   data-bind="value: otu['^ot:altLabel'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: modifyEditedLabel, change: modifyEditedLabel }, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                        </td>
                        <td>
                            <button class="btn btn-mini row-controls-ghosted pull-right" type="button" style="margin-top: 1px;" data-bind="click: revertOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <i class="icon-remove"></i>
                            </button>
                        </td>
                         <!-- /ko -->
                      {{ pass }}
                       {{ # show status or failure message }}
                        <td>
                         <!-- ko if: currentlyMappingOTUs.indexOf(otu['@id']) !== -1 -->
                            <strong style="color: orange;"><em>...mapping now...</em></strong>
                         <!-- /ko -->
                         <!-- ko if: failedMappingOTUs.indexOf(otu['@id']) !== -1 -->
                            <strong style="color: #999;"><em>Failed mapping</em></strong>
                         <!-- /ko -->
                         <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() &&
                                     (currentlyMappingOTUs.indexOf(otu['@id']) === -1) -->
                      {{ if viewOrEdit == 'EDIT': }}
<!--
{<em data-bind="text:proposedMapping(otu)"></em>}
[<em data-bind="text:$.trim(otu['^ot:ottTaxonName'])"></em>]
-->
                          <!-- ko if: false && viewModel.ticklers.OTU_MAPPING_HINTS() && !(proposedMapping(otu)) && !($.trim(otu['^ot:ottTaxonName'])) -->
                            <button id="single-otu-mapping-button"
                                    class="btn btn-small row-controls-ghosted pull-right"
                                    data-bind="visible: !autoMappingInProgress(),
                                               click: requestTaxonMapping">Fuzzy matches</button>
                          <!-- /ko -->
                          <!-- ko if: proposedMapping(otu) && (proposedMapping(otu).length === 1) -->
                           {{ # show mapped label }}
                            <div class="btn-group pull-right">
                                <button class="btn btn-mini"
                                        data-bind="click: rejectProposedOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS"
                                        title="Click to reject this OTU mapping">
                                    <i class="icon-remove"></i>
                                </button>
                            </div>
                            <span style="white-space: nowrap;">
                                <a class="btn btn-mini"
                                   style="padding: 0px 4px;"
                                   title="Click to accept this OTU mapping"
                                   data-bind="click: approveProposedOTULabel">
                                <i class="icon-ok"></i></a>&nbsp;<a data-bind="text: proposedMapping(otu)[0].name,
                                               css: viewModel.ticklers.OTU_MAPPING_HINTS,
                                               attr: getAttrsForMappingOption(proposedMapping(otu)[0], makeArray(proposedMapping(otu)).length)"
                                    href="#"
                                >PROPOSED LABEL</a>
                            </span>
                          <!-- /ko -->
                          <!-- ko if: proposedMapping(otu) && (proposedMapping(otu).length > 1) -->
                           {{ # show available choices for mapping this OTU }}
                            <div class="btn-group pull-right">
                                <button class="btn btn-mini"
                                        data-bind="click: rejectProposedOTULabel, css: viewModel.ticklers.OTU_MAPPING_HINTS"
                                        title="Click to reject all mappings for this OTU">
                                    <i class="icon-remove"></i>
                                </button>
                            </div>
                            <strong style="font-size: 85%; color: #999;"><em>Possible mappings <a href="#" onclick="showPossibleMappingsKey(); return false;">(key)</a></em></strong>
                            <ul class="mapping-options"
                                data-bind="foreach: makeArray(proposedMapping(otu)),
                                           css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                <li style="white-space: nowrap;"><a class="btn btn-mini"
                                                      style="padding: 0px 4px;"
                                                      data-bind="click: approveProposedOTUMappingOption"
                                                      title="Click to accept this OTU mapping">
                                <i class="icon-ok"></i></a>&nbsp;<a data-bind="text: $data.originalMatch.taxon.unique_name,
                                                  attr: getAttrsForMappingOption($data, makeArray(proposedMapping(otu)).length)"
                                       href="#"></a>
                                </li>
                            </ul>
                          <!-- /ko -->
                          <!-- ko if: viewModel.ticklers.OTU_MAPPING_HINTS() && $.trim(otu['^ot:ottTaxonName']) -->
                            <div class="btn-group pull-right row-controls-ghosted">
                                <button class="btn btn-mini" data-bind="click: unmapOTUFromTaxon, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                                    <i class="icon-remove"></i>
                                </button>
                            </div>
                            <strong data-bind="html: getTaxobrowserLink(otu['^ot:ottTaxonName'], otu['^ot:ottId']),
                                               css: viewModel.ticklers.OTU_MAPPING_HINTS",
                                >MAPPED LABEL</strong>
                          <!-- /ko -->
                      {{ else: }}
                            <strong data-bind="html: getTaxobrowserLink(otu['^ot:ottTaxonName'], otu['^ot:ottId'])">MAPPED LABEL</strong>
                      {{ pass }}
                         <!-- /ko -->
                        </td>
                    </tr>
                  </tbody>
                </table>

                <div class="pagination pagination-centered pagination-small"
                     Xdata-bind="if: viewModel.filteredOTUs()().length &gt; viewModel.filteredOTUs().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredOTUs().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredOTUs().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredOTUs() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredOTUs() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredOTUs().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredOTUs().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredOTUs() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredOTUs().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredOTUs().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredOTUs().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>
            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box" style="display: none;">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
        {{ if viewOrEdit == 'EDIT': }}
        <!-- TODO: link to OTT should be updated once we have a release page on the webapp -->
                <p>
                This is a list of all leaf labels, representing OTUs (operational
                taxonomic units), in trees in this study. For a tree to
                contribute to the synthetic tree, OTUs must be mapped
                to taxa in the
                <a href="https://tree.opentreeoflife.org/about/taxonomy-version" target="_blank">OTT (Open Tree Taxonomy)</a>.
                </p>
                <p>
                Click the magnifying-glass next to any OTU to see it in
                the context of this study's trees.
                </p>
                <p>
                We use a TNRS (taxonomic name resolution service) to automate this
                "mapping" process, including resolving synonyms and misspellings.
                Mapping is simplest if trees use taxonomic
                names from
                <a href="http://www.ncbi.nlm.nih.gov/taxonomy" target="_blank">NCBI</a>,
                <a href="http://www.gbif.org/species" target="_blank">GBIF</a>,
                <a href="http://www.indexfungorum.org/" target="_blank">Index Fungorum</a> or
                <a href="http://www.cmar.csiro.au/datacentre/irmng/" target="_blank">IRMNG</a>.
                Some labels comprising genus + strain will also map directly.
                See <strong>Mapping options</strong> for ways to customize mapping.
                </p>
        {{ else: }}
                <p>
                This is a list of all leaf labels, representing OTUs (operational
                taxonomic units), in trees in this study. For a tree to
                contribute to the synthetic tree, OTUs must be mapped
                to taxa in the
                <a href="https://tree.opentreeoflife.org/about/taxonomy-version" target="_blank">OTT (Open Tree Taxonomy)</a>.
                </p>
                <p>
                Click the magnifying-glass icon next to any OTU to see it in
                the context of this study's trees.
                </p>
        {{ pass }}
            </div>

<!-- TODO: If we're doing independent server-side mapping, show a blanket message like this to avoid conflicts?
            <div class="alert alert-block">
                <h4>Server-side mapping in progress</h4>
                This section is blocked while the server works. Please check again later. [TODO]
            </div>
-->

        {{ if viewOrEdit == 'EDIT': }}

            <div id="mapping-status-panel" class="well" style="margin-top: 1em; clear: both;">
                <div class="pull-right" style="margin-top: -2px;">
                    <button id="pause-mapping-button" class="btn btn-small"
                            data-bind="visible: autoMappingInProgress()"
                            onclick="stopAutoMapping(); return false;">
                        <i class="icon-pause"></i> Pause mapping</button>
                    <button id="start-mapping-button" class="btn btn-small"
                            data-bind="visible: !autoMappingInProgress()"
                            onclick="startAutoMapping(); return false;">
                        <i class="icon-play"></i> Map selected OTUs</button>
                </div>
                <!-- TODO: heading changes to reflect status -->
                <h4 style="margin-top: 0;" data-bind="visible: autoMappingInProgress()">Mapping in progress</h4>
                <h4 style="margin-top: 0;" data-bind="visible: !autoMappingInProgress()">Mapping suspended</h4>
                <div class="progress"
                     style="margin-bottom: 0; background-color: #333;"
                     data-bind="css: recentMappingSpeedBarClass">
                  <div class="bar" style="text-align: center;"
                       data-bind="style: { width: recentMappingSpeedPercent }">
                      <span data-bind="text: recentMappingSpeedLabel">10 sec / name</span>
                  </div>
                </div>
                <div class="mapping-details">
                    <p><strong>Note</strong> that the OpenTree taxonomy contains mostly
                    binomials, but in some cases, terminals comprising <em>genus +
                    strain number</em> can also be mapped directly to OTT.
                    (When in doubt, try mapping first before adding any new
                    taxa.)</p>
                </div>
                <div class="mapping-batch-operations" style="display: none;">
                    <button id="batch-approve" class="btn btn-small pull-left"
                            onclick="approveAllVisibleMappings(); return false;">
                        <i class="icon-ok"></i> Accept exact matches
                    </button>
                    <button id="batch-reject" class="btn btn-small pull-right"
                            onclick="rejectAllVisibleMappings(); return false;">
                        <i class="icon-remove"></i> Reject all and pause
                    </button>
                </div>
            </div>

            <div style="margin: 1em 0; overflow: hidden;">
                <button class="btn btn-small pull-left"
                        onclick="clearSelectedMappings(); return false;">
                    Clear selected mappings
                </button>
                <button class="btn btn-small btn-warning pull-right"
                        onclick="clearAllMappings(); return false;">
                    <i class="icon-warning-sign icon-white"></i>
                    Clear <strong>all</strong> mappings
                </button>
            </div>

            <div id="mapping-options-prompt" class="well" style="cursor: pointer;"
                 onclick="showMappingOptions(); return false;">
                <h4 title="Click to show mapping options" style="margin-top: 0;">
                    <i class="pull-right icon-chevron-down"></i>
                    Mapping options
                </h4>
                <p style="margin-bottom: 0;">
                Click here for tools that make mapping faster and more accurate.
                </p>
            </div>
            <div id="mapping-options-panel" class="well" style="display: none;">
                <h4 title="Click to hide mapping options" style="margin-top: 0; cursor: pointer;"
                    onclick="hideMappingOptions(); return false;">
                    <i class="pull-right icon-chevron-up"></i>
                    Mapping options
                </h4>
                <p>
                The easiest way to improve mapping performance is to provide a
                narrow context for the search.
                </p>
                <form class="form-inline" style="margin: 0;">
                 <fieldset>
                    <select class="input-block-level" style="margin-bottom: 8px;" name="mapping-search-context"
                            data-bind="value: getOTUMappingHints().data.searchContext.$,
                              valueUpdate: ['afterkeydown', 'input'],
                              css: viewModel.ticklers.OTU_MAPPING_HINTS,
                              event: { keyup: updateMappingHints, change: updateMappingHints }
                              ">
                    {{ # generate our contextNames list based on newly fetched names
                      try:
                       for context_name in taxonSearchContextNames:
                          if context_name == 'All life': }}
                            <option selected="selected">{{= context_name }}</option>
                       {{ else: }}
                            <option>{{= context_name }}</option>
                       {{ pass }}
                    {{ pass }}
                    {{ except: }}
                            <option selected="selected">ERROR loading context values</option>
                       {{ pass }}
                    </select>
                    <div style="text-align: center; margin: 0 0 1em;">
                        <button class="btn btn-small Xbtn-info"
                                onclick="inferSearchContextFromAvailableOTUs(); return false;">
                            Infer search context from all OTUs
                        </button>
                    </div>
                 </fieldset>
                </form>
                <p>
                Another option that can affect performance is "fuzzy" matching,
                which will offer taxa that are similar in name (including
                synonyms) to the node labels.
                </p>
                <form class="form-inline" style="margin: 0; margin-left: 8px;">
                 <fieldset>
                  <label><input id="toggle-fuzzy-matching" type="checkbox" style="margin-top: 0; padding-top: 0;"
                      data-bind="checked: getOTUMappingHints().data['useFuzzyMatching'],
                                 event: { click: updateMappingHints }"> Use fuzzy matching (slower)</label>
                 </fieldset>
                </form>
                <p>
                If mapping is slow or failing, you can streamline the process by
                modifying the original node labels. Any active substitutions below
                will be applied to all labels during OTU mapping. (See the
                italic <strong>Modified for mapping</strong> values at left.)
                Try some common patterns from the drop-down menu below, or use
                <a href="http://www.regular-expressions.info/javascript.html#replace" target="_blank">regular expressions</a> to construct your own.
                </p>
                <i data-bind="if: getOTUMappingHints() === null">ERROR: No mapping hints found!</i>
              <!-- ko if: getOTUMappingHints() !== null -->
                <form class="form-inline" style="margin: 0;">
                 <fieldset>
                  <table>
                    <thead>
                        <tr>
                            <th width="20">&nbsp;</th>
                            <th>Replace this...</th>
                            <th>with this</th>
                            <th width="20">&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody id="mapping-adjustments" data-bind="foreach: { data: getOTUMappingHints().data.substitutions.substitution, as: 'substitution'}, css: viewModel.ticklers.OTU_MAPPING_HINTS">
                        <tr>
                            <td align="center" valign="center">
                                <input type="checkbox" data-bind="checked: substitution['@active'], event: { click: updateMappingHints }"
                                       title="If checked, this substitution will be used."/>
                            </td>
                            <td>
                                <input type="text" class="input-block-level"
                                       data-bind="value: substitution.old.$, valueUpdate: ['afterkeydown', 'input'], event: { keyup: updateMappingHints, change: updateMappingHints }, style: { 'background-color': substitution['@valid'] ? '' : '#fdd' }"/>
                            </td>
                            <td>
                                <input type="text"
                                class="input-block-level" data-bind="value: substitution.new.$, valueUpdate: ['afterkeydown', 'input'], event: { keyup: updateMappingHints, change: updateMappingHints }"/>
                            </td>
                            <td align="center" valign="center">
                                <a href="#" title="Click to remove this substitution."
                                   data-bind="click: function(data, event) { removeSubstitution(data);  }" />
                                    <i class="icon-trash"></i></a>
                            </td>
                        </tr>
                    </tbody>
                  </table>

                  <div style="margin-top: 1em;">
                      <select class="input-block-level" onchange="addSubstitution(this); return false;">
                        <option value="">Add a common substitution...</option>
                       <!-- NOTE the convention here... value="{OLD} =:= {NEW}" -->
                        <option value="\bsp(\.|\b) =:= ">Remove 'sp.'</option>
                        <option value="foo =:= bar">Replace 'foo' with 'bar'</option>
                        <option value="^(\S*)\s+\b =:= ">Remove first of multiple words</option>
                        <option value="\b\s+(\S*)$ =:= ">Remove last of multiple words</option>
                        <option value="^(\S*\s+\S*).* =:= $1">Keep first two words</option>
                        <option value=".*\s+(\S*)\s*$ =:= $1">Isolate trailing ID</option>
                      </select>
                  </div>
                  <div style="margin-top: 1em;">
                      <button type="submit" class="btn"
                              onclick="addSubstitution(); return false;">
                          <i class="icon-plus"></i> Add another substitution
                      </button>
                  </div>

                 </fieldset>
                </form>
              <!-- /ko -->
                <p style="margin: 1em 0 0;">
                As a last resort, you can directly edit the label submitted for mapping. Just click
                the <button class="btn btn-mini"><i class="icon-edit"></i></button> buttons
                in the <strong>Modified for mapping</strong> column at left.
                </p>
            </div>

            <div class="well">
                <h4 style="margin-top: 0;">Adding new taxa</h4>
                <p>
                Unmapped taxa are kept in the study, but pruned during
                synthesis. You can submit unmapped tree labels as new taxa in
                the Open Tree Taxonomy.
                </p>
                <button type="submit" class="btn"
                        onclick="showNewTaxaPopup(); return false;">
                    <i class="icon-plus"></i> Open new taxa form for selected OTUs
                </button>
            </div>

        {{ pass }}

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Annotations">
           <div class="span12"><!-- full width... -->

            <button class="help-toggle" style="display: none; margin-bottom: 0px;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                <strong>Annotations</strong> are used to store comments and
                validation results related to this study. They can be added by
                a human curator or reviewer (coming soon), or by online validators
                and other programs like those listed in the
                <strong>Tools</strong> tab.
              </p>
              <p>
                Annotations that refer to a particular element (like a tree or
                OTU) will often appear in context. You can read these by
                clicking on a marker like <span class="badge badge-info">2 <i class="icon-comment icon-white"></i></span>
                (coming soon), but the list below gathers all the study's
                annotations in a single place.
              </p>
            </div>

            <ul class="suggestion-list" style="clear: right;"></ul>
            <div style="margin-bottom: 100px;">

              <div class="navbar">
                 <div class="navbar-inner">
                  <form class="navbar-search pull-left">
                      <input type="text" id="annotation-list-filter" class="search-query input-xlarge" placeholder="Filter by type, location, submitter, message"
                             data-bind="value: viewModel.listFilters.ANNOTATIONS.match, valueUpdate: ['afterkeydown', 'input']">
                  </form>
                <!-- TODO: Can we provide some kind of support for thes filters?
                  <ul class="nav" style="padding-left: 1em;">
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            In trees and nodes
                            <b class="caret"></b>
                          </a>
                          <ul class="dropdown-menu">
                              <li><a href="#">Anywhere in the study</a></li>
                              <li><a href="#">In files</a></li>
                              <li><a href="#">In OTU mapping</a></li>
                              <li><a href="#">In study metadata</a></li>
                              <li><a href="#">In trees and nodes</a></li>
                          </ul>
                      </li>
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                              <span data-bind="text: viewModel.listFilters.ANNOTATIONS.submitter">SORT</span>
                              <b class="caret"></b>
                          </a>
                          <ul class="dropdown-menu" data-bind="foreach: ['Submitted by all', 'Submitted by users', 'Submitted by validation tools']">
                              <li data-bind="css: {'disabled': viewModel.listFilters.ANNOTATIONS.submitter() == $data }">
                                  <a href="#" data-bind="text: $data, click: function () { viewModel.listFilters.ANNOTATIONS.submitter($data); }">SORT</a>
                              </li>
                          </ul>
                      </li>
                  </ul>
                  -->
                 </div>
              </div>

                <div class="empty-list-prompt" data-bind="visible: viewModel.filteredAnnotations().pagedItems().length === 0">
                    No matching annotations found! Clear the
                    filter above to see annotations in this study.
                </div>

                <table class="table table-condensed"
                    data-bind="visible: viewModel.filteredAnnotations().pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                        <th>Type</th>
                        <!-- <th>Location (click to see note there)</th> -->
                        <th>Added by</th>
                        <th>Message(s)</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.filteredAnnotations().pagedItems(), as: 'annotation' }">
                    <tr>
                        <td data-bind="text: annotation['@description'], style: { color: annotation['@passedChecks'] ? '' : 'red' }"></td><!-- general description (annotation type) -->
                        <!-- <td><a href="#">Study</a></td> -->
                        <td data-bind="text: getAgentForAnnotationEvent( annotation ) ? getAgentForAnnotationEvent( annotation )['@name'] : '??'"></td>
                      <!-- ko if: makeArray( annotation.message ).length > 0 -->
                        <td data-bind="if: makeArray( annotation.message ).length > 0">
                            <ul style="list-style: none; margin: 0 0 8px 0;"
                            data-bind="foreach: makeArray( annotation.message )">
                                <li style="border-bottom: 1px solid #ccc; padding: 2px 0;">
                                <!-- data-bind="text: code" is SHOUTY_UPPERCASE -->
                                <span data-bind="text: $data['@comment']"></span>
                                <!-- data-bind="text: data" can be object or function or ... -->
                                in <span data-bind="text: ('@top' in $data.refersTo) ? $data.refersTo['@top'].$ : '??'"></span>
                                [<span data-bind="text: $data['@severity']"></span>]
                            </ul>
                        </td>
                      <!-- /ko -->
                      <!-- ko if: makeArray( annotation.message ).length === 0 -->
                        <td>
                            NO MESSAGES HERE
                        </td>
                      <!-- /ko -->
                    </tr>
                  </tbody>
                </table>
                  <!-- EXAMPLES of other annotation types:
                    <tr>
                        <td>Reply</td>
                        <td><a href="#">Message thread</a></td>
                        <td><a href="#">Charles Darwin</a></td>
                        <td style="font-style: italic;">Au contraire, mon ami. The condor properly belongs everywhere...</td>
                    </tr>
                    <tr>
                        <td>Comment</td>
                        <td><a href="#">Charadriidae</a></td>
                        <td><a href="#">Jim Allman</a></td>
                        <td style="font-style: italic;">This is not the place for condors or butterflies in any case...</td>
                    </tr>
                    <tr>
                        <td>Question</td>
                        <td><a href="#">Additional Birds.xls</a></td>
                        <td><a href="#">Jonathan Rees</a></td>
                        <td style="font-style: italic;">Is there a reason for this data file? It doesn't seem to correspond...</td>
                    </tr>
                    <tr>
                        <td>Erratum</td>
                        <td><a href="#">Seabird tree</a></td>
                        <td><a href="#">Charles Darwin</a></td>
                        <td style="font-style: italic;">This tree is poorly rooted, in my opinion.</td>
                    </tr>
                  -->

                <!-- TODO: respond to calculated notes, gathered from throughout study NexSON -->
                <div class="pagination pagination-centered pagination-small"
                     Xdata-bind="if: viewModel.filteredAnnotations()().length &gt; viewModel.filteredAnnotations().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.filteredAnnotations().prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredAnnotations().prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.filteredAnnotations() ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.filteredAnnotations() ) -->
                    <li data-bind="css: { 'active': (viewModel.filteredAnnotations().current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.filteredAnnotations().goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.filteredAnnotations() ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.filteredAnnotations().goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.filteredAnnotations().next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.filteredAnnotations().next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>
           </div><!-- end of full-width column... -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="Analyses">
           <div class="span8"><!-- main column... -->

             <form class="form-inline">
                 <label>Analyze tree</label>
                 <select id="tree-select"
                         onchange="(this); return false;"
                         data-bind="options: viewModel.elementTypes.tree.gatherAll(viewModel.nexml),
                                    optionsValue: '@id',
                                    optionsText: '@label',
                                    optionsCaption: 'Choose a tree from this study...',
                                    css: viewModel.ticklers.TREES">
                 </select>

                 <label>against target</label>
                 <select id="reference-select">
                     <option value="">Choose a target...</option>
                     <option value="synth">Synthetic Tree of Life</option>
                     <option value="ott">Open Tree Taxonomy</option>
                 </select>
                 <button class="btn btn-info" data-bind="click: fetchAndShowTreeConflictSummary">GO!</button>
             </form>

            <div id="analysis-results">
              <em>Analysis results will appear here...</em>
            </div>

           </div><!-- end of main column... -->
           <div class="span4"><!-- right col -->

            <button class="help-toggle" style="display: none;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
                <p>
                  The <strong>Analysis</strong> tab reports the results of conflict
                  analysis - how trees in this study agree / conflict with the
                  synthetic tree or the OpenTree Taxonomy.
                </p>
                <p>
                  In the future, there will be other analyses here. Have a suggestion?
                  Add an <a href="https://github.com/OpenTreeOfLife/opentree/issues">issue</a>.
                </p>
            </div>

           </div><!-- end of right col -->
          </div><!-- /.tab-pane -->

          <div class="tab-pane" id="History">
           <div class="span12"><!-- full width... -->

            <button class="help-toggle" style="display: none; margin-bottom: 0px;">
                Show help for this tab <i class="icon-chevron-down Xicon-white"></i>
            </button>
            <div class="help-box">
              <button class="help-toggle">
                  Hide <i class="icon-chevron-up Xicon-white"></i>
              </button>
              <p>
                This tab shows the <strong>edit history</strong> for this collection:
                each saved version of the data, who submitted the changes, and
                a comment added each time. The history might include edits
                made in other tools or by automated software. This history is
                possible because we keep collection files under version control
                in a <a href="https://github.com/OpenTreeOfLife/phylesystem" target="_blank">GitHub repository</a>.
              </p>
            </div>

            <ul class="suggestion-list" style="clear: right;"></ul>
            <div style="margin-bottom: 100px;">

                <div class="empty-list-prompt" data-bind="visible: viewModel.versions.pagedItems().length === 0">
                    No previous versions found! (This is a new collection.)
                </div>

                <table class="table table-condensed"
                    data-bind="visible: viewModel.versions.pagedItems().length &gt; 0">
                  <thead>
                    <tr>
                        <th width="20%">Date</th>
                        <th width="20%">Curated by</th>
                        <th width="50%">Comment</th>
                        <th width="10%">Details</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: { data: viewModel.versions.pagedItems(), as: 'version' }">
                    <tr>
                        <td><span data-bind="text: version['relative_date'], attr: {'title': version['date']}">?</span></td>
                        <td data-bind="text: version['author_name']">?</td>
                        <td><pre class="rendered-comment" data-bind="text: version['message_subject'] + (version['message_body'] ? '\n\n'+ version['message_body'] : '')">?</pre></td>
                        <td>
                          <!-- ko if: version['publicDiffURL'] -->
                            <a href="" target="_blank" title="See detailed differences on GitHub"
                               data-bind="attr: {'href': version['publicDiffURL']}">Diff view</a>
                          <!-- /ko -->
                          <!-- ko if: !version['publicDiffURL'] -->
                            &mdash;
                          <!-- /ko -->
                        </td>
                    </tr>
                  </tbody>
                </table>

                <div class="pagination pagination-centered pagination-small"
                     Xdata-bind="if: viewModel.versions()().length &gt; viewModel.versions().pagedItems().length">
                  <ul>
                    <li data-bind="css: { 'disabled': !viewModel.versions.prev.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.versions.prev(); return false;">&laquo;</a>
                    </li>
                   <!-- ko foreach: getPageNumbers( viewModel.versions ) -->
                    <!-- ko if: isVisiblePage( $data, viewModel.versions ) -->
                    <li data-bind="css: { 'active': (viewModel.versions.current() === $data) }" class="active">
                        <a href="#" data-bind="text: $data, click: function() { viewModel.versions.goToPage($data); return false; }">0</a>
                    </li>
                    <!-- /ko -->
                    <!-- ko if: ! isVisiblePage( $data, viewModel.versions ) -->
                    <li><a class="pagination-spacer" href="#" data-bind="click: function() { viewModel.versions.goToPage($data); return false; }">&nbsp;</a></li>
                    <!-- /ko -->
                   <!-- /ko -->
                    <li data-bind="css: { 'disabled': !viewModel.versions.next.enabled() }" class="disabled">
                        <a href="#" onclick="viewModel.versions.next(); return false;">&raquo;</a>
                    </li>
                  </ul>
                </div>

            </div>
           </div><!-- end of full-width column... -->
          </div><!-- /.tab-pane -->
    </div><!-- /.tab-content -->


</div><!-- /.row -->

<script src="{{=URL('static','js/curation-helpers.js')}}"></script>
<script type='text/javascript'>
    var collectionID = '{{= collectionID }}';
    var latestSynthesisSHA = '{{= latestSynthesisSHA }}';
    //var latestSynthesisTreeIDs = {{# = XML( json.dumps(latestSynthesisTreeIDs) ) }};
    var treesQueuedForSynthesis = {{=XML( json.dumps(treesQueuedForSynthesis) ) }};
    var viewOrEdit = '{{= viewOrEdit }}';

    var API_create_collection_POST_url = '{{=API_create_collection_POST_url}}';
    var API_load_collection_GET_url = '{{=API_load_collection_GET_url}}';
    var API_update_collection_PUT_url = '{{=API_update_collection_PUT_url}}';
    var API_remove_collection_DELETE_url = '{{=API_remove_collection_DELETE_url}}';

    // If inbound URL specifies tab, tree, or filter settings, record them here
    var initialState = {{= XML( dict(request.vars) ) }};
    // set any required defaults (for clean/simple history behavior)
    if (!('tab' in initialState)) {
        initialState.tab = 'Metadata';
    }
    var listFilterDefaults = {
        // track these defaults so we can reset them in history
        'TREES': {
            'match': ""
        },
        'FILES': {
            'match': ""
        },
        'OTUS': {
            // TODO: add 'pagesize'?
            'match': "",
            'scope': "In any tree",
            'order': "Unmapped OTUs first"
        },
        'ANNOTATIONS': {
            'match': "",
            'scope': "Anywhere in the collection",
            'submitter': "Submitted by all"
        },
        'COLLECTIONS': {
            // NOTE 'match' and 'filter' are currently unused
            'match': "",
            'order': "Most recently modified",
            'filter': "All tree collections"
        }
    };
    var filterDefaults = null;
    switch(slugify(initialState.tab)) {
        case 'trees':
            filterDefaults = listFilterDefaults.TREES;
            break;
        case 'files':
            filterDefaults = listFilterDefaults.FILES;
            break;
        case 'otu-mapping':
            filterDefaults = listFilterDefaults.OTUS;
            break;
    }
    if (filterDefaults) {
        // apply any missing filter defaults
        for (var prop in filterDefaults) {
            if (!(prop in initialState)) {
                initialState[prop] = filterDefaults[prop];
            }
        }
    }

    var treemachine_domain = "{{=treemachine_domain}}";
    var taxomachine_domain = "{{=taxomachine_domain}}";
    var doTNRSForAutocomplete_url = "{{=doTNRSForAutocomplete_url}}";
    var doTNRSForMappingOTUs_url = "{{=doTNRSForMappingOTUs_url}}";
    var getContextForNames_url = "{{=getContextForNames_url}}";
    var render_markdown_url = "{{=render_markdown_url}}";
    var getTreesQueuedForSynthesis_url ="{{=getTreesQueuedForSynthesis_url}}";
    var includeTreeInSynthesis_url ="{{=includeTreeInSynthesis_url}}";
    var excludeTreeFromSynthesis_url ="{{=excludeTreeFromSynthesis_url}}";

    var getDraftTreeMRCAForNodes_url = "{{=getDraftTreeMRCAForNodes_url}}";
    var getTaxonomicMRCAForNodes_url = "{{=getTaxonomicMRCAForNodes_url}}";
    var singlePropertySearchForStudies_url = "{{=singlePropertySearchForStudies_url}}";
    var treeConflictStatus_url = "{{=treeConflictStatus_url}}";

    var API_create_amendment_POST_url = "{{=API_create_amendment_POST_url}}";
</script>
<script src="{{=URL('static','js/tree-collection-editor.js')}}"></script>

<!-- hidden template for DOI lookups -->
<div class="modal hide fade modal-DOI-lookup" id="DOI-lookup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Matching DOIs and references
      </h3>
    </div>
    <div class="modal-body" style="overflow-y: inherit;">
        <div class="before-matches">
            <div class="current-ref-values">
                <strong>Current reference text and DOI/URL:</strong>
                <p id="current-ref-text" style="margin-bottom: 0.25em;">&nbsp;</p>
                <a id="current-ref-URL" style="display: block;" href="#" target="_blank" onclick="return false;">&nbsp;</a>
            </div>
            <p>
                Based on the reference text for this study,
                <a href="http://crossref.org/" target="_blank">CrossRef.org</a>
                returned these <span class="found-matches-count"></span> matching records (best matches first).
            </p>
        </div>
        <div class="found-matches" style="overflow-y: auto;"></div>
    </div>
    <div class="modal-footer">
      <a data-dismiss="modal" class="btn" >Close</a>
    </div>
</div>

<!-- hidden template for explaining colors and opacity of OTU mapping option -->
<div class="modal hide fade" id="possible-mappings-key" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         How to interpret possible OTU mappings
      </h3>
    </div>
    <div class="modal-body">
        <p>
            When an OTU cannot be clearly mapped to a single taxon in the Open
            Tree taxonomy, the most likely matches will appear in a list like
            the one below.
        </p>
        <ul class="mapping-options" style="padding-left: 20px;">
            <li>
                <div class="key-note">possible matches are green</div>
                <a class="badge badge-success"
                   style="opacity: 1.0;"
                   title="100% match of original label"
                   href="#" onclick="return false;"
                >Hominidae</a>
            </li>
            <li>
                <div class="key-note">closer matches are darker</div>
                <a class="badge badge-success"
                   style="opacity: 0.78;"
                   title="78% match of original label"
                   href="#" onclick="return false;"
                >Homininae</a>
            </li>
            <li>
                <a class="badge badge-success"
                   style="opacity: 0.56;"
                   title="56% match of original label"
                   href="#" onclick="return false;"
                >Homo</a>
            </li>
            <li>
                <div class="key-note">synonyms are blue</div>
                <a class="badge badge-info"
                   style="opacity: 1;"
                   title="Synonym for Drosophila"
                   href="#" onclick="return false;"
                >Psathyrella</a>
            </li>
            <li>
                <div class="key-note">homonyms are amber</div>
                <a class="badge badge-warning"
                   style="opacity: 1;"
                   title="Taxon-name homonym"
                   href="#" onclick="return false;"
                >Drosophila (genus in Drosophiliti)</a>
            </li>
        </ul>
        <p>
            Click <button
            class="btn btn-mini row-controls-ghosted"
            type="button" onclick="return true;"><i class="icon-ok"></i>
            </button> to
            map the OTU to this taxon. Click
            <button class="btn btn-mini row-controls-ghosted"
                    type="button" onclick="return false;"><i class="icon-remove"></i>
            </button>
            to reject all mappings; then try modifying the original label and re-mapping.
        </p>
        <p>
          Roll over each match to learn more about it. Click a name to
          open the taxonomy browser for that taxon.
        </p>
    </div>
    <div class="modal-footer">
      <a data-dismiss="modal" class="btn" >Close</a>
    </div>
</div>

<!-- hidden template for gathering comments when saving the collection -->
<div class="modal hide fade modal-save-comments" id="save-comments-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Add a comment for these changes
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Add a brief description of the work you've done.
            This will appear in the History tab.
        </p>
        <input type="text" id="save-comment-first-line" class="input-block-level" maxlength="50" placeholder="Add a one-line summary (50 chars max)"/>
        <textarea id="save-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
        <p id="save-collection-noemail-warning" class="help-box">
          <strong>Warning</strong>: You have not provided a public email address
            in your GitHub profile. You can still edit data but this activity
            will not be shown on your GitHub or OpenTree profiles (and cannot be
            linked back at a later date). See
            <a href="https://github.com/OpenTreeOfLife/opentree/wiki/OpenTree-user-accounts-and-GitHub" target="_blank">
            the help page</a> for details.
        </p>
  </div>
    <div class="modal-footer">
      <button class="btn btn-info pull-right" style="margin-left: 20px;"
              onclick="$('#save-comments-popup').modal('hide'); saveFormDataToCollectionJSON(); return false;">Save Collection</button>
      <a data-dismiss="modal" class="btn" >Cancel</a>
    </div>
</div>

<!-- hidden template for gathering comments when deleting the collection -->
<div class="modal hide fade modal-save-comments" id="delete-comments-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Are you sure you want to do this?
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Add a brief description of why you're deleting this collection.
            (This will be saved in the main repository.)
        </p>
        <input type="text" id="delete-comment-first-line" class="input-block-level" maxlength="50" placeholder="Add a one-line summary (50 chars max)"/>
        <textarea id="delete-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger pull-right" style="margin-left: 20px;"
              onclick="$('#delete-comments-popup').modal('hide'); removeCollection(); return false;">Delete Collection</button>
      <a data-dismiss="modal" class="btn" >Cancel</a>
    </div>
</div>

<!-- hidden template reminding about adding data if a data deposit already exists -->
<div class="modal hide fade" id="late-data-reminder" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Reminder
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Files or trees added here should already be present in the data deposit for this study.
            <span id="data-deposit-reminder">&nbsp;</span>
        </p>
        <p>(This reminder will only appear once per editing session.)</p>
    </div>
    <div class="modal-footer">
      <a data-dismiss="modal" class="btn" >Close</a>
    </div>
</div>

<!-- hidden template for gathering comments when saving the collection -->
<div class="modal hide fade modal-save-comments" id="collection-metadata-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
          Collection metadata <span style="color: #ccc;">& curator notes</span>
      </h3>
    </div>
    <div class="modal-body">
      <div class="row">

           <div class="span"><!-- main column... -->
            <ul class="suggestion-list"></ul>
            <form class="form-horizontal wider-fields{{= (viewOrEdit == 'VIEW') and ' metadata-readonly' or '' }}">
              <div class="control-group">
                <label class="control-label" for="ot_studyPublicationReference">Publication reference</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <textarea data-bind="value: nexml['^ot:studyPublicationReference'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }, css: viewModel.ticklers.GENERAL_METADATA" id="ot_studyPublicationReference" class="input-xlarge" style="height: 160px;" placeholder=""></textarea>
                {{ else: }}
                  <p class="static-form-value" data-bind="text: nexml['^ot:studyPublicationReference']"></p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_studyPublication">Publication DOI/URL</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <input data-bind="value: nexml['^ot:studyPublication']['@href'],
                                    valueUpdate: ['afterkeydown', 'input'],
                                    event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA, blur: validateAndTestDOI },
                                    css: viewModel.ticklers.GENERAL_METADATA" type="text" id="ot_studyPublication" class="input-xlarge" placeholder="">
                  <button type="button" class="btn btn-info" onclick="lookUpDOI(); return false;">Look up DOI...</button>
                {{ else: }}
                  <p class="static-form-value">
                 <!-- ko if: getStudyPublicationLink() !== '' -->
                      <span data-bind="html: getStudyPublicationLink()">&nbsp;</span>
                 <!-- /ko -->
                 <!-- ko if: getStudyPublicationLink() === '' -->
                      <em>None</em>
                 <!-- /ko -->
                  </p>
                {{ pass }}
                </div>
                <div class="controls" data-bind="if: viewModel.duplicateStudyIDs().length > 0">
                    <p class="static-form-value interesting-value">
                        There are other studies in Open Tree database with this DOI. Click the links below to see each one in a new browser window.
                    </p>
                    <ul class="static-form-value interesting-value" data-bind="foreach: viewModel.duplicateStudyIDs">
                        <li><a href="#" target="_blank"
                            data-bind="text: getViewURLFromStudyID($data), attr: {'href': getViewURLFromStudyID($data)}">&nbsp</a></li>
                    </ul>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_studyDataDeposit">Data deposit DOI/URL</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <input data-bind="value: nexml['^ot:dataDeposit']['@href'],
                                    valueUpdate: ['afterkeydown', 'input'],
                                    event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA, blur: formatDataDepositDOIAsURL },
                                    css: viewModel.ticklers.GENERAL_METADATA" type="text" id="ot_studyDataDeposit" class="input-xlarge" placeholder="">
                {{ else: }}
                  <p class="static-form-value">
                  <!-- ko if: getDataDepositMessage() !== '' -->
                      <span data-bind="html: getDataDepositMessage()">&nbsp;</span>
                 <!-- /ko -->
                 <!-- ko if: getDataDepositMessage() === '' -->
                      <em>None</em>
                 <!-- /ko -->
                  </p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_studyYear">Study Year</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <input data-bind="value: nexml['^ot:studyYear'], valueUpdate: ['afterkeydown', 'input'], event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }" type="text" id="ot_studyYear" class="input-mini" placeholder="">
                {{ else: }}
                  <p class="static-form-value" data-bind="text: nexml['^ot:studyYear']"></p>
                {{ pass }}
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="ot_focalClade">Focal clade</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <div class="static-form-value"
                       data-bind="text: nexml['^ot:focalCladeOTTTaxonName'] || 'None', attr:{'title': ('ottid:'+ nexml['^ot:focalClade'])}, css: viewModel.ticklers.GENERAL_METADATA">
                    &nbsp;
                  </div>
            <!-- reuse some (not all) style and behavior for taxon search in synth-tree viewer -->
            <div id="taxon-search-form" class="Xnavbar-search Xpull-right" autocomplete="off" style="Xdisplay: inline-block; position: relative;">
                <input type="text" name="taxon-search" class="" style="width: 365px;"
                    placeholder="Choose the smallest taxon that contains the ingroup..." autocomplete="off">
                <!-- <input type="submit" style="" name="taxon-search-go" value="Go" onclick="return false;"/> -->
                <!-- then show dropdown when results are ready... -->
                <span style="color: #999; padding: 0 2px; font-size: 14px;">in</span>
                <select style="margin-bottom: 0; width: auto;" name="taxon-search-context">
                    {{ # generate our contextNames list based on newly fetched names
                      try:
                       for context_name in taxonSearchContextNames:
                          if context_name == 'All life': }}
                            <option selected="selected" value="{{= context_name }}">{{= context_name }}</option>
                       {{ else: }}
                            <option value="{{= context_name }}">{{= context_name }}</option>
                       {{ pass }}
                    {{ pass }}
                    {{ except: }}
                            <option selected="selected">ERROR loading context values</option>
                       {{ pass }}
                <!--
                NOTE that the displayed OPTION values (confirmed as current via AJAX) are accepted
                by the server, ie, there's no distinction between visible and occult values.
                -->
                </select>
                <div class="">
                    <ul id="search-results" class="dropdown-menu" role="menu">
                        ...
                    </ul>
                </div>
            </div>
                  <input data-bind="value: nexml['^ot:focalClade'], event: { change: nudge.GENERAL_METADATA }, css: viewModel.ticklers.GENERAL_METADATA" type="hidden" id="ot_focalClade" placeholder="">
                {{ else: }}
                  <p class="static-form-value">
                    <span data-bind="text: nexml['^ot:focalCladeOTTTaxonName'], attr:{'title': ('ottid:'+ nexml['^ot:focalClade'])}, css: viewModel.ticklers.GENERAL_METADATA">&nbsp;</span>
                  </p>
                {{ pass }}
                </div>
              </div>

              <div class="control-group">
                <label class="control-label" for="ot_curatorName">Submitted by</label>
                <div class="controls">
                  <p class="static-form-value" data-bind="text: nexml['^ot:curatorName'].join(', ')"></p>
                </div>
              </div>

              <div class="control-group">
                <label class="control-label">Waiver or license</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT':
                   # treat this as read-only once it's been chosen! }}
                 <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && studyHasCC0Waiver( nexml ) -->
                 <p class="static-form-value" data-bind="css:viewModel.ticklers.GENERAL_METADATA">
                  <a target="_blank" href="http://creativecommons.org/publicdomain/zero/1.0/">
                      <img alt="CC0 (opens a new window)" src="{{=URL('static','images/cc-zero.png')}}">
                  </a>
                 </p>
                 <!-- /ko -->
                 <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && !studyHasCC0Waiver( nexml ) -->
                 <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && getStudyLicenseInfo( nexml ) -->
                     <p class="static-form-value">
                      <a target="_blank" href="#"
                         data-bind="text: getStudyLicenseInfo( nexml )['@name'] || '???',
                                    attr: {'href': getStudyLicenseInfo( nexml )['@href'] || '#'}">&nbsp;</a>
                     </p>
                     <!-- /ko -->
                     <!-- ko if: viewModel.ticklers.GENERAL_METADATA() && !getStudyLicenseInfo( nexml ) -->
                     <p class="static-form-value">
                      <em>None</em>
                     </p>
                     <div id="applying-cc0-details" Xclass="featured-label-child">
                            <label for="agreed-to-CC0" class="featured-label" style="margin-top: 0px; padding-left: 20px; text-indent: -20px; width: 60%;">
                                <input type="checkbox" id="agreed-to-CC0" name="cc0_agreement"
                                       style="width: 20px;"
                                       onclick="applyCC0Waiver(); return false;"/>I am an author, or can act on behalf of the authors, to apply a CC0 waiver to these data. By clicking this checkbox, I hereby release these data under the terms of the <a href="http://creativecommons.org/publicdomain/zero/1.0/" target="_blank">Creative Commons Zero (CC0) waiver</a>.
                            </label>
                     </div>
                     <!-- /ko -->
                 <!-- /ko -->
                {{ else: }}
                 <!-- ko if: studyHasCC0Waiver( nexml ) -->
                 <p class="static-form-value">
                  <a target="_blank" href="http://creativecommons.org/publicdomain/zero/1.0/">
                      <img alt="CC0 (opens a new window)" src="{{=URL('static','images/cc-zero.png')}}">
                  </a>
                 </p>
                 <!-- /ko -->
                 <!-- ko if: !studyHasCC0Waiver( nexml ) -->
                 <p class="static-form-value">
                     <!-- ko if: getStudyLicenseInfo( nexml ) -->
                      <a target="_blank" href="#"
                         data-bind="text: getStudyLicenseInfo( nexml )['@name'] || '???',
                                    attr: {'href': getStudyLicenseInfo( nexml )['@href'] || '#'}">&nbsp;</a>
                     <!-- /ko -->
                     <!-- ko if: !getStudyLicenseInfo( nexml ) -->
                      <em>None</em>
                     <!-- /ko -->
                 </p>
                 <!-- /ko -->
                {{ pass }}
                </div>
              </div>

              <div class="control-group">
                <label class="control-label" for="ot_curatorName">Collection ID</label>
                <div class="controls">
                  <p class="static-form-value" data-bind="text: nexml['^ot:studyId']"></p>
                </div>
              </div>

              <!-- <div class="control-group">
                <div class="controls">

                  <p class="static-form-value interesting-value" data-bind="text: studyContributedToLatestSynthesis() ? (currentStudyVersionContributedToLatestSynthesis() ? 'This version was used to build the latest synthetic tree' : 'This study has changed since building the last synthetic tree.') : 'This study was not used in the latest synthesis.'"></p>

                </div>

              </div> -->

              <div class="control-group">
                <label class="control-label">Curator notes</label>
                <div class="controls">
                {{ if viewOrEdit == 'EDIT': }}
                  <!-- markdown editor w/ preview option -->
                    <ul class="nav nav-pills pull-right" style="margin-bottom: 4px;">
                        <li><a target="_blank" href="https://help.github.com/articles/basic-writing-and-formatting-syntax/">Markdown help</a></li>
                    </ul>
                    <div class="btn-group" style="margin-bottom: 8px;">
                      <button id="edit-comment-button" class="btn active" onclick="showCollectionCommentEditor(); return false;">&nbsp; Edit (Markdown) &nbsp;</button>
                      <button id="preview-comment-button" class="btn" onclick="showCollectionCommentPreview(); return false;">&nbsp; Preview (HTML) &nbsp;</button>
                    </div>
<!--
                    <textarea id="save-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
-->
                    <div id="comment-editor"><textarea data-bind="value: viewModel.nexml['^ot:comment'],
                                                                  valueUpdate: ['afterkeydown', 'input'],
                                                                  event: { keyup: nudge.GENERAL_METADATA, change: nudge.GENERAL_METADATA }"
                                                       placeholder="Enter notes for viewers and other curators here (as markdown)."
                                                       rows="8"
                                                       class="input-block-level">?</textarea></div>
                    <div id="comment-preview" class="rendered-comment" style="display: none;">
                    </div>
                {{ else: }}
                  <!-- render existing comment as markdown -->
                    <div class="rendered-comment" style="display: none;"
                         data-bind="visible: $.trim(viewModel.nexml['^ot:comment']) !== '', html: viewModel['commentHTML']" >
                       {comments appear here}
                    </div>
                    <p class="static-form-value" style="display: none;"
                       data-bind="visible: $.trim(viewModel.nexml['^ot:comment']) === ''">
                       <em>None</em>
                    </p>
                {{ pass }}

                </div>
              </div>

            </form>

           </div><!-- end of main column... -->

      </div><!-- div.row -->
    </div><!-- div.modal-body -->
</div><!-- div.modal -->

