<!DOCTYPE html>
{{
from applications.opentree.modules.opentreewebapputil import get_user_login, get_user_display_name, get_conf, get_domain_banner_text, get_domain_banner_hovertext, get_currently_deployed_opentree_branch
}}
<html lang="{{=T.accepted_language or 'en'}}" class="no-js"><!-- no-js need it for modernzr -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143548106-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-143548106-1');
  </script>

    <meta charset="utf-8" />
    <!-- www.phpied.com/conditional-comments-block-downloads/ -->
    <!--[if IE]><![endif]-->
    <!-- Always force latest IE rendering engine
	 (even in intranet) & Chrome Frame
	 Remove this if you use the .htaccess -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>{{=response.title or request.application}}</title>
    {{response.files.append(URL('static','css/bootstrap.css'))}}
    <style type="text/css">
        /* TODO: add page-specific styles here */
    </style>
    {{response.files.append(URL('static','css/bootstrap-responsive.css'))}}

    <script type="text/javascript">
        /*
        @licstart  The following is the entire license notice for the JavaScript code in this page.

        Copyright (c) 2013, Jonathan Rees
        Copyright (c) 2013, Mark Holder
        Copyright (c) 2013, Jim Allman
        Copyright (c) 2013, Stephen Smith

        All rights reserved.

        Redistribution and use in source and binary forms, with or without
        modification, are permitted provided that the following conditions are met:

        Redistributions of source code must retain the above copyright notice, this
        list of conditions and the following disclaimer.

        Redistributions in binary form must reproduce the above copyright notice,
        this list of conditions and the following disclaimer in the documentation
        and/or other materials provided with the distribution.

        THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
        AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
        IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
        DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
        FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
        DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
        SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
        CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
        OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
        OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

        @licend  The above is the entire license notice for the JavaScript code in this page.

        Licensing for third-party and linked JavaScript can be found in the
        'License information' page linked from the footer.
        */
    </script>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      {{response.files.append(URL('static','js/html5shiv.js'))}}
    <![endif]-->


    <!-- http://dev.w3.org/html5/markup/meta.name.html -->
    <meta name="application-name" content="{{=request.application}}" />

    <!-- Speaking of Google, don't forget to set your site up:
	 http://google.com/webmasters -->
    <meta name="google-site-verification" content="" />

    <!--  Mobile Viewport Fix
	  j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
	  device-width: Occupy full width of the screen in its current orientation
	  initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
	  maximum-scale = 1.0 retains dimensions instead of zooming in if page width < device width
      -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
    <script src="{{=URL('static','js/modernizr.custom.js')}}"></script>

    <script type='text/javascript'>
        var applicationName = '{{=request.application}}';
        var phylesystem_config_url = '{{=phylesystem_config_url or "URL_NOT_SPECIFIED"}}';

        /* N.B. These methods are needed to manage tree collections from any page. */
        var findAllTreeCollections_url = "{{=findAllTreeCollections_url}}";
        var findAllStudies_url = "{{=findAllStudies_url}}";
        var singlePropertySearchForTrees_url = "{{=singlePropertySearchForTrees_url}}";
        var API_create_collection_POST_url = "{{=API_create_collection_POST_url}}";
        var API_load_collection_GET_url = "{{=API_load_collection_GET_url}}";
        var API_update_collection_PUT_url = "{{=API_update_collection_PUT_url}}";
        var API_remove_collection_DELETE_url = "{{=API_remove_collection_DELETE_url}}";
    </script>

    {{#------  require CSS and JS files for this page (read info in base.css) ------}}
      {{#response.files.append(URL('static','css/skeleton.css'))}}
      {{#response.files.append(URL('static','css/web2py.css'))}}
      {{#response.files.append(URL('static','css/base.css'))}}
      {{#response.files.append(URL('static','css/superfish.css'))}}
    {{response.files.append(URL('static','css/default.css'))}}
      {{#response.files.append(URL('static','js/superfish.js'))}}
      {{#response.files.append(URL('static','js/uploader/fileuploader.css'))}}
      {{#response.files.append(URL('static','jquery-ui.min.js'))}}
      {{#response.files.append(URL('static','jquery.hoverIntent.js'))}}
      {{#response.files.append(URL('static','jquery-ui-1.8.5.custom.css'))}}

    <!-- support for dialog polyfill (replace JS confirm, prompt, alert) -->
    {{response.files.append(URL('static','js/dialog-polyfill.js'))}}
    {{response.files.append(URL('static','css/dialog-polyfill.css'))}}

    <!-- js for history management -->
    {{response.files.append(URL('static','js/jquery.history.js'))}}

    <!-- js for Bootstrap components -->
    {{response.files.append(URL('static','js/bootstrap-transition.js'))}}
    {{response.files.append(URL('static','js/bootstrap-alert.js'))}}
    {{response.files.append(URL('static','js/bootstrap-modal.js'))}}
    {{response.files.append(URL('static','js/bootstrap-dropdown.js'))}}
    {{response.files.append(URL('static','js/bootstrap-scrollspy.js'))}}
    {{response.files.append(URL('static','js/bootstrap-tab.js'))}}
    {{response.files.append(URL('static','js/bootstrap-tooltip.js'))}}
    {{response.files.append(URL('static','js/bootstrap-popover.js'))}}
    {{response.files.append(URL('static','js/bootstrap-button.js'))}}
    {{response.files.append(URL('static','js/bootstrap-collapse.js'))}}
    {{response.files.append(URL('static','js/bootstrap-carousel.js'))}}
    {{response.files.append(URL('static','js/bootstrap-typeahead.js'))}}
    <!-- Knockout.js for binding JSON model to editing UI -->
    {{response.files.append(URL('static','js/knockout-2.3.0.js'))}}

    {{#------ include web2py specific js code (jquery, calendar, form stuff) ------}}
    {{include 'web2py_ajax.html'}}

  <script type="text/javascript">
  // some behavior should be on *every* page
  function toggleServerDetailsPopup() {
      var $detailsBox = $('#server-details');
      $detailsBox.toggle();
      if ($detailsBox.is(':visible')) {
          if ($('.shard-name').length === 0) {
            // populate the shard-name list via AJAX
            $.ajax({
                datatype: 'json',
                crossdomain: true,
                contenttype: "application/json; charset=utf-8",
                url: phylesystem_config_url,
                data: { },
                success: function( data, textstatus, jqxhr ) {
                    // report errors or malformed data, if any
                    //var jsonResponse = $.parseJSON(jqXHR.responseText);
                    var jsonResponse = $.parseJSON(data);
                    if ('shards' in jsonResponse) {
                        var shards = jsonResponse.shards;
                        if (shards.length === 0) {
                            $('#shard-list').after('<dd><em>No shards found for this API instance</em></dd>');
                        } else {
                            $.each(shards, function(index, shardInfo) {
                                $('#shard-list').after('<dd><strong class="shard-name">'+ shardInfo.name +'</strong> ('+ shardInfo['number of studies']  +' studies)</dd>');
                            });
                        }
                    } else {
                        $('#shard-list').after('<dd><em>Shard list failed to load!</em></dd>');
                    }
                }
            });
          }
          $('html,body').animate({scrollTop: parseInt($detailsBox.offset().top) });
      }
  }

  // Under some circumstances, we'll want to show the maintenance noticed when the page loads
  var immediateMaintenanceNotice = {{= (request.vars['maintenance_notice']) and 'true' or 'false' }};
  $(document).ready(function() {
      if (immediateMaintenanceNotice) {
        showMaintenancePopup();
      }
  });
  function showMaintenancePopup() {
      // show details in a popup (already bound)
      $('#maintenance-notice').modal('show');
  }

  // Open a new window for bug reports and other feedback
  function showFeedbackWindow() {
      // ASSUMES that synth-tree viewer is on the same domain!
      var fbUrl = window.location.protocol + "//" + window.location.hostname
          + (window.location.port ? ':' + window.location.port: '')
          + "/opentree/feedback?parentWindowURL="+ escape(window.location.href);
      var fbWindow = window.open(fbUrl, 'feedback');
      if (fbWindow) {
          fbWindow.focus();
      } else {
          alert("Couldn't open a new window. Are you using a popup blocker?");
          return false;
      };
      return false;
  }


  // Fetch the current user information for general use
  var userLogin = "{{= get_user_login() }}";
  var userLoginASCII = "{{= get_user_login().encode('ascii','ignore') }}";
  var userDisplayName = "{{= get_user_display_name() }}";
  var userEmail = '{{= auth.user and auth.user.email or 'ANONYMOUS' }}';
  var userAuthToken = '{{= auth.user and auth.user.github_auth_token or 'ANONYMOUS'}}';

  /* Manage depth (z-index) of "stacked" Bootstrap modals. First, establish a
   * "floor" z-index for the first modal that appears, and a step (interval)
   * between modals.
   */
  var modalFloor = 1000;
  var modalStep = 100;
  // keep track of each modal's depth
  var modalStack = [ ];

  function getHighestModalDepth() {
      if (modalStack.length === 0) {
          return modalFloor;
      } else {
          return Math.max.apply(Math, modalStack);
      }
  }

  jQuery(document).ready(function(){

    // delegate shared modal stacking, based on Bootstrap classes
    $('body').on('show', '.modal', function (evt) {
        if (evt.target !== this) {
            // ignore $().tab('show') events!
            return;
        }
        var $modal = $(this);
        if ($modal.is(':visible')) {
            // ignore redundant 'show' events if it's already showing
            return;
        }
        var highestSoFar = getHighestModalDepth();
        newModalDepth = highestSoFar + modalStep;
        modalStack.push(newModalDepth);
        // set my elements accordingly!
        $modal.css('z-index', newModalDepth);
        // NOTE: Its backdrop is not yet in the DOM, but will be very shortly
        var startTime = new Date().getTime();
        var stopTime = startTime + 1000;
        var intervalID = setInterval(
            function() {
                var $newBackdrop = $('.modal-backdrop').not('[style*=z-index]').eq(0);
                if ($newBackdrop.length === 0) {
                    console.error("> NO new backdrops found...");
                } else {
                    $newBackdrop.css('z-index', newModalDepth - 10);
                    clearInterval(intervalID);
                }
                // self-destruct after 1 second in any case
                var rightNow = new Date().getTime();
                if (rightNow > stopTime) {
                    console.warn("KILLING interval "+ intervalID);
                    clearInterval(intervalID);
                }
            },
            50  // runs 20 times/sec until it finds its backdrop or dies
        );

        // toggle behavior for dev-site banner
        $('.ribbon-banner, .ribbon-banner-details').hover(
            function() {
                $('.ribbon-banner-details').show();
            },
            function() {
                $('.ribbon-banner-details').hide();
            }
        );
    });
    $('body').on('hidden', '.modal', function (evt) {
        if (evt.target !== this) {
            // ignore $().tab('hide') events!
            return;
        }
        var $modal = $(this);
        var modalDepth = Number($modal.css('z-index'));
        if (isNaN(modalDepth)) {
            console.error("NO $modal depth found, just this: "+ modalDepth);
        } else {
            // remove my depth from the stack
            removeFromArray( modalDepth, modalStack );
        }
    });

    {{ if 'auth' in globals(): }}
      // add marker classes to final nav link (for logged-in user)
      var $authNavbar = jQuery('ul#auth-navbar');
      var $authMenuLink = $authNavbar.find('ul.dropdown-menu li:has(a)');
      if (($authMenuLink.length === 1) && ($authMenuLink.text().indexOf('Login') !== -1)) {
        // there's just one menu item, the Login link; make this a clickable top-level nav item
        $authNavbar.empty().append( $authMenuLink );
      } else {
        // it has multiple menu items; make it a proper (Bootstrap) dropdown menu
        var $menuTrigger = jQuery('ul#auth-navbar > li:last-child > a');
        $menuTrigger.attr({
            'class':'dropdown-toggle',
            'data-toggle': 'dropdown'
        });
        // add menu items for user profile and collections(?)
        var $menu = $menuTrigger.next('ul.dropdown-menu');
        // REMINDER: these items will appear in reverse order!
        $menu.prepend('<li><a href="/curator/profile" rel="nofollow">My curator profile</a><li>');
        $menu.prepend('<li><a href="/curator/profile#collections" rel="nofollow">My collections</a><li>');
      }

      // tweak validation errors to show proper Bootstrap classes
      jQuery('div.error').addClass('alert').addClass('alert-error');
    {{ pass }}

  });
  </script>

    {{ # TODO: consider the simpler block used in 'opentree/webapp'
    #using sidebars need to know what sidebar you want to use
    #prior of using it, because of static width size of content, you can use
    #left_sidebar, right_sidebar, both or none (False left and right)
    left_sidebar_enabled = globals().get('left_sidebar_enabled',False)
    right_sidebar_enabled = globals().get('right_sidebar_enabled',False)
    if left_sidebar_enabled and right_sidebar_enabled: width_content='63%'
    elif left_sidebar_enabled != right_sidebar_enabled: width_content='740px'
    else: width_content='100%'
    if left_sidebar_enabled: left_sidebar_style = 'style="display: block;"'
    else: left_sidebar_style = 'style="display: none;"'
    if right_sidebar_enabled: right_sidebar_style = 'style="display: block;"'
    else: right_sidebar_style = 'style="display: none;"'
    style_content = 'style="width: %s"' % width_content
    middle_columns = {0:'span12',1:'span9',2:'span6'}[
     (left_sidebar_enabled and 1 or 0)+(right_sidebar_enabled and 1 or 0)]
    }}

    <!-- Fav and touch icons (TODO: add these files to site root!)
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-57-precomposed.png">
    -->
                                   <link rel="shortcut icon" href="/favicon.ico">
  </head>

  <!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
  <!--[if lt IE 7 ]> <body class="ie6"> <![endif]-->
  <!--[if IE 7 ]>    <body class="ie7"> <![endif]-->
  <!--[if IE 8 ]>    <body class="ie8"> <![endif]-->
  <!--[if IE 9 ]>    <body class="ie9"> <![endif]-->
  <!--[if (gt IE 9)|!(IE)]><!--> <body> <!--<![endif]-->

{{ if get_domain_banner_text(request): }}
  <div class="ribbon-banner">{{= get_domain_banner_text(request) }}</div>
  <p class="ribbon-banner-details">{{= XML(get_domain_banner_hovertext(request)) }}</p>
{{ pass }}
  <div class="navbar navbar-inverse navbar-static-top">
    <div class="navbar-inner">
      <div class="container">

        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>

        <a class="brand" href="/opentree" style="font-weight: 400; color: #bbb; padding-right: 10px;">
            <img style="margin: -12px 4px -8px -2px;" src="/opentree/static/images/mini-opentree-logo.png">
            Open Tree of Life
        </a>

        <div class="nav-collapse collapse">
{{#----- THIS DOESN'T QUITE WORK with Bootstrap menus:   =MENU(response.menu, _class='nav', mobile=request.user_agent().is_mobile) ----}}
            <!-- TODO: replace this STATIC HTML with proper dynamic menus! -->
            <ul class="nav">
                <li class="Xweb2py-menu-first"><a href="/curator">Curator Home</a></li><!-- personal dashboard or welcome page -->
                <!--
                <li><a href="/curator/default/quickstart">Instructions</a></li>
                -->
                <li class="dropdown">
                    <a href="/curator" class="dropdown-toggle" data-toggle="dropdown">Studies  <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/curator">Browse all studies</a></li><!-- TODO: point to /curator/study once we have a full list -->
                        <li><a href="/curator/study/create">Add new study</a></li>
                        <li><a href="/curator/study/create">Import from TreeBASE</a></li><!-- just an alias, to encourage imports -->
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="/curator#TODO" class="dropdown-toggle" data-toggle="dropdown">Tree collections  <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/curator/profile#collections">Manage my collections</a></li>
                        <li><a href="/curator/collections">Browse all collections</a></li>
                        <li><a href="#" onclick="createNewTreeCollection(); return false;">Add new collection</a></li>
                    </ul>
                </li>
                <!--
                <li class="dropdown">
                    <a href="/curator/stree" class="dropdown-toggle" data-toggle="dropdown">Source Trees  <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/curator/stree">Browse all source trees</a></li><- - because link above is not clickable - ->
                        <li><a href="/curator/stree/otus_within">Taxon search</a></li>
                    </ul>
                </li>
                <li><a href="http://dev.opentreeoflife.org/opentree">Open Tree Browser</a></li>
                -->
                <li><a href="/curator/tnrs/">Name Resolution (TNRS)</a></li><!-- a handy batch TNRS tool! -->
            </ul>
              {{ if 'auth' in globals(): }}
            <ul id="auth-navbar" class="nav pull-right">
                {{#-- this creates an LI.dropdown > A structure --}}
                {{= auth.navbar(separators=(' ',' | ',''), mode="dropdown", user_identifier=lambda x: get_user_display_name())}}
            </ul>
              {{ pass }}
        </div><!-- /.nav-collapse.collapse -->

      </div>
    </div>
  </div><!-- /.navbar -->

  <!--<div id="wrapper">-->

<!--
    <div class="topbar">
      <div class="container">
        <div class="sixteen columns">
          <div id="navbar">{{='auth' in globals() and auth.navbar(separators=(' ',' | ',''))}}</div>
          {{is_mobile=request.user_agent().is_mobile}}
          <div id="menu">{{=MENU(response.menu, _class='mobile-menu' if is_mobile else 'sf-menu',mobile=is_mobile)}}
          </div>
        </div>
      </div>
    </div>
--><!-- topbar -->

    <div class="flash alert" style="display: none;"
        >{{ # NOTE that this DIV must be *completely* empty to stay hidden on page load
            if response.flash: }}
        <span class="message">{{=response.flash}}</span>
         {{ pass }}</div> <!-- notification div (adapted for Bootstrap) -->

    <!--
    <div class="header">
      <div class="container">
        <div class="sixteen columns">
          <h2 style="margin:0; padding: .25em;
		     background-color:#F0F0F0; color:SteelBlue;">
          {{=A(response.title or request.application, _href=URL('default','index'))}}{{if response.subtitle:}}: {{=response.subtitle}}{{pass}}
          </h2>
        </div>
      </div>
    </div>--><!-- /.header -->

    <!--<div class="main">-->
    <div class="container">
    <section id="main" class="main row">
        {{if left_sidebar_enabled:}}
        <div class="Xfour Xcolumns span3 left-sidebar">
          {{block left_sidebar}}
          <h3>Left Sidebar</h3>
          <p></p>
          {{end}}
        </div>
        {{pass}}

        <div class="{{=middle_columns}} Xcolumns Xcenter">
          <!--<div style="margin:0 1em 0 1em;">-->
          {{ if response.title: }}
          <h1 id="main-title">
              <span style="color: #ccc;">{{=response.title or request.application}}{{if response.subtitle:}}:{{pass}}</span>
              {{if response.subtitle:}}{{=response.subtitle}}{{pass}}
          </h1>
          {{ pass }}
          {{block center}}
          {{include}}
          {{end}}
          <!--</div>-->
        </div>

        {{if right_sidebar_enabled:}}
        <div class="Xfour Xcolumns span3">
          {{block right_sidebar}}
          <h3>Right Sidebar</h3>
          <p></p>
          {{end}}
          <p></p>
        {{pass}}
          <a class="btn Xbtn-small btn-info curation-feedback-btn" href="#"
             onclick="showFeedbackWindow(); return false;">Submit a bug report or suggestion</a>
        </div>
    </section><!-- #main.main row -->
    </div><!-- .container -->
      <!--</div>--><!-- main -->

<!-- Footer ================================================== -->
<footer class="footer" id="footer">
  <div class="container">
    <div class="footer-content">
        {{block footer}} <!-- this is default footer -->
        <div id="fundedBy" class="pull-left">
            {{=T('Open Tree of Life is funded by NSF (AVAToL)')}}
            </div>
        <div id="poweredBy" class="pull-right">
            <a href="#" onclick="toggleServerDetailsPopup(); return false;">Show/hide server details</a>
            &bull;
            <a href="{{ = URL('opentree', 'about','licenses') }}" rel="jslicense">License information</a>
            &bull;
            {{=T('Powered by')}}
            <a href="http://www.web2py.com/" target="_blank" >web2py</a>
        </div>
        <div id="server-details">
            Configuration for the <strong>{{= request.application }}</strong> web2py app:
            <dl>
               <dt id="shard-list">phylesystem shard(s):</dt>
            {{ # N.B. This list will be populated by AJAX only when shown }}
               <dt id="deployed-branch">deployed branch of opentree webapps:</dt>
                   <dd><strong class="setting-name">{{= get_currently_deployed_opentree_branch(request) }}
                   </strong></dd>

            {{ # format non-sensitive config data for display
               conf = get_conf(request)
               for sec in conf.sections(): }}
               <dt>{{= sec }}</dt>
                   {{ for itm in conf.items(sec): }}
                   <dd><strong class="setting-name">{{= itm[0] }}</strong>: {{= itm[1] }}</dd>
                   {{ pass }}
            {{ pass }}
            </dl>
        </div>
        {{end}}
    </div>
  </div>
</footer>

    <!--[if lt IE 7 ]>
	<script src="{{=URL('static','js/dd_belatedpng.js')}}"></script>
	<script> DD_belatedPNG.fix('img, .png_bg'); //fix any <img> or .png_bg background-images </script>
	<![endif]-->

    <!-- asynchronous google analytics: mathiasbynens.be/notes/async-analytics-snippet
	 change the UA-XXXXX-X to be your site's ID -->
    <!--
	   <script>
	     var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
	     (function(d, t) {
	     var g = d.createElement(t),
	     s = d.getElementsByTagName(t)[0];
	     g.async = true;
	     g.src = '//www.google-analytics.com/ga.js';
	     s.parentNode.insertBefore(g, s);
	     })(document, 'script');
	   </script>
	   -->
    <div id="modal-screen" class="modal hide Xfade" data-keyboard="false" data-backdrop="static">
        <div id="modal-screen-message"></div>
        <div id="modal-screen-busy-bar" class="progress progress-striped active" style="margin: 2px;">
          <div class="bar" style="width: 100%;"></div>
        </div>
    </div>

  <!-- hidden template for the tree-collection-viewer (editor) -->
  <div class="modal hide fade" id="tree-collection-viewer"
       Xtabindex="-1" Xrole="dialog" Xaria-labelledby="myModalLabel" Xaria-hidden="true">
   <!-- TODO: KO binding here to 'collection' (as $data below) -->
    <div class="modal-header" style="padding-bottom: 0;">
      <a class="close" onclick="$('#tree-collection-viewer').modal('hide'); return false;">Ã—</a>
      <h3 id='dialog-heading'>
            <span style="color: #999;">Tree collection</span>
           <!-- ko if: userIsEditingCollection($data) -->
            <input type="text" style="font-size: inherit; vertical-align: baseline; color: #000;
                                      font-weight: bold; width: 50%; margin-bottom: 0px;"
                   data-bind="value: $data.data['name'],
                              valueUpdate: ['afterkeydown', 'input'],
                              event: { keyup: updateNewCollectionID, change: updateNewCollectionID }
                              "
            />
           <!-- /ko -->
           <!-- ko if: !userIsEditingCollection($data) -->
             <span data-bind="html: $data.data['name'] || 'Untitled'"></span>
           <!-- /ko -->
      </h3>
      <div style="color: #999; position: relative;">
        <p style="position: absolute; width: 170px; text-align: right;">
            Collection ID (direct link):
        </p>
        <p style="margin-left: 180px;">
            <a id="collection-id-display"
               data-bind="text: getCollectionIDFromURL($data.data.url),
                          attr: { href: getCollectionDirectURL($data) }">&nbsp;</a>
        </p>
      </div>
    </div>
    <div class="modal-body" style="max-height: none;">
      <div class="tab-pane active">
          <form class="form-inline"
                style="overflow: hidden; margin-bottom: 0px; margin-top: -12px; padding-top: 12px; margin-right: -6px;">
           <div class="collection-actions" style="padding-right: 8px;">
            <!-- action buttons, from right to left -->

           <!-- ko if: userIsEditingCollection($data) -->
            <!-- DELETE button (for now, this only appears in the My Collections list)
            <button data-bind="click: promptForDeleteCollectionComments,
                               visible: true"
                title="Delete this tree collection"
                class="pull-right btn btn-mini btn-danger row-controls-ghosted"
                style="margin-left: 14px;">
                Delete <i class="icon-trash icon-white"></i>
            </button>
            -->
           <!-- /ko -->

           <!-- ko if: ('external_url' in $data) -->
            <!-- HISTORY button -->
            <a data-bind="attr: { href: getCollectionHistoryURL($data) }"
               title="See full version history on GitHub"
               class="pull-right btn btn-mini row-controls-ghosted"
               style="margin-left: 4px;"
               href="#" target="_blank">
               History
               <img src="/curator/static/images/GitHub-Mark-32px.png"
                    style="width: 14px; height: 14px; padding-left: 2px; margin-top: -2px;"/>
            </a>
           <!-- /ko -->

           <!-- ko if: !userIsEditingCollection($data) -->
            <!-- SHARE button -->
            <button data-bind="click: shareCollection,
                               visible: true"
                title="Show the direct URL for this collection"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Share <i class="icon-share"></i>
            </button>

           <!-- ko if: ('external_url' in $data) -->
            <!-- DOWNLOAD button -->
            <a data-bind="attr: { href: $data['external_url'] }"
               title="Download this collection as JSON"
               class="pull-right btn btn-mini row-controls-ghosted"
               style="margin-left: 4px;"
               href="#" target="_blank">
               Download <i class="icon-download"></i>
            </a>
           <!-- /ko -->

            <!-- SYNTHESIS REPORT button (TODO?)
            <button Xdata-bind="click: TODO-follow-this-collection,
                                visible: true"
                title="(PROPOSED) View synthesis report for this collection"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px; opacity: 0.5;">
                <i class="icon-list-alt"></i>
            </button>
            -->

            <!-- DUPLICATE button -->
            <button data-bind="click: copyCollection,
                                visible: true,
                                attr: {'title': userIsLoggedIn() ? 'Copy this collection (you will own the copy)' : 'Copy this collection (requires login)'}"
                title=""
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Save a copy <i class="icon-repeat"></i>
            </button>
           <!-- /ko -->

            <!-- EDIT button -->
            <button data-bind="click: editCollection,
                               visible: !(userIsEditingCollection($data)),
                               attr: {'title': userIsLoggedIn() ? 'Edit collection, including add/remove trees' : 'Edit collection (requires login)'}"
                title=""
                class="pull-right btn btn-info btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Edit <i class="icon-edit icon-white"></i>
            </button>
            <button data-bind="click: cancelChangesToCollection,
                               visible: userIsEditingCollection($data)"
                title="Cancel your changes to this collection"
                class="pull-right btn btn-warning btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Cancel
            </button>
            <button data-bind="click: promptForSaveCollectionComments,
                               visible: userIsEditingCollection($data)"
                title="Save your changes to this collection"
                class="pull-right btn btn-info btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Save Changes
            </button>
            <button data-bind="click: updateCollectionTrees,
                               visible: userIsEditingCollection($data)"
                title="Use latest tree labels, detect removed trees"
                class="pull-right btn btn-mini row-controls-ghosted"
                style="margin-left: 4px;">
                Update trees <i class="icon-refresh"></i>
            </button>

           </div>

            <!-- editable collection properties here -->

                <label>Description</label>
              <!-- ko if: userIsEditingCollection($data) -->
                <input type="text"
                    class="input-xlarge" style="width: 500px; margin-bottom: 2px;"
                    placeholder="Describe this collection's focus or purpose"
                    data-bind="value: $data.data['description'],
                               valueUpdate: ['afterkeydown', 'input']
                               "
                ></input>
              <!-- /ko -->
              <!-- ko if: !userIsEditingCollection($data) -->
                <div style="background-color: #eee; width: 500px;
                            margin: 0px 0px 2px -1px;
                            border-radius: 4px; padding: 5px 8px;"
                     data-bind="html: $data.data['description'] || '&nbsp;'"
                ></div>
              <!-- /ko -->

                <label style="clear: left; margin-top: 6px;">Created by </label>
                <strong><a href="https://github.com/jimallman" target="_blank"
                           data-bind="text: $data.data.creator['name'],
                                      attr: {
                                        href: ('https://github.com/'+ $data.data.creator['login'])
                                      }
                                      "
                        >&nbsp;</a></strong>, with
              <!-- list collaborators (links) in a popup -->
              <div id="collection-collab-toggle" Xclass="btn-group"
                   style="display: inline-block; position: relative;">
                <strong id="collection-collab-toggle" class="dropdown-toggle"
                        style="cursor: pointer;"
                        data-toggle="dropdown">
                    <span data-bind="text: $data.data.contributors.length">0</span>
                    collaborator<span data-bind="if: $data.data.contributors.length != 1">s</span>
                   <span class="caret" style="vertical-align: middle;"></span>
                </strong>
                <ul id="tree-collection-contributors" class="dropdown-menu"
                    data-bind="foreach: { data: $data.data.contributors, as: 'contributor' }">
                    <li>
                        <a target="_blank"
                           data-bind="text: contributor['name'],
                                      attr: {
                                        href: ('https://github.com/'+ contributor['login'])
                                      }
                                      "
                        >&nbsp;</a>
                    </li>
                </ul>
              </div>

                <!-- let's keep it simple for now
                <div class="btn-group" style="margin-left: 80px; margin-top: 6px;">
                  <button id="show-included-trees-button" class="btn btn-small active" onclick="alert('COMING SOON'); return false;">&nbsp; Show only included trees &nbsp;</button>
                  <button id="show-all-trees-button" class="btn btn-small" onclick="alert('COMING SOON'); return false;">&nbsp; Show all tree decisions &nbsp;</button>
                </div>
                -->
              <div id="tree-list-holder"
                   style="overflow: auto;">
      <!-- ko if: ('decisions' in $data.data) && ($data.data.decisions.length > 0) -->
                <table id="tree-collection-decision-holder"
                       class="table table-condensed table-hover"
                       style="margin-bottom: 2px; position: relative;"
                       data-bind="visible: true"><!-- TODO: hide if no trees found -->
                  <thead>
                    <tr>
                        <th width="76">Rank</th><!-- ranking -->
                        <th width="*">
                          <!-- ko if: userIsEditingCollection($data) -->
                            Tree
                          <!-- /ko -->
                          <!-- ko if: !userIsEditingCollection($data) -->
                            Tree (click to view, mouse-over for description)
                          <!-- /ko -->
                        </th>
                    </tr>
                  </thead>
                  <tbody id="tree-collection-decisions"
                         data-bind="foreach: { data: $data.data.decisions }">
                      <tr data-bind="attr: { class: (userIsEditingCollection($parent) && $data['status'] == 'REMOVED') ?
                                                      'single-tree-row error' :
                                                      (userIsEditingCollection($parent) && $data['status'] == 'RENAMED' ?
                                                        'single-tree-row warning' :
                                                        'single-tree-row-'+ $data['status'] )
                                            }">
                          <td>
                          <!-- ko if: userIsEditingCollection($parent) -->
                            <input type="text"
                                   data-bind="value: $data['rank'],
                                              valueUpdate: ['afterkeydown', 'input'],
                                              event: {
                        keyup: function() {showCollectionMoveUI($data, $element, $parent)},
                        change: function() {showCollectionMoveUI($data, $element, $parent)}
                                              }"
                                   style="color: #999; width: 24px;
                                          margin-left: -4px; text-align: right;"
                                   value=""
                             />&nbsp;
                           <!-- SORTING widgets -->

                           <!-- ko if: $index() === 0 -->
                            <a style="opacity: 0.5;"
                               href="#"
                               onclick="return false;"
                               class="icon-chevron-up">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $index() > 0 -->
                            <a data-bind="click: function() {moveInTreeCollection($data, $parent, 'UP'); return false;}"
                               href="#"
                               title="Move this tree up in the list"
                               class="icon-chevron-up">
                            </a>
                           <!-- /ko -->

                           <!-- ko if: $index() === ($parent.data.decisions.length-1) -->
                            <a style="opacity: 0.5;"
                               href="#"
                               onclick="return false;"
                               class="icon-chevron-down">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $index() < ($parent.data.decisions.length-1) -->
                            <a data-bind="click: function() {moveInTreeCollection($data, $parent, 'DOWN'); return false;}"
                               href="#"
                               title="Move this tree down in the list"
                               class="icon-chevron-down">
                            </a>
                           <!-- /ko -->
                           <!-- ko if: $data['status'] == 'REMOVED' -->
                             <div class="tree-status-marker text-error">REMOVED</div>
                           <!-- /ko -->
                           <!-- ko if: $data['status'] == 'RENAMED' -->
                             <div class="tree-status-marker text-warning">RENAMED</div>
                           <!-- /ko -->

                          <!-- /ko --><!-- END of editing widgets -->
                          <!-- ko if: !userIsEditingCollection($parent) -->
                          <div data-bind="text: $data['rank']"
                               style="text-align: right; width: 27px; margin-top: 5px;">XX</div>
                          <!-- /ko -->

                          </td>
                          <td>
<!--
                              <button Xdata-bind="click: TODO-follow-this-collection,
                                                  visible: true"
                                  title="Edit name and description (become a collaborator)"
                                  class="pull-right btn btn-mini row-controls-ghosted"
                                  style="margin-left: 4px;">
                                  <i class="icon-edit"></i>
                              </button>
-->
                            <!-- ko if: userIsEditingCollection($parent) -->
                              <button data-bind="click: function() {removeTreeFromCollection($data, $parent); return false;}"
                                      title="Remove this tree from the collection"
                                      class="pull-right btn btn-mini btn-danger row-controls-ghosted"
                                      style="margin-left: 4px;">
                                  <i class="icon-trash icon-white"></i>
                              </button>
                              <a data-bind="html: name,
                                            attr: { href: getTreeViewURL($data) }"
                                 title="View this tree in a new window"
                                 href="#" target="_blank"><!--NAME--></a>
                             <!-- this is no longer editable
                              <input type="text"
                                     class="input-large"
                                     style="width: 320px; margin-right: 10px; margin-bottom: 2px;"
                                     placeholder="Name this tree"
                                     data-bind="value: name,
                                                valueUpdate: ['afterkeydown', 'input']
                                                "
                              >
                              </input>
                              -->
                              <br/>
                              <textarea data-bind="value: comments"
                                        style="width: 380px; color: #333; margin-bottom: 4px; height: 2em;"
                                        placeholder="Describe your reasons for including this tree">
                                <!--COMMENTS--></textarea>
                            <!-- /ko -->
                            <!-- ko if: !userIsEditingCollection($parent) -->
                              <a data-bind="html: name,
                                            attr: { href: getTreeViewURL($data), title: comments || '(no description provided)' }"
                                 href="#" target="_blank"><!--NAME--></a>
                            <!-- /ko -->
                          </td>
                      </tr>
                  </tbody>
                </table>
      <!-- /ko -->
      <!-- ko if: !('decisions' in $data.data) || ($data.data.decisions.length === 0) -->
                <div class="empty-list-prompt" style="margin-bottom: 4px;">
              <!-- ko if: userIsEditingCollection($data) -->
                    This collection is empty! Add trees using the buttons below, or
                    by visiting trees in the curation app.
              <!-- /ko -->
              <!-- ko if: !userIsEditingCollection($data) -->
                    This collection is empty! Add trees by clicking Edit above, or
                    by visiting trees in the curation app.
              <!-- /ko -->
                </div>
      <!-- /ko -->
              </div><!-- /#tree-list-holder -->

          <!-- ko if: userIsEditingCollection($data) -->
            <!-- TODO: Put add-collection widgets! -->
            <div xclass="form-actions" style="margin-top: 0px; margin-bottom: 0.25em;">
              <button id="new-collection-tree-start" type="submit"
                      class="btn btn-info Xbtn-info-disabled"
                      onclick="return false;"
              ><span data-bind="text: ($data.data.decisions.length > 0) ? 'Add another tree' : 'Add a tree to this collection'">ADD TREE</span>
                    &nbsp;<i class="icon-plus Xicon-upload icon-white"></i>
              </button>
              <button id="new-collection-tree-cancel" type="submit"
                      style="display: none;" class="btn">Cancel
              </button>
            </div>
            <div id="new-collection-tree-by-lookup"
                 class="new-collection-tree-options" style="display: none; padding-left: 12px;">
                <div class="dropup" style="position: relative; margin-left: 146px;">
                    <ul id="study-lookup-results" class="dropdown-menu" role="menu">
                        ...
                    </ul>
                </div>
                <label>&hellip; by matching a study</label>
                <!-- "active" wiget for study lookup -->
                <i class="icon-search study-lookup-active" style="position: absolute; margin: 8px 0 0 7px; pointer-events: none;"></i>
                <input type="text" name="study-lookup"
                    class="input-xlarge study-lookup-active" style="margin-bottom: 2px; padding-left: 25px;"
                    placeholder="Enter its title, DOI, reference, tag, ID..."
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                ></input>
                <!-- hidden field to store chosen ID -->
                <input type="hidden" name="study-lookup-id"
                       data-bind="value: '',
                                  event: { change: updateNewCollTreeUI }
                                 "></input>
                <!-- "passive" wiget once study is chosen -->
                <a class="btn btn-small study-lookup-passive" style="display: none; margin: 3px 0 3px;"
                   onclick="resetStudyLookup(); return false;">
                    <i class="icon-search"></i>
                </a>
                <a id="study-lookup-indicator" class="study-lookup-passive"
                   style="font-weight: bold; display: none;"
                   title="" href="" target="_blank">...</a>
                <br />

                <label style="padding-left: 4em;">and one of its trees</label>
                <select name="tree-lookup"
                    class="input-xlarge" style="margin-bottom: 2px;"
                    disabled="disabled"
                    placeholder="Enter its name, ID, ingroup clade..."
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                >
                    <option disabled="disabled" value="">Find the study above first</option>
                </select>
                <button class="btn btn-info"
                        data-bind="click: function() {addTreeToCollection($data, 'FROM_LOOKUPS'); return false;}"
                >
                      <i class="icon-plus icon-white"></i>
                </button>
            </div>
            <div id="new-collection-tree-by-url"
                 class="new-collection-tree-options" style="display: none; padding-left: 12px;">
                <label>&hellip; by URL</label>
                <input type="text"  name="tree-url"
                    class="input-xlarge" style="width: 385px; margin-bottom: 2px;"
                    placeholder=".../curator/study/view/pg_2826/?tab=trees&tree=tree6573"
                    data-bind="value: '',
                               valueUpdate: ['afterkeydown', 'input'],
                               event: { keyup: updateNewCollTreeUI, change: updateNewCollTreeUI }
                               "
                ></input>
                <button class="btn btn-info"
                        data-bind="click: function() {addTreeToCollection($data, 'FROM_URL'); return false;}"
                >
                      <i class="icon-plus icon-white"></i>
                </button>
            </div>
          <!-- /ko -->

            </form>
          </div>
    </div><!-- end of .modal-body -->
    <div class="modal-footer" style="padding: 5px;"><!-- nothing here! --></div>
  </div><!-- end of #tree-collection-viewer.modal- -->

<!-- hidden template for gathering comments when saving a tree collection -->
<div class="modal hide fade modal-save-comments" id="save-collection-comments-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Add a comment for these changes
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Add a brief description of the work you've done.
            This will appear in this collection's history on GitHub.
        </p>
        <input type="text" id="save-collection-comment-first-line" class="input-block-level" maxlength="50" placeholder="Add a one-line summary (50 chars max)"/>
        <textarea id="save-collection-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
        <p id="save-collection-noemail-warning" class="help-box">
          <strong>Warning</strong>: You have not provided a public email address
            in your GitHub profile. You can still edit data but this activity
            will not be shown on your GitHub or OpenTree profiles (and cannot be
            linked back at a later date). See
            <a href="https://github.com/OpenTreeOfLife/opentree/wiki/OpenTree-user-accounts-and-GitHub" target="_blank">
            the help page</a> for details.
        </p>
    </div>
    <div class="modal-footer">
      <button id="save-collection-comments-submit"
              class="btn btn-info pull-right" style="margin-left: 20px;"
              onclick="return false;">Save Collection</button>
      <a id="save-collection-comments-cancel" data-dismiss="modal" class="btn" >Cancel</a>
    </div>
</div>

<!-- hidden template for gathering comments when deleting a tree collection -->
<div class="modal hide fade modal-save-comments" id="delete-collection-comments-popup" style="display: none;">
    <div class="modal-header">
      <a data-dismiss="modal" class="close">Ã—</a>
      <h3 id='dialog-heading'>
         Are you sure you want to do this?
      </h3>
    </div>
    <div class="modal-body">
        <p>
            Add a brief description of why you're deleting this collection.
            (This will be saved in the main repository.)
        </p>
        <input type="text" id="delete-collection-comment-first-line" class="input-block-level" maxlength="50" placeholder="Add a one-line summary (50 chars max)"/>
        <textarea id="delete-collection-comment-more-lines" class="input-block-level" rows="4" placeholder="Add more details and background as needed."></textarea>
    </div>
    <div class="modal-footer">
      <button id="delete-collection-comments-submit"
              class="btn btn-danger pull-right" style="margin-left: 20px;"
              onclick="return false;">Delete Collection</button>
      <a id="delete-collection-comments-cancel" data-dismiss="modal" class="btn" >Cancel</a>
    </div>
</div>

{{ if ('maintenance_info' in locals()) and maintenance_info.get('maintenance_notice', None):
   # N.b. Check to make sure it's in the view-dict, or error pages etc. will fail }}
    <div id="maintenance-notice" class="modal hide fade"
         Xtabindex="-1" Xrole="dialog" Xaria-labelledby="myModalLabel" Xaria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="myModalLabel">Maintenance notice</h3>
      </div>
      <div class="modal-body">
        {{= ('maintenance_info' in locals()) and maintenance_info['maintenance_notice'] }}
      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>
{{ pass }}

<!-- cookie consent for first-time visitors -->
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script type="text/javascript">
    function showCurrentCookieStatus() {
        // TODO: Vary this message based on latest user decision?
        return "This website uses cookies to maintain user sessions (essential) and to anonymously track how people use the website (optional).";
    }
    function forceDeleteTrackingCookies() {
      // Clear any existing tracking cookies from Google Analytics!
      ///window['ga-disable-UA-143548106-1'] = true;
      // N.B. `document.cookie` is a smart setter, won't affect other cookies
      document.cookie = "_ga=;max-age=-1;path=/;domain=.opentreeoflife.org";
      document.cookie = "_gid=;max-age=-1;path=/;domain=.opentreeoflife.org";
      // sometimes these cookies are set to third-level domains! why?!
      document.cookie = "_ga=;max-age=-1;path=/;domain=.devtree.opentreeoflife.org";
      document.cookie = "_gid=;max-age=-1;path=/;domain=.devtree.opentreeoflife.org";
      document.cookie = "_ga=;max-age=-1;path=/;domain=.tree.opentreeoflife.org";
      document.cookie = "_gid=;max-age=-1;path=/;domain=.tree.opentreeoflife.org";
    }
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#cc0000",
          "text": "#ffffff"
        },
        "button": {
          "background": "#ffffff"
        }
      },
      "theme": "classic",
      "position": "bottom",
      "type": "opt-out",
      "onStatusChange": function(status) {
          if (this.hasConsented()) {
              // anything to do here?
          } else {
              forceDeleteTrackingCookies();
          }
      },
      "onInitialise": function(status) {
          if (status === 'deny') {
            forceDeleteTrackingCookies();
          }
      },
      "content": {
        "message": showCurrentCookieStatus(),
        // "dismiss": "OK",
        "deny": "Refuse tracking",
        "href": "/about/privacy-policy"
      }
    });

    /* Basic emulation of JS `alert`, `confirm`, `prompt`
     * using Google's dialog-polyfill
     */
    var dialogSingleton; // one is enough for our needs
    function getEmptyDialog() {
        if (dialogSingleton) {
            dialogSingleton.returnValue = null;
            $(dialogSingleton).empty(); // clear any prior contents
        } else {
            dialogSingleton = document.createElement('dialog');
            $('body').append(dialogSingleton);
            dialogPolyfill.registerDialog(dialogSingleton);
        }
        return dialogSingleton;
    }
    async function asyncAlert(msg) {
      return new Promise((resolve, reject) => {
        // no return value
        var dialog = getEmptyDialog();
        $(dialog).addClass('fixed')
                 .html('<p>'+ msg +'</p>');
        var $form = $('<form method="dialog"></form>');
        var $OKBtn = $('<input type="submit" value="OK" />').click(function(evt) {
            resolve(true);  // always true
            dialog.close();
        }) ;
        $form.append($OKBtn);
        $(dialog).append($form);
        dialog.addEventListener('cancel', function(evt) {
            // capture ESC key closing window; return true regardless
            resolve(true);
        });
        dialog.showModal();
      });
    }
    async function asyncConfirm(question) {
      return new Promise((resolve, reject) => {
        var dialog = getEmptyDialog();
        dialog.addEventListener('close', function(evt) {
            return dialog.returnValue || null;
        });
        $(dialog).addClass('fixed')
                 .html('<p>'+ question +'</p>');
        var $form = $('<form method="dialog"></form>');
        var $OKBtn = $('<input type="submit" value="OK" />').click(function(evt) {
            resolve(true);
            dialog.close();
        }) ;
        var $cancelBtn = $('<input type="submit" value="Cancel" />').click(function(evt) {
            resolve(false);
            dialog.close();
        }) ;
        $form.append($OKBtn);
        $form.append($cancelBtn);
        $(dialog).append($form);
        dialog.addEventListener('cancel', function(evt) {
            // capture ESC key closing window
            resolve(false);
        });
        dialog.showModal();
      });
    }
    async function asyncPrompt(question, defaultValue) {
      return new Promise((resolve, reject) => {
        if (!defaultValue) defaultValue = "";
        var userInput = null;
        var promptCanceled = false;
        var dialog = getEmptyDialog();
        dialog.addEventListener('close', function(evt) {
            return dialog.returnValue || null;
        });
        $(dialog).addClass('fixed')
                 .html('<p>'+ question +'</p>');
        var $form = $('<form method="dialog"></form>');
        var $inputField = $('<input type="text" name="userInput" placeholder="'+ defaultValue +'" />');
        var $OKBtn = $('<input type="submit" value="OK" />').click(function(evt) {
            resolve( $inputField.val() );
            dialog.close();
        }) ;
        var $cancelBtn = $('<input type="submit" value="Cancel" />').click(function(evt) {
            resolve(null);  // mimic window.prompt response
            dialog.close();
        }) ;
        $form.append($inputField);
        $form.append($OKBtn);
        $form.append($cancelBtn);
        $(dialog).append($form);
        dialog.addEventListener('cancel', function(evt) {
            // capture ESC key closing window
            resolve(null);  // mimic window.prompt response
        });
        dialog.showModal();
      });
    }

async function testAlert() {
    // use `await` here
    console.log('STARTING testAlert...');
    var test = null;
    try {
        test = await asyncAlert('This is a test!');
    }
    catch (rejectedValue) {
        console.warn("promise rejected!", rejectedValue);
        test = "NADA";
    }
    console.log('RESPONSE to testAlert?', test);
}
async function testConfirm() {
    console.log('STARTING testConfirm...');
    var test = await asyncConfirm('This is a test!')
                .then(function(x) {
                    return x;
                })
                .catch(function(x) {
                    console.warn("promise rejected!", x);
                    return 'NADA';
                });
    console.log('RESPONSE to testConfirm:', test);
}
async function testPrompt() {
    console.log('STARTING testPrompt...');
    var test = await asyncPrompt('Favorite flavor?', 'vanilla');
    console.log('RESPONSE to testPrompt:');
    console.log(test);
}
</script>
  </body>
</html>
