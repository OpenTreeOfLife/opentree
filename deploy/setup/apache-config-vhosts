# This file derives from the file /etc/apache2/sites-available/default
# in apache2 as installed in ubuntu 12.04.
#
# Now that we're supporting both HTTP and HTTPS, this file holds only the
# settings unique to each VirtualHost, with all shared configuration included
# from 'apache-confog-shared'. See
# http://serverfault.com/questions/83669/apache2-with-ssl-do-i-have-to-copy-virtualhost-blocks
#
# This file should be periodically reviewed as apache versions advance and
#  'best practice' for virtual host configurations changes.

<VirtualHost *:80>

    ErrorLog ${APACHE_LOG_DIR}/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    # Restrict web2py admin pages to admin users on localhost (SSH tunnel)
    # TODO: Should this apply to the HTTPS VirtualHost as well?
    <Location /admin>
      Order deny,allow
      Deny from all
      Allow from 127.0.0.1
    </Location>
    <LocationMatch ^/([^/]+)/appadmin>
      Order deny,allow
      Deny from all
      Allow from 127.0.0.1
    </LocationMatch>

    # See http://stackoverflow.com/questions/13216837/install-web2py-in-virtual-hosting
    #
    # NOTE that we can only specify WSGIDaemonProcess once, so this has been
    # retained in 'apache-config-vhosts', in the first VirtualHost section. All
    # other WSGI directives are shared across both vhosts
    WSGIDaemonProcess web2py user=opentree group=opentree display-name=%{GROUP}

    # OPENTREE SHARED CONFIGURATION
    Include /etc/apache2/sites-available/opentree-config-shared

</VirtualHost>

# Adapting SSL settings (second VirtualHost) from
# /etc/apache2/sites-available/default-ssl
# in apache2 as installed in ubuntu 12.04.
#
# Note that we handle redundant configuration across vhosts by including a separate common file:
# http://serverfault.com/questions/83669/apache2-with-ssl-do-i-have-to-copy-virtualhost-blocks
 
<IfModule mod_ssl.c>
<VirtualHost *:443>

    ErrorLog ${APACHE_LOG_DIR}/ssl_error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    SSLEngine on
    SSLCertificateFile    /etc/ssl/certs/opentree/STAR_opentreeoflife_org.crt
    SSLCertificateKeyFile /etc/ssl/private/opentreeoflife.org.key

    #   SSL Engine Options:
    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>

    #   SSL Protocol Adjustments:
    BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    # OPENTREE SHARED CONFIGURATION
    Include /etc/apache2/sites-available/opentree-config-shared

</VirtualHost>
</IfModule>
